#include <cmath>
#include "include/base.h"
#include "include/spectrum-to-xyz.h"
#include "spectrum.h"
namespace colorscreen
{
namespace
{
/* from Argyll 107 bands from 300 to 830 nm in 5nm steps
   CIE 15.2-1986 Table 1.1
   Part 1: CIE Standard Illuminant A relative spectral power distribution
   This is a 2848K tungsten filament lamp (Acording to the old temperature scale)
   and 2856 according to the newer temerature scale. */

static const luminosity_t il_A[] = {
  0.930483, 1.128210, 1.357690, 1.622190, 1.925080,
  2.269800, 2.659810, 3.098610, 3.589680, 4.136480,
  4.742380, 5.410700, 6.144620, 6.947200, 7.821350,
  8.769800, 9.795100, 10.899600, 12.085300, 13.354300,
  14.708000, 16.148000, 17.675300, 19.290700, 20.995000,
  22.788300, 24.670900, 26.642500, 28.702700, 30.850800,
  33.085900, 35.406800, 37.812100, 40.300200, 42.869300,
  45.517400, 48.242300, 51.041800, 53.913200, 56.853900,
  59.861100, 62.932000, 66.063500, 69.252500, 72.495900,
  75.790300, 79.132600, 82.519300, 85.947000, 89.412400,
  92.912000, 96.442300, 100.000000, 103.582000, 107.184000,
  110.803000, 114.436000, 118.080000, 121.731000, 125.386000,
  129.043000, 132.697000, 136.346000, 139.988000, 143.618000,
  147.235000, 150.836000, 154.418000, 157.979000, 161.516000,
  165.028000, 168.510000, 171.963000, 175.383000, 178.769000,
  182.118000, 185.429000, 188.701000, 191.931000, 195.118000,
  198.261000, 201.359000, 204.409000, 207.411000, 210.365000,
  213.268000, 216.120000, 218.920000, 221.667000, 224.361000,
  227.000000, 229.585000, 232.115000, 234.589000, 237.008000,
  239.370000, 241.675000, 243.924000, 246.116000, 248.251000,
  250.329000, 252.350000, 254.314000, 256.221000, 258.071000,
  259.865000, 261.602000
};
//   Illuminant B at 5nm interval Wyszecki & Stiles Color Science, 2nd edition.  Table II(3.3.4)  pp. 759.
//   Simulated direct sunlight, obsolette.
static const luminosity_t il_B[] = {
  0.02, 0.26, 0.50, 1.45, 2.40, 4.00, 5.60, 7.60, 9.6,
  12.4, 15.2, 18.8, 22.4, 26.85, 31.3, 36.18, 41.3, 46.62,
  52.1, 57.7, 63.2, 68.37, 73.1, 77.31, 80.8, 83.44, 85.4,
  86.88, 88.3, 90.08, 92, 93.75, 95.2, 96.23, 96.5, 95.71,
  94.2, 92.37, 90.7, 89.65, 89.5, 90.43, 92.2, 94.46, 96.9,
  99.16, 101, 102.2, 102.8, 102.92, 102.6, 101.9, 101, 100.07,
  99.2, 98.44, 98, 98.08, 98.5, 99.06, 99.7, 100.36, 101,
  101.56, 102.2, 103.05, 103.9, 104.59, 105, 105.08, 104.9, 104.55,
  103.9, 102.84, 101.6, 100.38, 99.1, 97.7, 96.2, 94.6, 92.9,
  91.1, 89.4, 88, 86.9, 85.9, 85.2, 84.8, 84.7, 84.9,
  85.4, 86.1, 87.0,
};


/* From Argyll. 93 bands from 320.0 to 780.0 */
/* CIE 15.2-1986 Table 1.1 */
/* Part 1: CIE Standard Illuminant C relative spectral power distribution */
/* This is a CIE Illuminant A combined with a filter to simulate daylight. */
static const luminosity_t il_C[] = {
	0.01,   0.20,   0.40,   1.55,   2.70,   4.85,   7.00,   9.95,   12.90,  17.20, 
	21.40,  27.50,  33.00,  39.92,  47.40,  55.17,  63.30,  71.81,  80.60,  89.53,
	98.10,  105.80, 112.40, 117.75, 121.50, 123.45, 124.00, 123.60, 123.10, 123.30,
	123.80, 124.09, 123.90, 122.92, 120.70, 116.90, 112.10, 106.98, 102.30, 98.81,
	96.90,  96.78,  98.00,  99.94,  102.10, 103.95, 105.20, 105.67, 105.30, 104.11,
	102.30, 100.15, 97.80,  95.43,  93.20,  91.22,  89.70,  88.83,  88.40,  88.19,
	88.10,  88.06,  88.00,  87.86,  87.80,  87.99,  88.20,  88.20,  87.90,  87.22,
	86.30,  85.30,  84.00,  82.21,  80.20,  78.24,  76.30,  74.36,  72.40,  70.40,
	68.30,  66.30,  64.40,  62.80,  61.50,  60.20,  59.20,  58.50,  58.10,  58.00,
	58.20,  58.50,  59.10
};
/* An estimate of Nikonc Coolscan 9000ED backlight spectra combined red, green, blue.  Since leds flicker
   relative intensities are unknown.
   It should approximate Status M (440nm, 540nm, 640nm)
   or Status A (Status A (440nm, 530nm, 620nm) - For color positives
   but seems the peaks are  466nm, 526nm, 653nm.  
   http://hecgeek.blogspot.com/2021/07/the-printalyzer-densitometer-project.html
   */

const static spectra_entry nikon_coolscan_9000ED_LED_white[] = {
  {404.56051416199665, 0.00197242384489682},
  {409.6042783925797, 0.002159969689890462},
  {414.6480426231628, 0.00197242384489682},
  {419.69180685374585, 0.002347515534884159},
  {424.7355710843289, 0.0036290788090076465},
  {429.779335314912, 0.006754842892235768},
  {434.59383753501396, 0.012371840949796709},
  {438.2620297027107, 0.020096645920814393},
  {440.55464980752123, 0.0271738967659233},
  {442.38874589136964, 0.03568378948251183},
  {443.99357996473697, 0.04410772368681154},
  {445.5984140381043, 0.05631383243181726},
  {446.5154620800285, 0.0640500985378068},
  {447.4325101219527, 0.07333361786499426},
  {448.34955816387685, 0.08278905421675925},
  {449.26660620580105, 0.09086915437190385},
  {450.18365424772526, 0.1023875950185994},
  {450.8714402791684, 0.11012386112458894},
  {451.55922631061156, 0.12301763796790488},
  {452.4762743525357, 0.13487991266375549},
  {452.93479837349787, 0.14433534901552048},
  {453.851846415422, 0.1565414577605262},
  {454.69247378718586, 0.16834642678151768},
  {455.2274184783083, 0.18095367525053763},
  {456.06804585007217, 0.1931024783206842},
  {456.60299054119463, 0.20570972678970417},
  {457.4436179129584, 0.21740008446097725},
  {457.97856260408093, 0.22977811023056052},
  {458.89561064600514, 0.24249997004929888},
  {459.7362380177689, 0.25350265962226176},
  {460.2711827088914, 0.26433343217064714},
  {461.1882307508156, 0.27619570686649775},
  {462.1052787927398, 0.2873703134640382},
  {463.251588845145, 0.29969103355876225},
  {466.4612569918797, 0.30705481277816715},
  {466.4612569918797, 0.3121836706780639},
  {469.6709251386144, 0.3001494789576358},
  {470.8172351910196, 0.2908086539555891},
  {471.73428323294377, 0.2806655495055139},
  {472.65133127486797, 0.2708662791045938},
  {473.5683793167922, 0.2608950916790962},
  {474.4854273587164, 0.25143965532733126},
  {475.4024754006406, 0.23906162955774796},
  {476.3195234425648, 0.22737127188647488},
  {477.236571484489, 0.21619666528893444},
  {478.1536195264132, 0.2046782246422389},
  {479.07066756833734, 0.19539470531505146},
  {479.98771561026155, 0.18559543491413136},
  {480.9047636521857, 0.17545233046405617},
  {481.8218116941099, 0.16582497708771365},
  {482.7388597360341, 0.15619762371137108},
  {483.8851697884394, 0.14725793843333873},
  {485.0314798408446, 0.13900592125361655},
  {486.17778989324984, 0.1301808473253026},
  {487.55336195613614, 0.12112655069755185},
  {489.1581960295035, 0.11304645054240725},
  {491.2215541238329, 0.10489758357743156},
  {494.8897462915297, 0.09821469996748988},
  {498.7872004697075, 0.101298787196275},
  {500.85055856403693, 0.1085193022285319},
  {502.4553926374043, 0.11674266657082444},
  {503.83096470029056, 0.12473680821368033},
  {504.74801274221477, 0.13178540622135965},
  {505.89432279462, 0.14175659364685728},
  {507.0406328470252, 0.15224353214608755},
  {507.9576808889494, 0.1599797982520771},
  {508.87472893087363, 0.16891948353010944},
  {509.79177697279783, 0.178546836906452},
  {510.70882501472204, 0.18937760945483736},
  {511.62587305664624, 0.20003646497864516},
  {512.5429210985703, 0.21017956942872035},
  {513.4599691404946, 0.21860350363302006},
  {514.3770171824187, 0.22995002725513805},
  {515.294065224343, 0.24078079980352343},
  {516.2111132662671, 0.25143965532733126},
  {517.1281613081914, 0.26192659382656147},
  {518.0452093501156, 0.26931902588339596},
  {518.9622573920398, 0.27791487711227325},
  {520.108567444445, 0.2883445099366443},
  {521.4841395073313, 0.2971695838649583},
  {523.5474976016608, 0.3065104088670049},
  {527.4449517798386, 0.31101671875365877},
  {530.8838819370543, 0.30344455526203873},
  {532.7179780209026, 0.29459082849629514},
  {534.3228120942699, 0.2851353921445301},
  {535.6983841571563, 0.2750495933693141},
  {536.8446942095616, 0.2662245194410001},
  {537.9910042619667, 0.2578578909115596},
  {539.137314314372, 0.2490328169832456},
  {540.0543623562962, 0.24181230195098868},
  {540.9714103982204, 0.23338836774668897},
  {541.8884584401446, 0.22565210164069943},
  {543.0347684925498, 0.21682702771238543},
  {544.1810785449551, 0.20811656513378982},
  {545.0981265868793, 0.2005522160523778},
  {546.2444366392845, 0.19058102862688017},
  {547.6200087021708, 0.17992217310307237},
  {548.766318754576, 0.17270165807081544},
  {549.9126288069813, 0.1638765841425015},
  {551.2882008698675, 0.15402000806672217},
  {552.6637729327539, 0.14553876818756328},
  {554.0393449956401, 0.13602602616093912},
  {555.4149170585265, 0.12731556358234347},
  {556.7904891214127, 0.1191781577523397},
  {558.166061184299, 0.11161380867092768},
  {559.5416332471852, 0.10404945958951572},
  {561.1464673205526, 0.09619858213380778},
  {562.980563404401, 0.08889210858926211},
  {564.8146594882494, 0.08149967653242768},
  {566.8780175825789, 0.07367745191414932},
  {569.1706376873893, 0.0653566679245961},
  {571.9217818131619, 0.05727165585446359},
  {575.1314499598966, 0.04946171102365515},
  {578.5703801171123, 0.04204471939188098},
  {582.9263583162522, 0.0337927022121588},
  {587.9701225468352, 0.02766620460903174},
  {593.0138867774183, 0.022602466794202247},
  {598.0576510080014, 0.019414187429309615},
  {603.1014152385844, 0.01850771584517341},
  {608.1451794691675, 0.018757776971831674},
  {613.1889436997506, 0.02291504320252502},
  {617.5449218988906, 0.030913092050484925},
  {620.5253280351442, 0.03888144613965416},
  {622.5886861294736, 0.04668647905547474},
  {624.193520202841, 0.05476657921061934},
  {625.7983542762083, 0.06319051341491905},
  {627.1739263390946, 0.07178636464379634},
  {628.0909743810187, 0.07883496265147572},
  {629.008022422943, 0.08657122875746526},
  {629.9250704648671, 0.09499516296176497},
  {630.8421185067914, 0.10410676526437485},
  {631.7591665487155, 0.1121868654195195},
  {632.6762145906397, 0.12181421879586202},
  {633.5932626325639, 0.1329888253934025},
  {634.5103106744881, 0.14553876818756328},
  {635.4273587164123, 0.15860446205545675},
  {636.3444067583365, 0.16891948353010944},
  {637.1850341301003, 0.1779737801578602},
  {637.7199788212228, 0.18903377540568228},
  {638.637026863147, 0.20089605010153289},
  {639.0955508841091, 0.21017956942872035},
  {639.9361782558728, 0.22060920225309144},
  {640.4711229469954, 0.23218494857464614},
  {641.3881709889196, 0.24353147219676413},
  {642.2287983606834, 0.25361727097198017},
  {642.7637430518058, 0.26536493431811237},
  {643.6043704235697, 0.2763103182162161},
  {644.1393151146922, 0.2878860645377709},
  {644.9799424864559, 0.2983156973621419},
  {645.5148871775784, 0.30989144368369664},
  {646.4319352195026, 0.320722216232082},
  {647.3489832614268, 0.3317249058050449},
  {648.2660313033509, 0.3418680102551201},
  {649.1830793452752, 0.35218303172977283},
  {652.0717806773364, 0.3614321676520448},
  {653.080533523453, 0.36524872559766625},
  {655.1438916177824, 0.3518391976806177},
  {656.0609396597067, 0.34513443372209346},
  {656.9779877016308, 0.33653858249321617},
  {657.436511722593, 0.3277708142397614},
  {657.895035743555, 0.32003454813377186},
  {658.5828217749981, 0.3100633607082742},
  {659.0413457959603, 0.301811343528552},
  {659.7291318274034, 0.29338740932425234},
  {660.1876558483655, 0.2834162218987547},
  {660.6461798693276, 0.27430461959614477},
  {661.5632279112517, 0.26244234490029417},
  {662.251013942695, 0.25006431913071087},
  {662.7095379636571, 0.24043696575436832},
  {663.3973239951001, 0.2304657783288707},
  {663.8558480160623, 0.22032267387879553},
  {664.3143720370244, 0.2118987396744958},
  {665.0021580684675, 0.20141180117526553},
  {665.4606820894296, 0.19247211589723318},
  {666.1484681208727, 0.1838762646683559},
  {667.0655161627969, 0.1723578240216604},
  {667.5240401837591, 0.16307430469447293},
  {668.4410882256832, 0.15121202999862227},
  {669.3581362676075, 0.13780250208157374},
  {670.2751843095316, 0.12731556358234347},
  {671.1922323514558, 0.11700054210769079},
  {672.10928039338, 0.1061697695593054},
  {673.0263284353042, 0.09533899701092008},
  {673.9433764772284, 0.08639931173288767},
  {675.0896865296336, 0.07711579240570027},
  {676.2359965820389, 0.06800419010309033},
  {677.3823066344441, 0.059694867248508976},
  {678.7578786973304, 0.05098440466991333},
  {680.3627127706977, 0.04256047046561362},
  {682.1968088545461, 0.0343944117981802},
  {684.4894289593567, 0.02594182475645096},
  {688.1576211270534, 0.017426201472376557},
  {692.9721233471554, 0.012287445319549506},
  {698.0158875777385, 0.010349471587948078},
  {703.0596518083215, 0.008599043701340348},
  {708.1034160389046, 0.009036650672992308},
  {713.1471802694876, 0.009036650672992308},
  {718.1909445000707, 0.009974379897960739},
  {723.2347087306538, 0.010693305637103134},
  {727.5906869297937, 0.011099654967922812}
};


/* An estimate of Nikonc Coolscan 9000ED backlight spectras based on measurements of all bands together.
   It should approximate Status M (440nm, 540nm, 640nm) bt seems the peaks are  466nm, 526nm, 653nm.  */
   
const static spectra_entry nikon_coolscan_9000ED_LED_red[] = {
  {350, 0},
  {399.93997599039614, 0.000360082304526832},
  {449.87995198079227, 0},
  {500.0600240096038, 0},
  {550, 0},
  {572.0888355342137, 0.00036008230452672096},
  {585.5342136854741, 1.1102230246251565e-16},
  {598.499399759904, 0.007561728395061751},
  {612.9051620648258, 0.021965020576131755},
  {621.7887154861944, 0.042849794238683125},
  {627.0708283313326, 0.07021604938271608},
  {631.6326530612245, 0.10982510288065844},
  {636.9147659063625, 0.17319958847736627},
  {640.516206482593, 0.2272119341563786},
  {643.3973589435775, 0.2704218106995885},
  {645.798319327731, 0.3129115226337449},
  {649.1596638655462, 0.34747942386831276},
  {650.3601440576231, 0.3597222222222222},
  {653.0012004801921, 0.36440329218107},
  {656.1224489795918, 0.34603909465020577},
  {658.5234093637455, 0.3139917695473251},
  {661.1644657863146, 0.27078189300411526},
  {663.8055222088835, 0.2272119341563786},
  {667.1668667466987, 0.1728395061728395},
  {671.4885954381753, 0.11198559670781894},
  {676.2905162064826, 0.06985596707818931},
  {680.3721488595438, 0.042849794238683125},
  {689.7358943577431, 0.015483539094650223},
  {703.1812725090035, 0.007561728395061751},
  {719.5078031212485, 0.0018004115226337714},
  {750, 0.000360082304526832}
};
const static spectra_entry nikon_coolscan_9000ED_LED_green[] = {
  {399.93997599039614, 0},
  {450.1200480192077, -0.00036008230452666545},
  {463.0852340936374, 0.00036008230452672096},
  {475.57022809123646, 0.02340534979423864},
  {488.05522208883554, 0.054372427983539084},
  {498.13925570228093, 0.09974279835390948},
  {505.8223289315726, 0.14079218106995883},
  {511.10444177671064, 0.1919238683127572},
  {514.9459783913564, 0.2372942386831276},
  {519.5078031212485, 0.28194444444444444},
  {522.1488595438175, 0.30138888888888893},
  {524.0696278511405, 0.3078703703703704},
  {526.9507803121248, 0.3129115226337449},
  {531.032412965186, 0.30354938271604937},
  {534.1536614645859, 0.2862654320987654},
  {540.3961584633853, 0.23909465020576132},
  {545.9183673469388, 0.19264403292181068},
  {553.1212484993997, 0.14187242798353905},
  {559.3637454981993, 0.10406378600823046},
  {570.6482593037214, 0.06085390946502056},
  {579.7719087635054, 0.039248971193415694},
  {595.1380552220888, 0.021244855967078202},
  {617.2268907563025, 0.009002057613168746},
  {642.6770708283314, 0},
  {673.8895558223289, 0},
  {700.0600240096037, 0},
  {750, 0}
};
const static spectra_entry nikon_coolscan_9000ED_LED_blue[] = {
  {350, 0},
  {399.93997599039614, 0.00036008230452672096},
  {418.90756302521004, 0.00036008230452672096},
  {436.4345738295318, 0.014763374485596725},
  {442.9171668667467, 0.03780864197530864},
  {447.23889555822325, 0.06877572016460909},
  {449.6398559423769, 0.094701646090535},
  {451.8007202881152, 0.12422839506172839},
  {453.4813925570228, 0.15159465020576135},
  {454.92196878751497, 0.17752057613168726},
  {456.36254501800715, 0.20272633744855967},
  {458.28331332533014, 0.2308127572016461},
  {459.96398559423767, 0.25745884773662553},
  {461.40456182472985, 0.27690329218107},
  {462.84513805522204, 0.2977880658436214},
  {466.44657863145255, 0.3132716049382716},
  {469.8079231692677, 0.29958847736625516},
  {472.20888355342134, 0.27690329218106996},
  {474.1296518607443, 0.2578189300411523},
  {476.0504201680672, 0.23153292181069962},
  {478.4513805522209, 0.2012860082304527},
  {480.8523409363745, 0.17463991769547327},
  {484.453781512605, 0.14367283950617282},
  {489.015606242497, 0.11414609053497943},
  {496.21848739495795, 0.07597736625514406},
  {500.5402160864345, 0.03996913580246919},
  {509.66386554621846, 0.014763374485596725},
  {527.4309723889555, 0.0018004115226337714},
  {562.0048019207683, 0.00036008230452672096},
  {599.9399759903961, 0.000360082304526832},
  {650.1200480192076, 0},
  {699.8199279711885, 0},
};
const static spectra_entry debug_light[] = {
  {380, 0.0005444380069},
  {381, 0.0005774247297},
  {382, 0.0006097831341},
  {383, 0.0006107256119},
  {384, 0.0006327167604},
  {385, 0.0006565928646},
  {386, 0.000685495517},
  {387, 0.00072696454},
  {388, 0.0007897963931},
  {389, 0.0008482300165},
  {390, 0.000895039747},
  {391, 0.0009902300044},
  {392, 0.001124061851},
  {393, 0.001267318476},
  {394, 0.001448902532},
  {395, 0.001746097197},
  {396, 0.002105809556},
  {397, 0.002574849339},
  {398, 0.003210707692},
  {399, 0.004106061598},
  {400, 0.005215043805},
  {401, 0.006553362275},
  {402, 0.008234114345},
  {403, 0.01055889291},
  {404, 0.0130438927},
  {405, 0.0156074323},
  {406, 0.01814898076},
  {407, 0.02008106024},
  {408, 0.02159844949},
  {409, 0.0223241574},
  {410, 0.02208853795},
  {411, 0.02151362649},
  {412, 0.02042035225},
  {413, 0.01931451163},
  {414, 0.01849769754},
  {415, 0.01802331705},
  {416, 0.01767145868},
  {417, 0.01723791889},
  {418, 0.01699915785},
  {419, 0.01670384814},
  {420, 0.01627659154},
  {421, 0.01563256504},
  {422, 0.01521787481},
  {423, 0.01463668017},
  {424, 0.01424398109},
  {425, 0.01428796339},
  {426, 0.01447331736},
  {427, 0.01486915803},
  {428, 0.01558544115},
  {429, 0.01643367117},
  {430, 0.01735101623},
  {431, 0.01863278603},
  {432, 0.01992398061},
  {433, 0.02115548493},
  {434, 0.02243411314},
  {435, 0.02421225458},
  {436, 0.0256165465},
  {437, 0.02670353756},
  {438, 0.02815809495},
  {439, 0.02974774084},
  {440, 0.03108605931},
  {441, 0.03251548396},
  {442, 0.03386636881},
  {443, 0.03515442179},
  {444, 0.0362225633},
  {445, 0.03703937739},
  {446, 0.03823318259},
  {447, 0.03876725335},
  {448, 0.03933274002},
  {449, 0.03977256299},
  {450, 0.04043229745},
  {451, 0.0408407045},
  {452, 0.04112344784},
  {453, 0.04128052747},
  {454, 0.04150043895},
  {455, 0.04112344784},
  {456, 0.04124911154},
  {457, 0.04080928857},
  {458, 0.04027521782},
  {459, 0.04024380189},
  {460, 0.03999247448},
  {461, 0.0394269878},
  {462, 0.03901858076},
  {463, 0.03857875779},
  {464, 0.03820176667},
  {465, 0.03785619148},
  {466, 0.03732212072},
  {467, 0.03697654553},
  {468, 0.03663097034},
  {469, 0.03625397922},
  {470, 0.03584557218},
  {471, 0.03540574921},
  {472, 0.03502875809},
  {473, 0.03487167845},
  {474, 0.03440043956},
  {475, 0.03408628029},
  {476, 0.03370928917},
  {477, 0.03361504139},
  {478, 0.03348937769},
  {479, 0.03311238657},
  {480, 0.03289247508},
  {481, 0.03270397952},
  {482, 0.03254689989},
  {483, 0.03245265211},
  {484, 0.03232698841},
  {485, 0.03213849285},
  {486, 0.03185574951},
  {487, 0.03188716543},
  {488, 0.03182433358},
  {489, 0.03169866987},
  {490, 0.03166725395},
  {491, 0.03144734246},
  {492, 0.03141592654},
  {493, 0.03138136902},
  {494, 0.03128397964},
  {495, 0.03111119205},
  {496, 0.03113946638},
  {497, 0.0310452186},
  {498, 0.03076561686},
  {499, 0.03083473189},
  {500, 0.03092897967},
  {501, 0.03088499738},
  {502, 0.03101066108},
  {503, 0.03111747523},
  {504, 0.03125256372},
  {505, 0.03139393539},
  {506, 0.03154159024},
  {507, 0.03147875839},
  {508, 0.03163583802},
  {509, 0.03176150173},
  {510, 0.03216990877},
  {511, 0.03245265211},
  {512, 0.03286105916},
  {513, 0.03317521842},
  {514, 0.03339512991},
  {515, 0.0337407051},
  {516, 0.03396061659},
  {517, 0.03427477585},
  {518, 0.03462035104},
  {519, 0.03477743068},
  {520, 0.03509158994},
  {521, 0.03549999699},
  {522, 0.03568849254},
  {523, 0.03590840403},
  {524, 0.03615973144},
  {525, 0.03650530663},
  {526, 0.0368194659},
  {527, 0.03716504109},
  {528, 0.0374163685},
  {529, 0.03754203221},
  {530, 0.03782477555},
  {531, 0.03782477555},
  {532, 0.03769911184},
  {533, 0.03773052777},
  {534, 0.03779335962},
  {535, 0.03751061628},
  {536, 0.03760486406},
  {537, 0.0374163685},
  {538, 0.03735353665},
  {539, 0.0374163685},
  {540, 0.03725928887},
  {541, 0.03710220924},
  {542, 0.03694512961},
  {543, 0.03669380219},
  {544, 0.03647389071},
  {545, 0.0362225633},
  {546, 0.03578274032},
  {547, 0.03553141291},
  {548, 0.03534291735},
  {549, 0.03515442179},
  {550, 0.03462035104},
  {551, 0.03440043956},
  {552, 0.03408628029},
  {553, 0.0337407051},
  {554, 0.03352079361},
  {555, 0.03330088213},
  {556, 0.03295530694},
  {557, 0.03289247508},
  {558, 0.03260973174},
  {559, 0.03235840433},
  {560, 0.03207566099},
  {561, 0.03185574951},
  {562, 0.03163583802},
  {563, 0.03128397964},
  {564, 0.03108291771},
  {565, 0.03082844871},
  {566, 0.03062424519},
  {567, 0.03045774078},
  {568, 0.03029437796},
  {569, 0.03025982044},
  {570, 0.03015300629},
  {571, 0.02998964347},
  {572, 0.02990482047},
  {573, 0.02979800632},
  {574, 0.02957181165},
  {575, 0.02943986476},
  {576, 0.02947128068},
  {577, 0.0294210152},
  {578, 0.02936760813},
  {579, 0.02932990901},
  {580, 0.02934561698},
  {581, 0.0292922099},
  {582, 0.02935190016},
  {583, 0.02942415679},
  {584, 0.02936760813},
  {585, 0.02947128068},
  {586, 0.02939902405},
  {587, 0.02944928953},
  {588, 0.02955924528},
  {589, 0.02970690013},
  {590, 0.02978858154},
  {591, 0.02983884702},
  {592, 0.03006504169},
  {593, 0.02999278506},
  {594, 0.03001477621},
  {595, 0.03022840451},
  {596, 0.03042318326},
  {597, 0.03048601511},
  {598, 0.03073420093},
  {599, 0.03082530712},
  {600, 0.03094154605},
  {601, 0.03106720975},
  {602, 0.03124628053},
  {603, 0.03147875839},
  {604, 0.03154159024},
  {605, 0.03169866987},
  {606, 0.03185574951},
  {607, 0.03201282914},
  {608, 0.03216990877},
  {609, 0.03235840433},
  {610, 0.03235840433},
  {611, 0.03245265211},
  {612, 0.03251548396},
  {613, 0.0326725636},
  {614, 0.0327982273},
  {615, 0.03292389101},
  {616, 0.03301813879},
  {617, 0.0331438025},
  {618, 0.03323805027},
  {619, 0.03345796176},
  {620, 0.03355220954},
  {621, 0.03348937769},
  {622, 0.03367787325},
  {623, 0.03367787325},
  {624, 0.03370928917},
  {625, 0.03364645732},
  {626, 0.03367787325},
  {627, 0.0337407051},
  {628, 0.03380353695},
  {629, 0.03389778473},
  {630, 0.03386636881},
  {631, 0.03380353695},
  {632, 0.03380353695},
  {633, 0.0337407051},
  {634, 0.03361504139},
  {635, 0.03345796176},
  {636, 0.03352079361},
  {637, 0.03348937769},
  {638, 0.03345796176},
  {639, 0.0332694662},
  {640, 0.03323805027},
  {641, 0.0331438025},
  {642, 0.03308097064},
  {643, 0.03286105916},
  {644, 0.03270397952},
  {645, 0.03254689989},
  {646, 0.03235840433},
  {647, 0.03207566099},
  {648, 0.03194999729},
  {649, 0.03185574951},
  {650, 0.03166725395},
  {651, 0.03133424513},
  {652, 0.03098552834},
  {653, 0.03069650182},
  {654, 0.030533139},
  {655, 0.03047973193},
  {656, 0.03009331603},
  {657, 0.02991110365},
  {658, 0.02966920102},
  {659, 0.02947756387},
  {660, 0.02907544001},
  {661, 0.02880212145},
  {662, 0.0286104843},
  {663, 0.02827747547},
  {664, 0.02794132506},
  {665, 0.02765544013},
  {666, 0.02736327201},
  {667, 0.02707424549},
  {668, 0.02672238711},
  {669, 0.02651818359},
  {670, 0.02617889158},
  {671, 0.0258710155},
  {672, 0.02551601553},
  {673, 0.0251013253},
  {674, 0.02479030763},
  {675, 0.02442274129},
  {676, 0.02418398025},
  {677, 0.02365305109},
  {678, 0.02342371483},
  {679, 0.02311269715},
  {680, 0.02270114851},
  {681, 0.02243725473},
  {682, 0.02216707776},
  {683, 0.02177123709},
  {684, 0.02140052916},
  {685, 0.0210832283},
  {686, 0.02075336107},
  {687, 0.02047061773},
  {688, 0.02019415758},
  {689, 0.01983287442},
  {690, 0.01940247623},
  {691, 0.01903490989},
  {692, 0.01876159133},
  {693, 0.01839088339},
  {694, 0.01804216661},
  {695, 0.01767460027},
  {696, 0.01733530826},
  {697, 0.01711853837},
  {698, 0.01674783044},
  {699, 0.01643367117},
  {700, 0.0160786712},
  {701, 0.01583048538},
  {702, 0.01549747656},
  {703, 0.01517703411},
  {704, 0.01486287484},
  {705, 0.0146272554},
  {706, 0.01418743242},
  {707, 0.01387641475},
  {708, 0.01360937938},
  {709, 0.01336747674},
  {710, 0.01306274225},
  {711, 0.01270460069},
  {712, 0.01247212283},
  {713, 0.0121893795},
  {714, 0.0119757512},
  {715, 0.01164274237},
  {716, 0.01138199018},
  {717, 0.01113694596},
  {718, 0.01092645925},
  {719, 0.01062172476},
  {720, 0.01038610531},
  {721, 0.01016305223},
  {722, 0.009886592081},
  {723, 0.009679246966},
  {724, 0.009427919553},
  {725, 0.009182875326},
  {726, 0.009000662953},
  {727, 0.008777609874},
  {728, 0.00853570724},
  {729, 0.008328362125},
  {730, 0.008143008158},
  {731, 0.007948229414},
  {732, 0.007809999337},
  {733, 0.007583804666},
  {734, 0.007357609995},
  {735, 0.007156548065},
  {736, 0.006999468432},
  {737, 0.006836105614},
  {738, 0.00665389324},
  {739, 0.006525087942},
  {740, 0.006355441938},
  {741, 0.00617951275},
  {742, 0.006031857895},
  {743, 0.00587163667},
  {744, 0.005727123407},
  {745, 0.005507211922},
  {746, 0.005444380069},
  {747, 0.005296725214},
  {748, 0.005171061508},
  {749, 0.004991990727},
  {750, 0.004869468613},
  {751, 0.004743804907},
  {752, 0.00465269872},
  {753, 0.004523893421},
  {754, 0.004373096974},
  {755, 0.004307123528},
  {756, 0.004187743007},
  {757, 0.004024380189},
  {758, 0.00394269878},
  {759, 0.003829601445},
  {760, 0.003719645702},
  {761, 0.003669380219},
  {762, 0.003524866957},
  {763, 0.003455751919},
  {764, 0.003370928917},
  {765, 0.003295530694},
  {766, 0.003191858136},
  {767, 0.003089442216},
  {768, 0.003020327177},
  {769, 0.00298922541},
  {770, 0.002915083823},
  {771, 0.002872044004},
  {772, 0.002750464368},
  {773, 0.002643021899},
  {774, 0.002539035183},
  {775, 0.002548145801},
  {776, 0.002502278549},
  {777, 0.002421225458},
  {778, 0.002380698913},
  {779, 0.002351167942},
  {780, 0.002279539629},
};

/* Taken from Argyll
   General temperature Daylight spectra from CIE 15.2004 Appendix C.   
   ## uses improved interpolation rather than CIE 15.2004 Section 3.1 ##   
   Assumong 1931 observer & 5 nm spacing. (Need Lagrange interpolated S0, S1 for 1nm)   
   i.e. 300 - 830nm at 5nm intervals.   
   Fill in the given xspect with the specified daylight illuminant   
   Return nz if temperature is out of range */
static int
daylight_il (spectrum spec, double ct)
{
  static double s0[107] = {
    0.04000, -0.15625, 6.00000, 16.56625, 29.60000,
    43.80000, 55.30000, 57.62500, 57.30000, 59.69375,
    61.80000, 61.47500, 61.50000, 65.46875, 68.80000,
    66.40625, 63.40000, 62.45000, 65.80000, 79.82500,
    94.80000, 101.54375, 104.80000, 106.54375, 105.90000,
    100.35000, 96.80000, 104.05000, 113.90000, 120.82500,
    125.60000, 126.54375, 125.50000, 123.39375, 121.30000,
    121.52500, 121.30000, 117.42500, 113.50000, 112.95625,
    113.10000, 112.19375, 110.80000, 108.36250, 106.50000,
    107.60000, 108.80000, 107.25000, 105.30000, 104.90625,
    104.40000, 102.39375, 100.00000, 97.78125, 96.00000,
    95.67500, 95.10000, 91.95625, 89.10000, 89.43750,
    90.50000, 90.60625, 90.30000, 89.61250, 88.40000,
    86.01250, 84.00000, 84.47500, 85.10000, 83.52500,
    81.90000, 81.90625, 82.60000, 84.01875, 84.90000,
    83.83125, 81.30000, 76.22500, 71.90000, 72.38125,
    74.30000, 76.31875, 76.40000, 69.45625, 63.30000,
    66.35000, 71.70000, 75.61250, 77.00000, 72.52500,
    65.20000, 54.40625, 47.70000, 57.28125, 68.60000,
    68.04375, 65.00000, 65.58750, 66.00000, 64.04375,
    61.00000, 56.48750, 53.30000, 55.43125, 58.90000,
    61.71875, 61.90000
  };

  static double s1[107] = {
    0.02000, -0.15000, 4.50000, 12.50500, 22.40000,
    33.40625, 42.00000, 42.46250, 40.60000, 41.23750,
    41.60000, 39.58750, 38.00000, 40.21875, 42.40000,
    40.94375, 38.50000, 35.98125, 35.00000, 38.80000,
    43.40000, 45.52500, 46.30000, 45.70625, 43.90000,
    40.37500, 37.10000, 36.52500, 36.70000, 36.48125,
    35.90000, 34.49375, 32.60000, 30.26875, 27.90000,
    26.06875, 24.30000, 22.21875, 20.10000, 18.07500,
    16.20000, 14.74375, 13.20000, 10.86875, 8.60000,
    7.18125, 6.10000, 5.13750, 4.20000, 3.05000,
    1.90000, 0.90625, 0.00000, -0.80000, -1.60000,
    -2.65000, -3.50000, -3.47500, -3.50000, -4.56250,
    -5.80000, -6.55625, -7.20000, -7.93125, -8.60000,
    -9.05000, -9.50000, -10.26875, -10.90000, -10.80625,
    -10.70000, -11.21250, -12.00000, -13.10625, -14.00000,
    -14.02500, -13.60000, -12.69375, -12.00000, -12.57500,
    -13.30000, -13.32500, -12.90000, -11.66250, -10.60000,
    -10.91875, -11.60000, -12.08750, -12.20000, -11.38750,
    -10.20000, -8.66250, -7.80000, -9.40000, -11.20000,
    -11.00000, -10.40000, -10.50625, -10.60000, -10.25000,
    -9.70000, -8.88125, -8.30000, -8.68125, -9.30000,
    -9.79375, -9.80000
  };

  static double s2[107] = {
    0.00000, 1.15625, 2.00000, 2.84375, 4.00000,
    6.41875, 8.50000, 8.50000, 7.80000, 7.29375,
    6.70000, 5.88125, 5.30000, 5.80625, 6.10000,
    4.71250, 3.00000, 2.05000, 1.20000, -0.10000,
    -1.10000, -0.93125, -0.50000, -0.53125, -0.70000,
    -0.87500, -1.20000, -1.91250, -2.60000, -2.84375,
    -2.90000, -2.88125, -2.80000, -2.69375, -2.60000,
    -2.63750, -2.60000, -2.21875, -1.80000, -1.61250,
    -1.50000, -1.38750, -1.30000, -1.25000, -1.20000,
    -1.12500, -1.00000, -0.75000, -0.50000, -0.38750,
    -0.30000, -0.15000, 0.00000, 0.10000, 0.20000,
    0.26250, 0.50000, 1.25000, 2.10000, 2.69375,
    3.20000, 3.68125, 4.10000, 4.43125, 4.70000,
    4.83750, 5.10000, 5.88750, 6.70000, 7.01875,
    7.30000, 7.91250, 8.60000, 9.25625, 9.80000,
    10.19375, 10.20000, 9.19375, 8.30000, 8.90000,
    9.60000, 9.22500, 8.50000, 7.64375, 7.00000,
    7.18125, 7.60000, 7.91875, 8.00000, 7.46875,
    6.70000, 5.73125, 5.20000, 6.24375, 7.40000,
    7.22500, 6.80000, 6.90000, 7.00000, 6.76875,
    6.40000, 5.87500, 5.50000, 5.71875, 6.10000,
    6.43125, 6.50000,
  };

  /* M values for [1nm,5nm][1931,1964][M1,M2][g, h, i, j, k, l] */
  double ms[2][2][2][6] = {
    {				/* 1nm */
     {
      {-1.77864, 5.90745, -1.34666, 0.25540, -0.73218, 0.02387},
      {-31.44505, 30.06408, 0.03656, 0.25540, -0.73218, 0.02387}
      },
     {
      {-1.57049, 5.56450, -1.31211, 0.21249, -0.71591, 0.04663},
      {-30.15166, 31.07906, -0.73912, 0.21249, -0.71591, 0.04663}
      }
     },
    {				/* 5nm */
     {
      {-1.77861, 5.90757, -1.34674, 0.25539, -0.73217, 0.02387},
      {-31.44464, 30.06400, 0.03638, 0.25539, -0.73217, 0.02387}
      },
     {
      {-1.57049, 5.56460, -1.31215, 0.21250, -0.71592, 0.04663},
      {-30.15139, 31.07931, -0.73928, 0.21250, -0.71592, 0.04663}
      }
     }
  };

  int i;
  double xd, yd;
  int sint = 1;			/* 5nm */
  int obs = 0;			/* 1931 */
  double m1, m2;

    /* Only accurate down to about 4000 */
  if (ct < 2500.0)
    {
      fprintf (stderr, "Temperature of daylight too low %f\n", ct);
      ct = 2500;
    }
  if (ct > 25000.0)
    {
      fprintf (stderr, "Temperature of daylight too hight %f\n", ct);
      ct = 25000;
    }

  /* Compute chromaticity coordinates */
  if (ct < 7000.0)
    {
      xd =
	-4.6070e9 / (ct * ct * ct) + 2.9678e6 / (ct * ct) + 0.09911e3 / ct +
	0.244063;
    }
  else
    {
      xd =
	-2.0064e9 / (ct * ct * ct) + 1.9018e6 / (ct * ct) + 0.24748e3 / ct +
	0.237040;
    }
  yd = -3.000 * xd * xd + 2.870 * xd - 0.275;

  /* Compute m factors */
  m1 =
    (ms[sint][obs][0][0] * xd + ms[sint][obs][0][1] * yd +
     ms[sint][obs][0][2]) / (ms[sint][obs][0][3] * xd +
			     ms[sint][obs][0][4] * yd + ms[sint][obs][0][5]);
  m2 =
    (ms[sint][obs][1][0] * xd + ms[sint][obs][1][1] * yd +
     ms[sint][obs][1][2]) / (ms[sint][obs][1][3] * xd +
			     ms[sint][obs][1][4] * yd + ms[sint][obs][1][5]);

  /* Compute spectral values.
     Argyll starts from 300,w hile we start from 380 thus offset is 80/5=16. */
  for (i = 16; i < 16 + SPECTRUM_SIZE; i++)
    {
      spec[i - 16] = s0[i] + m1 * s1[i] + m2 * s2[i];
    }

#if 0
  sp->spec_n = 107;		/* 5nm spacing */
  sp->spec_wl_short = 300.0;
  sp->spec_wl_long = 830;
  sp->norm = 100.0;		/* Arbitrary */
#endif

  return 0;
}
}

void
set_illuminant_to (spectrum backlight, spectrum_dyes_to_xyz::illuminants il, luminosity_t temperature)
{
  switch (il)
  {
    case spectrum_dyes_to_xyz::il_A:
      compute_spectrum (backlight, 300, 830, sizeof (il_A)/sizeof (luminosity_t), il_A, false, 100);
      break;
    case spectrum_dyes_to_xyz::il_B:
      compute_spectrum (backlight, 320, 780, sizeof (il_B)/sizeof (luminosity_t), il_B, false, 100);
      break;
    case spectrum_dyes_to_xyz::il_C:
      compute_spectrum (backlight, 320, 780, sizeof (il_C)/sizeof (luminosity_t), il_C, false, 100);
      break;
    case spectrum_dyes_to_xyz::il_D:
      daylight_il (backlight, temperature);
      break;
    case spectrum_dyes_to_xyz::il_equal_energy:
      for (int i = 0; i < SPECTRUM_SIZE; i++)
	backlight[i] = 1;
      break;
    case spectrum_dyes_to_xyz::il_band:
	{
	  for (int i = 0; i < SPECTRUM_SIZE; i++)
	    backlight[i] = 0;
	  int p;
	  float b = my_modf ((temperature - SPECTRUM_START) / SPECTRUM_STEP, &p);
	  if (p >= 0 && p < SPECTRUM_SIZE)
	    {
	      if (p + 1 < SPECTRUM_SIZE)
	      {
		backlight[p] = 1 - b;
		backlight[p+1] = b;
	      }
	      else
		backlight[p] = 1;
	    }
	  else
	    backlight[0] = 1;
	  break;
	}
    case spectrum_dyes_to_xyz::il_nikon_coolscan_9000ED_LED_red:
	compute_spectrum (backlight,
			  sizeof (nikon_coolscan_9000ED_LED_red) / sizeof (spectra_entry),
			  nikon_coolscan_9000ED_LED_red, false, 1);
      break;
    /* separated leds are guesses.  Since blue and red are more obviously separated, guess on
       green led.  */
    case spectrum_dyes_to_xyz::il_nikon_coolscan_9000ED_LED_green:
      {
	spectrum red, blue;
	compute_spectrum (red,
			  sizeof (nikon_coolscan_9000ED_LED_red) / sizeof (spectra_entry),
			  nikon_coolscan_9000ED_LED_red, false, 1);
	compute_spectrum (blue,
			  sizeof (nikon_coolscan_9000ED_LED_blue) / sizeof (spectra_entry),
			  nikon_coolscan_9000ED_LED_blue, false, 1);
	compute_spectrum (backlight,
			  sizeof (nikon_coolscan_9000ED_LED_white) / sizeof (spectra_entry),
			  nikon_coolscan_9000ED_LED_white, false, 1);
	for (int i = 0; i < SPECTRUM_SIZE; i++)
	  {
	    backlight[i] -= red[i] + blue[i];
	    if (backlight[i] < 0)
	      backlight[i] = 0;
	  }
      }
      break;
    case spectrum_dyes_to_xyz::il_nikon_coolscan_9000ED_LED_blue:
	compute_spectrum (backlight,
			  sizeof (nikon_coolscan_9000ED_LED_blue) / sizeof (spectra_entry),
			  nikon_coolscan_9000ED_LED_blue, false, 1);
      break;
    case spectrum_dyes_to_xyz::il_debug:
	compute_spectrum (backlight,
			  sizeof (debug_light) / sizeof (spectra_entry),
			  debug_light, false, 1);
      break;
    default: abort ();
  }
}
}
