#include <string>
#include "include/spectrum-to-xyz.h"
#include "include/scr-to-img.h"
#include "include/render.h"
#include "include/tiff-writer.h"
#include "icc.h"
#include "dufaycolor.h"

#define XSPECT_MAX_BANDS 77		/* Enough for 5nm from 380 to 760 */
typedef struct {
	int    spec_n;				/* Number of spectral bands, 0 if not valid */
	luminosity_t spec_wl_short;		/* First reading wavelength in nm (shortest) */
	luminosity_t spec_wl_long;		/* Last reading wavelength in nm (longest) */
	luminosity_t norm;			/* Normalising scale value, ie. 1, 100 etc. */
	luminosity_t spec[XSPECT_MAX_BANDS];    /* Spectral value, shortest to longest */
} xspect;

/* EBU TLCI ColorChecker samples */
static xspect TLCI_2012_TCS[] = {

	/* 1 Dark skin */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05400, 0.05700, 0.06300, 0.06600, 0.07500,
			0.07800, 0.07800, 0.07600, 0.07400, 0.07000,
			0.06600, 0.06400, 0.06200, 0.06000, 0.05900,
			0.06000, 0.05800, 0.06000, 0.06000, 0.06200,
			0.05800, 0.06300, 0.06300, 0.06700, 0.06800,
			0.07000, 0.07200, 0.07700, 0.07900, 0.08100,
			0.08100, 0.08300, 0.08300, 0.08400, 0.08400,
			0.08800, 0.09300, 0.09800, 0.10400, 0.11100,
			0.12100, 0.12700, 0.13300, 0.14000, 0.14400,
			0.14900, 0.15100, 0.15400, 0.16000, 0.16400,
			0.17000, 0.17500, 0.17900, 0.18400, 0.19300,
			0.20300, 0.21300, 0.22000, 0.23600, 0.24100,
			0.24800, 0.25700, 0.26900, 0.28000, 0.28900,
			0.30000, 0.31400, 0.33700, 0.34600, 0.36100,
			0.38200, 0.40400, 0.42500, 0.43900, 0.46400,
			0.47600, 0.49000
		}
	},
	/* 2 Light skin */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.09200, 0.10900, 0.13400, 0.16100, 0.18600,
			0.20000, 0.20500, 0.20600, 0.20700, 0.20900,
			0.21100, 0.21300, 0.21600, 0.22100, 0.22700,
			0.23700, 0.24600, 0.25900, 0.27300, 0.28500,
			0.29400, 0.30400, 0.30500, 0.30900, 0.31400,
			0.32300, 0.33400, 0.34000, 0.33200, 0.31600,
			0.30000, 0.29200, 0.29000, 0.29500, 0.30000,
			0.30200, 0.29700, 0.29500, 0.30400, 0.32800,
			0.36500, 0.40900, 0.45000, 0.48800, 0.52000,
			0.54000, 0.55600, 0.56600, 0.57400, 0.58200,
			0.59300, 0.60200, 0.60700, 0.62500, 0.63100,
			0.63900, 0.65500, 0.66100, 0.68700, 0.69300,
			0.71100, 0.72200, 0.73700, 0.75700, 0.76800,
			0.78600, 0.79800, 0.81500, 0.82200, 0.82300,
			0.83500, 0.84500, 0.85500, 0.84800, 0.86200,
			0.86100, 0.86800
		}
	},
	/* 3 Blue sky */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10500, 0.12700, 0.16400, 0.21300, 0.27100,
			0.31400, 0.33300, 0.34400, 0.34500, 0.34400,
			0.34600, 0.34600, 0.34700, 0.34300, 0.33700,
			0.33300, 0.32700, 0.32400, 0.31900, 0.30600,
			0.29000, 0.28800, 0.28000, 0.27400, 0.26500,
			0.25800, 0.25000, 0.24000, 0.22900, 0.22000,
			0.21200, 0.20700, 0.20300, 0.19800, 0.19300,
			0.19100, 0.18700, 0.18100, 0.17400, 0.17000,
			0.16700, 0.16200, 0.15800, 0.16100, 0.15600,
			0.15200, 0.15000, 0.14500, 0.14200, 0.13700,
			0.13300, 0.13200, 0.12600, 0.12700, 0.12100,
			0.11800, 0.11500, 0.11500, 0.11200, 0.11000,
			0.11000, 0.10900, 0.10800, 0.10800, 0.10600,
			0.10500, 0.10500, 0.10600, 0.10600, 0.10500,
			0.10700, 0.10500, 0.10600, 0.10500, 0.10800,
			0.10700, 0.11000
		}
	},
	/* 4 Foliage */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05000, 0.05200, 0.05200, 0.05000, 0.05200,
			0.05200, 0.05200, 0.05300, 0.05100, 0.05300,
			0.05300, 0.05300, 0.05500, 0.05800, 0.05900,
			0.06100, 0.06000, 0.06300, 0.06300, 0.06700,
			0.06500, 0.06700, 0.06900, 0.07200, 0.07700,
			0.08800, 0.10500, 0.13200, 0.15900, 0.18200,
			0.19500, 0.19900, 0.19100, 0.18000, 0.16700,
			0.15600, 0.14400, 0.13300, 0.13100, 0.13000,
			0.12900, 0.12300, 0.11800, 0.11400, 0.11000,
			0.10200, 0.10100, 0.10300, 0.10400, 0.10500,
			0.10500, 0.10600, 0.10200, 0.10200, 0.10100,
			0.10100, 0.10100, 0.10100, 0.10700, 0.11500,
			0.13200, 0.15200, 0.18500, 0.23300, 0.28300,
			0.33900, 0.38300, 0.41900, 0.44400, 0.44500,
			0.46500, 0.47300, 0.47700, 0.48000, 0.48900,
			0.49200, 0.49800
		}
	},
	/* 5 Blue flower */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10100, 0.12700, 0.17000, 0.23300, 0.31000,
			0.37300, 0.40900, 0.42400, 0.43200, 0.43700,
			0.43700, 0.43800, 0.43700, 0.43200, 0.42800,
			0.42300, 0.41700, 0.41200, 0.40500, 0.39500,
			0.38000, 0.37300, 0.36400, 0.35500, 0.34200,
			0.33300, 0.31600, 0.29600, 0.26700, 0.24500,
			0.22700, 0.21200, 0.20600, 0.20300, 0.20300,
			0.20400, 0.19600, 0.19000, 0.19000, 0.19400,
			0.20100, 0.21000, 0.21600, 0.22500, 0.22800,
			0.23200, 0.23800, 0.24000, 0.23600, 0.23600,
			0.24000, 0.24800, 0.26100, 0.28900, 0.32200,
			0.36200, 0.40700, 0.44600, 0.48800, 0.51200,
			0.54600, 0.54600, 0.55500, 0.56300, 0.56400,
			0.57500, 0.57800, 0.58600, 0.59000, 0.58900,
			0.60100, 0.60400, 0.60600, 0.60500, 0.61400,
			0.61600, 0.61700
		}
	},
	/* 6 Bluish green */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10800, 0.13200, 0.16800, 0.21300, 0.26000,
			0.29200, 0.30800, 0.31700, 0.32000, 0.32800,
			0.33600, 0.34200, 0.35200, 0.36000, 0.37100,
			0.38600, 0.40500, 0.43300, 0.46500, 0.49700,
			0.52800, 0.55700, 0.57600, 0.59100, 0.58600,
			0.59100, 0.58600, 0.58200, 0.56700, 0.55900,
			0.54500, 0.53300, 0.51200, 0.49200, 0.47200,
			0.44500, 0.42900, 0.40200, 0.38000, 0.35500,
			0.33200, 0.30900, 0.28400, 0.26200, 0.24700,
			0.23300, 0.22400, 0.21700, 0.21200, 0.20900,
			0.20700, 0.20500, 0.20000, 0.19800, 0.19900,
			0.19700, 0.19900, 0.20300, 0.21000, 0.21600,
			0.21800, 0.22600, 0.23200, 0.23600, 0.23800,
			0.24200, 0.24200, 0.23900, 0.23200, 0.22700,
			0.22900, 0.23000, 0.23700, 0.24800, 0.25600,
			0.26900, 0.27400
		}
	},
	/* 7 Orange */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05200, 0.05400, 0.05200, 0.05000, 0.05200,
			0.05200, 0.05200, 0.05100, 0.05000, 0.05000,
			0.05200, 0.05000, 0.05100, 0.05100, 0.05200,
			0.05100, 0.05100, 0.05300, 0.05300, 0.05400,
			0.05500, 0.05600, 0.05500, 0.05800, 0.06100,
			0.06300, 0.06800, 0.07700, 0.08600, 0.09800,
			0.12000, 0.14500, 0.17500, 0.20600, 0.23600,
			0.27000, 0.30200, 0.34100, 0.37500, 0.41000,
			0.44000, 0.46700, 0.48800, 0.50900, 0.51800,
			0.53200, 0.54000, 0.55100, 0.55700, 0.56200,
			0.56800, 0.57500, 0.58100, 0.58400, 0.58500,
			0.59000, 0.60100, 0.59600, 0.60000, 0.59600,
			0.60400, 0.60300, 0.60600, 0.60700, 0.60800,
			0.61500, 0.61700, 0.62100, 0.62200, 0.61900,
			0.62500, 0.62800, 0.63000, 0.62700, 0.63500,
			0.63900, 0.64000
		}
	},
	/* 8 Purplish blue */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.09400, 0.11300, 0.14100, 0.18600, 0.23500,
			0.27500, 0.29700, 0.31600, 0.31700, 0.33300,
			0.34600, 0.35500, 0.36800, 0.37800, 0.38100,
			0.37700, 0.36800, 0.35600, 0.34000, 0.32200,
			0.29600, 0.26900, 0.24100, 0.22000, 0.19700,
			0.18200, 0.16600, 0.15100, 0.13800, 0.12700,
			0.12000, 0.11500, 0.10800, 0.10400, 0.10100,
			0.09500, 0.09000, 0.08400, 0.08200, 0.08100,
			0.08100, 0.08100, 0.08100, 0.08300, 0.08300,
			0.08000, 0.07900, 0.08000, 0.08100, 0.08100,
			0.08400, 0.08900, 0.09200, 0.09600, 0.10300,
			0.10700, 0.11200, 0.11100, 0.11200, 0.10900,
			0.10400, 0.10200, 0.09900, 0.09900, 0.10000,
			0.10000, 0.10300, 0.10600, 0.10900, 0.11300,
			0.12200, 0.12700, 0.13800, 0.15300, 0.17300,
			0.19300, 0.21500
		}
	},
	/* 9 Moderate red */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08800, 0.10200, 0.12100, 0.13600, 0.15100,
			0.15300, 0.15100, 0.14400, 0.14200, 0.14100,
			0.13900, 0.13500, 0.13600, 0.13500, 0.13300,
			0.13200, 0.12900, 0.13000, 0.12900, 0.12700,
			0.12100, 0.11800, 0.10900, 0.10500, 0.10500,
			0.10400, 0.10100, 0.10000, 0.09400, 0.09100,
			0.08900, 0.09200, 0.09500, 0.09700, 0.10400,
			0.10900, 0.11100, 0.11300, 0.11600, 0.13400,
			0.16700, 0.22300, 0.29100, 0.36200, 0.42600,
			0.47400, 0.51100, 0.53700, 0.55100, 0.56200,
			0.56500, 0.57000, 0.57500, 0.57400, 0.57900,
			0.57700, 0.57900, 0.57700, 0.58000, 0.58100,
			0.57900, 0.58100, 0.58100, 0.58300, 0.58100,
			0.58100, 0.58000, 0.58600, 0.58500, 0.58400,
			0.58900, 0.58700, 0.59000, 0.58200, 0.58900,
			0.59200, 0.59000
		}
	},
	/* 10 Purple */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08300, 0.10000, 0.12500, 0.15400, 0.18300,
			0.19800, 0.20600, 0.20700, 0.20700, 0.20100,
			0.19400, 0.18400, 0.17500, 0.16300, 0.15400,
			0.14200, 0.12900, 0.12000, 0.10900, 0.10200,
			0.09500, 0.09000, 0.08100, 0.07700, 0.07000,
			0.06700, 0.06500, 0.06300, 0.05900, 0.05800,
			0.05600, 0.05300, 0.05200, 0.05200, 0.05100,
			0.05300, 0.05500, 0.05600, 0.05400, 0.05200,
			0.05300, 0.04900, 0.05100, 0.05500, 0.05800,
			0.06300, 0.07300, 0.08700, 0.10300, 0.12000,
			0.13700, 0.14900, 0.16100, 0.17500, 0.18800,
			0.19700, 0.20800, 0.21800, 0.22900, 0.24100,
			0.24900, 0.26200, 0.27200, 0.28400, 0.29200,
			0.30400, 0.31200, 0.32500, 0.32900, 0.33300,
			0.34300, 0.34600, 0.35000, 0.35000, 0.35900,
			0.36000, 0.36200
		}
	},
	/* 11 Yellow green */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04500, 0.04800, 0.05000, 0.05000, 0.05400,
			0.05300, 0.05300, 0.05500, 0.05300, 0.05700,
			0.05900, 0.05900, 0.06200, 0.06500, 0.07000,
			0.07500, 0.08100, 0.09200, 0.10200, 0.11600,
			0.13600, 0.15800, 0.18500, 0.22500, 0.27400,
			0.32800, 0.39000, 0.44600, 0.48500, 0.51100,
			0.52900, 0.53800, 0.53900, 0.53500, 0.52600,
			0.52100, 0.51100, 0.50000, 0.48400, 0.46700,
			0.45000, 0.43500, 0.41200, 0.39500, 0.37700,
			0.36300, 0.35200, 0.34600, 0.33900, 0.33700,
			0.33700, 0.33100, 0.32600, 0.32200, 0.32300,
			0.32000, 0.32500, 0.32700, 0.33400, 0.34000,
			0.34700, 0.35500, 0.36200, 0.36900, 0.37300,
			0.37600, 0.37500, 0.37900, 0.37200, 0.36500,
			0.36700, 0.37500, 0.37900, 0.38800, 0.40300,
			0.41500, 0.43000
		}
	},
	/* 12 Orange yellow */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04900, 0.05200, 0.05400, 0.05500, 0.05400,
			0.05700, 0.05700, 0.05900, 0.05700, 0.05700,
			0.05900, 0.05700, 0.05800, 0.06000, 0.06100,
			0.06100, 0.06200, 0.06700, 0.07200, 0.08100,
			0.08800, 0.09800, 0.10600, 0.11200, 0.12000,
			0.13000, 0.14300, 0.16300, 0.18800, 0.21800,
			0.25600, 0.30400, 0.35100, 0.39900, 0.44200,
			0.47600, 0.50500, 0.53200, 0.54400, 0.56100,
			0.57900, 0.53900, 0.59700, 0.60400, 0.61700,
			0.61700, 0.61800, 0.62400, 0.62500, 0.63000,
			0.64700, 0.63500, 0.63800, 0.64200, 0.64900,
			0.65000, 0.64900, 0.65000, 0.67700, 0.65700,
			0.65300, 0.65900, 0.65800, 0.66200, 0.66100,
			0.66600, 0.66800, 0.67200, 0.67100, 0.66700,
			0.67700, 0.67800, 0.68200, 0.67800, 0.68600,
			0.69300, 0.69000
		}
	},
	/* 13 Blue */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.06800, 0.08400, 0.10400, 0.12700, 0.15600,
			0.17800, 0.19400, 0.20900, 0.22100, 0.23400,
			0.25000, 0.26400, 0.28700, 0.30800, 0.31800,
			0.32300, 0.31700, 0.30300, 0.27600, 0.25500,
			0.22500, 0.19300, 0.16000, 0.13900, 0.11700,
			0.10400, 0.08700, 0.07700, 0.06600, 0.06000,
			0.05600, 0.05300, 0.05000, 0.04700, 0.04500,
			0.04200, 0.04300, 0.04000, 0.04000, 0.03800,
			0.03800, 0.03700, 0.03600, 0.03700, 0.03800,
			0.03600, 0.03700, 0.03700, 0.03700, 0.03900,
			0.03900, 0.04200, 0.04000, 0.04200, 0.04400,
			0.04500, 0.04700, 0.04800, 0.05000, 0.04800,
			0.04600, 0.05000, 0.04800, 0.05100, 0.04900,
			0.05200, 0.05400, 0.05700, 0.06000, 0.06500,
			0.06900, 0.07600, 0.08700, 0.10200, 0.12300,
			0.14700, 0.17400
		}
	},
	/* 14 Green */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04500, 0.04800, 0.05400, 0.05400, 0.05700,
			0.05900, 0.06000, 0.06000, 0.06000, 0.06200,
			0.05400, 0.06400, 0.06900, 0.07000, 0.07500,
			0.07900, 0.08300, 0.09000, 0.09900, 0.10900,
			0.12000, 0.13200, 0.14400, 0.15800, 0.17500,
			0.19600, 0.23100, 0.27200, 0.30700, 0.33800,
			0.35200, 0.35700, 0.35300, 0.34100, 0.32300,
			0.30500, 0.28600, 0.26500, 0.24400, 0.22400,
			0.20300, 0.18000, 0.16100, 0.14400, 0.12400,
			0.10800, 0.09800, 0.08900, 0.08400, 0.08000,
			0.07600, 0.07500, 0.07100, 0.07100, 0.07000,
			0.06700, 0.06700, 0.06700, 0.06800, 0.07000,
			0.07000, 0.07400, 0.07600, 0.07900, 0.08000,
			0.08200, 0.08600, 0.08500, 0.08300, 0.08100,
			0.08100, 0.08100, 0.08300, 0.08600, 0.09100,
			0.09400, 0.09800
		}
	},
	/* 15 Red */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04300, 0.04500, 0.04600, 0.04500, 0.04700,
			0.04600, 0.04800, 0.04600, 0.04600, 0.04600,
			0.04800, 0.04400, 0.04600, 0.04700, 0.04700,
			0.04700, 0.04600, 0.04600, 0.04400, 0.04400,
			0.04000, 0.04200, 0.03900, 0.04000, 0.04000,
			0.03900, 0.04000, 0.04000, 0.03800, 0.03800,
			0.03900, 0.03800, 0.04000, 0.04000, 0.04100,
			0.04200, 0.04400, 0.04600, 0.04700, 0.05400,
			0.06400, 0.08100, 0.11200, 0.15600, 0.21600,
			0.28300, 0.35800, 0.43400, 0.49900, 0.54900,
			0.58500, 0.60700, 0.62400, 0.63300, 0.65000,
			0.65200, 0.65200, 0.65600, 0.66100, 0.66600,
			0.66400, 0.67100, 0.67100, 0.67700, 0.67300,
			0.67800, 0.68000, 0.68900, 0.68800, 0.68500,
			0.69100, 0.69400, 0.69600, 0.69200, 0.69800,
			0.70400, 0.70000
		}
	},
	/* 16 Yellow */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04700, 0.04700, 0.04800, 0.04700, 0.05000,
			0.05200, 0.05200, 0.05100, 0.05100, 0.05300,
			0.05300, 0.05300, 0.05700, 0.05600, 0.05800,
			0.06000, 0.06200, 0.06700, 0.07600, 0.09000,
			0.10900, 0.14200, 0.18300, 0.22800, 0.27400,
			0.31900, 0.36000, 0.40500, 0.44300, 0.47500,
			0.51000, 0.54400, 0.57100, 0.59400, 0.61200,
			0.63000, 0.64600, 0.65600, 0.66800, 0.67700,
			0.69100, 0.69600, 0.70100, 0.70200, 0.72900,
			0.70100, 0.70400, 0.70700, 0.70800, 0.71300,
			0.72100, 0.71600, 0.71700, 0.71800, 0.72600,
			0.72900, 0.73000, 0.72800, 0.74700, 0.73900,
			0.73700, 0.74300, 0.74000, 0.75600, 0.74200,
			0.74900, 0.75100, 0.75300, 0.75400, 0.75000,
			0.76000, 0.76200, 0.76900, 0.76200, 0.77400,
			0.77600, 0.77900
		}
	},
	/* 17 Magenta */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10600, 0.12900, 0.16800, 0.22900, 0.29700,
			0.34600, 0.36700, 0.37200, 0.37700, 0.37300,
			0.36200, 0.35100, 0.34000, 0.32300, 0.30600,
			0.29300, 0.27600, 0.25900, 0.25000, 0.23400,
			0.22000, 0.20600, 0.19000, 0.17900, 0.16900,
			0.16300, 0.15200, 0.14000, 0.12600, 0.11300,
			0.10400, 0.09800, 0.09800, 0.10200, 0.10400,
			0.10300, 0.10400, 0.10300, 0.10600, 0.11800,
			0.14000, 0.17000, 0.21200, 0.25700, 0.31300,
			0.35400, 0.40300, 0.45700, 0.50100, 0.54600,
			0.58700, 0.61200, 0.63700, 0.65500, 0.67700,
			0.68400, 0.69300, 0.69500, 0.71400, 0.71000,
			0.72000, 0.71500, 0.71400, 0.73900, 0.71900,
			0.72600, 0.72800, 0.73300, 0.73700, 0.73200,
			0.74300, 0.74200, 0.74800, 0.74100, 0.75300,
			0.75400, 0.76100
		}
	},
	/* 18 Cyan */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08500, 0.10200, 0.13000, 0.16300, 0.20100,
			0.22800, 0.24700, 0.25400, 0.26200, 0.27800,
			0.28200, 0.30000, 0.31900, 0.33200, 0.34800,
			0.36300, 0.38200, 0.40100, 0.41900, 0.43100,
			0.43800, 0.44100, 0.43800, 0.42900, 0.41500,
			0.40400, 0.38100, 0.35800, 0.33900, 0.31600,
			0.28800, 0.26200, 0.23600, 0.21000, 0.18600,
			0.16200, 0.14200, 0.12900, 0.11600, 0.10500,
			0.09900, 0.09200, 0.08800, 0.08600, 0.08100,
			0.07700, 0.07800, 0.07600, 0.07600, 0.07600,
			0.07600, 0.07600, 0.07600, 0.07700, 0.07800,
			0.07700, 0.08100, 0.08000, 0.08100, 0.07900,
			0.07900, 0.07900, 0.07700, 0.07600, 0.07500,
			0.07400, 0.07400, 0.07600, 0.07700, 0.08100,
			0.08400, 0.09000, 0.09800, 0.11100, 0.13000,
			0.15100, 0.17900
		}
	},
	/* 19 White */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.12600, 0.16900, 0.21200, 0.26400, 0.31800,
			0.49100, 0.66400, 0.75700, 0.85100, 0.86800,
			0.88700, 0.88800, 0.89000, 0.89300, 0.89500,
			0.89600, 0.89800, 0.90000, 0.90200, 0.90000,
			0.89700, 0.90400, 0.90100, 0.90000, 0.90000,
			0.89800, 0.89700, 0.90000, 0.90200, 0.90200,
			0.90100, 0.90000, 0.89900, 0.89600, 0.89300,
			0.89500, 0.89800, 0.90000, 0.90200, 0.90400,
			0.90500, 0.90600, 0.90700, 0.90500, 0.90300,
			0.90400, 0.90500, 0.90700, 0.89800, 0.89700,
			0.89600, 0.89800, 0.90000, 0.90000, 0.89900,
			0.90100, 0.90400, 0.90400, 0.90500, 0.90200,
			0.89900, 0.89900, 0.90000, 0.89900, 0.89800,
			0.89800, 0.89900, 0.89800, 0.89800, 0.89900,
			0.90100, 0.89800, 0.89600, 0.89500, 0.89800,
			0.89900, 0.89800
		}
	},
	/* 20 Neutral 8 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08400, 0.11300, 0.14100, 0.17600, 0.21100,
			0.32700, 0.44200, 0.50400, 0.56700, 0.57800,
			0.59000, 0.59100, 0.59200, 0.59400, 0.59500,
			0.59600, 0.59700, 0.59900, 0.60000, 0.59900,
			0.59700, 0.60200, 0.59900, 0.59900, 0.59900,
			0.59700, 0.59700, 0.59900, 0.60000, 0.60000,
			0.59900, 0.59900, 0.59800, 0.59600, 0.59400,
			0.59500, 0.59700, 0.59900, 0.60000, 0.60200,
			0.60200, 0.60300, 0.60400, 0.60200, 0.60100,
			0.60200, 0.60200, 0.60400, 0.59700, 0.59700,
			0.59600, 0.59700, 0.59900, 0.59900, 0.59800,
			0.59900, 0.60200, 0.60200, 0.60200, 0.60000,
			0.59800, 0.59800, 0.59900, 0.59800, 0.59700,
			0.59700, 0.59800, 0.59700, 0.59700, 0.59800,
			0.59900, 0.59700, 0.59600, 0.59500, 0.59700,
			0.59800, 0.59700
		}
	},
	/* 21 Neutral 6.5 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05100, 0.06800, 0.08500, 0.10600, 0.12800,
			0.19800, 0.26700, 0.30500, 0.34200, 0.34900,
			0.35700, 0.35700, 0.35800, 0.35900, 0.36000,
			0.36000, 0.36100, 0.36200, 0.36300, 0.36200,
			0.36100, 0.36400, 0.36200, 0.36200, 0.36200,
			0.36100, 0.36100, 0.36200, 0.36300, 0.36300,
			0.36200, 0.36200, 0.36100, 0.36000, 0.35900,
			0.36000, 0.36100, 0.36200, 0.36300, 0.36400,
			0.36400, 0.36400, 0.36500, 0.36400, 0.36300,
			0.36400, 0.36400, 0.36500, 0.36100, 0.36100,
			0.36000, 0.36100, 0.36200, 0.36200, 0.36100,
			0.36200, 0.36400, 0.36400, 0.36400, 0.36300,
			0.36100, 0.36100, 0.36200, 0.36100, 0.36100,
			0.36100, 0.36100, 0.36100, 0.36100, 0.36100,
			0.36200, 0.36100, 0.36000, 0.36000, 0.36100,
			0.36100, 0.36100
		}
	},
	/* 22 Neutral 5 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.02770, 0.03720, 0.04650, 0.05800, 0.06980,
			0.10790, 0.14570, 0.16630, 0.18690, 0.19070,
			0.19470, 0.19490, 0.19540, 0.19600, 0.19650,
			0.19670, 0.19710, 0.19760, 0.19800, 0.19760,
			0.19690, 0.19850, 0.19780, 0.19760, 0.19760,
			0.19710, 0.19690, 0.19760, 0.19800, 0.19800,
			0.19780, 0.19760, 0.19740, 0.19670, 0.19600,
			0.19650, 0.19710, 0.19760, 0.19800, 0.19850,
			0.19870, 0.19890, 0.19910, 0.19870, 0.19820,
			0.19850, 0.19870, 0.19910, 0.19710, 0.19690,
			0.19670, 0.19710, 0.19760, 0.19760, 0.19740,
			0.19780, 0.19850, 0.19850, 0.19870, 0.19800,
			0.19740, 0.19740, 0.19760, 0.19740, 0.19710,
			0.19710, 0.19740, 0.19710, 0.19710, 0.19740,
			0.19780, 0.19710, 0.19670, 0.19650, 0.19710,
			0.19740, 0.19710
		}
	},
	/* 23 Neutral 3.5 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.01260, 0.01690, 0.02120, 0.02640, 0.03180,
			0.04910, 0.06640, 0.07570, 0.08510, 0.08680,
			0.08860, 0.08870, 0.08890, 0.08930, 0.08950,
			0.08960, 0.08980, 0.09000, 0.09020, 0.09000,
			0.08970, 0.09040, 0.09010, 0.09000, 0.09000,
			0.08980, 0.08970, 0.09000, 0.09020, 0.09020,
			0.09010, 0.09000, 0.08990, 0.08960, 0.08930,
			0.08950, 0.08980, 0.09000, 0.09020, 0.09040,
			0.09050, 0.09060, 0.09070, 0.09050, 0.09030,
			0.09040, 0.09050, 0.09070, 0.08980, 0.08970,
			0.08960, 0.08980, 0.09000, 0.09000, 0.08990,
			0.09010, 0.09040, 0.09040, 0.09050, 0.09020,
			0.08990, 0.08990, 0.09000, 0.08990, 0.08980,
			0.08980, 0.08990, 0.08980, 0.08980, 0.08990,
			0.09010, 0.08980, 0.08960, 0.08950, 0.08980,
			0.08990, 0.08980
		}
	},
	/* 24 Black */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.00439, 0.00589, 0.00737, 0.00919, 0.01105,
			0.01708, 0.02308, 0.02635, 0.02961, 0.03020,
			0.03084, 0.03087, 0.03094, 0.03105, 0.03112,
			0.03115, 0.03122, 0.03129, 0.03136, 0.03129,
			0.03119, 0.03143, 0.03133, 0.03129, 0.03129,
			0.03122, 0.03119, 0.03129, 0.03136, 0.03136,
			0.03133, 0.03129, 0.03126, 0.03115, 0.03105,
			0.03112, 0.03122, 0.03129, 0.03136, 0.03143,
			0.03147, 0.03150, 0.03154, 0.03147, 0.03140,
			0.03143, 0.03147, 0.03154, 0.03122, 0.03119,
			0.03115, 0.03122, 0.03129, 0.03129, 0.03126,
			0.03133, 0.03143, 0.03143, 0.03147, 0.03136,
			0.03126, 0.03126, 0.03129, 0.03126, 0.03122,
			0.03122, 0.03126, 0.03122, 0.03122, 0.03126,
			0.03133, 0.03122, 0.03115, 0.03112, 0.03122,
			0.03126, 0.03122
		}
	}
};

/*    https://law.resource.org/pub/us/cfr/ibr/003/cie.15.2004.tables.xls
   CIE 1931 standard coloriometric observer
   bands from 380 to 780 by 5nm steps.  */
const spectrum cie_cmf_x = {
  0.001368, 0.002236, 0.004243, 0.007650, 0.014310, 0.023190, 0.043510, 0.077630, 0.134380,
  0.214770, 0.283900, 0.328500, 0.348280, 0.348060, 0.336200, 0.318700, 0.290800, 0.251100,
  0.195360, 0.142100, 0.095640, 0.057950, 0.032010, 0.014700, 0.004900, 0.002400, 0.009300,
  0.029100, 0.063270, 0.109600, 0.165500, 0.225750, 0.290400, 0.359700, 0.433450, 0.512050,
  0.594500, 0.678400, 0.762100, 0.842500, 0.916300, 0.978600, 1.026300, 1.056700, 1.062200,
  1.045600, 1.002600, 0.938400, 0.854450, 0.751400, 0.642400, 0.541900, 0.447900, 0.360800,
  0.283500, 0.218700, 0.164900, 0.121200, 0.087400, 0.063600, 0.046770, 0.032900, 0.022700,
  0.015840, 0.011359, 0.008111, 0.005790, 0.004109, 0.002899, 0.002049, 0.001440, 0.001000,
  0.000690, 0.000476, 0.000332, 0.000235, 0.000166, 0.000117, 0.000083, 0.000059, 0.000042,
};
const spectrum cie_cmf_y = {
  0.000039, 0.000064, 0.000120, 0.000217, 0.000396, 0.000640, 0.001210, 0.002180, 0.004000,
0.007300, 0.011600, 0.016840, 0.023000, 0.029800, 0.038000, 0.048000, 0.060000, 0.073900,
0.090980, 0.112600, 0.139020, 0.169300, 0.208020, 0.258600, 0.323000, 0.407300, 0.503000,
0.608200, 0.710000, 0.793200, 0.862000, 0.914850, 0.954000, 0.980300, 0.994950, 1.000000,
0.995000, 0.978600, 0.952000, 0.915400, 0.870000, 0.816300, 0.757000, 0.694900, 0.631000,
0.566800, 0.503000, 0.441200, 0.381000, 0.321000, 0.265000, 0.217000, 0.175000, 0.138200,
0.107000, 0.081600, 0.061000, 0.044580, 0.032000, 0.023200, 0.017000, 0.011920, 0.008210,
0.005723, 0.004102, 0.002929, 0.002091, 0.001484, 0.001047, 0.000740, 0.000520, 0.000361,
0.000249, 0.000172, 0.000120, 0.000085, 0.000060, 0.000042, 0.000030, 0.000021, 0.000015,

};
const spectrum cie_cmf_z = {
  0.006450, 0.010550, 0.020050, 0.036210, 0.067850, 0.110200, 0.207400, 0.371300, 0.645600,
1.039050, 1.385600, 1.622960, 1.747060, 1.782600, 1.772110, 1.744100, 1.669200, 1.528100,
1.287640, 1.041900, 0.812950, 0.616200, 0.465180, 0.353300, 0.272000, 0.212300, 0.158200,
0.111700, 0.078250, 0.057250, 0.042160, 0.029840, 0.020300, 0.013400, 0.008750, 0.005750,
0.003900, 0.002750, 0.002100, 0.001800, 0.001650, 0.001400, 0.001100, 0.001000, 0.000800,
0.000600, 0.000340, 0.000240, 0.000190, 0.000100, 0.000050, 0.000030, 0.000020, 0.000010,
0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
};

const spectrum cie_cmf1964_x = {
  0.000160, 0.000662, 0.002362, 0.007242, 0.019110, 0.043400, 0.084736, 0.140638, 0.204492,
  0.264737, 0.314679, 0.357719, 0.383734, 0.386726, 0.370702, 0.342957, 0.302273, 0.254085,
  0.195618, 0.132349, 0.080507, 0.041072, 0.016172, 0.005132, 0.003816, 0.015444, 0.037465,
  0.071358, 0.117749, 0.172953, 0.236491, 0.304213, 0.376772, 0.451584, 0.529826, 0.616053,
  0.705224, 0.793832, 0.878655, 0.951162, 1.014160, 1.074300, 1.118520, 1.134300, 1.123990,
  1.089100, 1.030480, 0.950740, 0.856297, 0.754930, 0.647467, 0.535110, 0.431567, 0.343690,
  0.268329, 0.204300, 0.152568, 0.112210, 0.081261, 0.057930, 0.040851, 0.028623, 0.019941,
  0.013842, 0.009577, 0.006605, 0.004553, 0.003145, 0.002175, 0.001506, 0.001045, 0.000727,
  0.000508, 0.000356, 0.000251, 0.000178, 0.000126, 0.000090, 0.000065, 0.000046, 0.000033,
};
const spectrum cie_cmf1964_y = {
  0.000017, 0.000072, 0.000253, 0.000769, 0.002004, 0.004509, 0.008756, 0.014456, 0.021391,
  0.029497, 0.038676, 0.049602, 0.062077, 0.074704, 0.089456, 0.106256, 0.128201, 0.152761,
  0.185190, 0.219940, 0.253589, 0.297665, 0.339133, 0.395379, 0.460777, 0.531360, 0.606741,
  0.685660, 0.761757, 0.823330, 0.875211, 0.923810, 0.961988, 0.982200, 0.991761, 0.999110,
  0.997340, 0.982380, 0.955552, 0.915175, 0.868934, 0.825623, 0.777405, 0.720353, 0.658341,
  0.593878, 0.527963, 0.461834, 0.398057, 0.339554, 0.283493, 0.228254, 0.179828, 0.140211,
  0.107633, 0.081187, 0.060281, 0.044096, 0.031800, 0.022602, 0.015905, 0.011130, 0.007749,
  0.005375, 0.003718, 0.002565, 0.001768, 0.001222, 0.000846, 0.000586, 0.000407, 0.000284,
  0.000199, 0.000140, 0.000098, 0.000070, 0.000050, 0.000036, 0.000025, 0.000018, 0.000013,
};
const spectrum cie_cmf1964_z = {
  0.000705, 0.002928, 0.010482, 0.032344, 0.086011, 0.197120, 0.389366, 0.656760, 0.972542,
  1.282500, 1.553480, 1.798500, 1.967280, 2.027300, 1.994800, 1.900700, 1.745370, 1.554900,
  1.317560, 1.030200, 0.772125, 0.570060, 0.415254, 0.302356, 0.218502, 0.159249, 0.112044,
  0.082248, 0.060709, 0.043050, 0.030451, 0.020584, 0.013676, 0.007918, 0.003988, 0.001091,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
};

namespace {

/* from Argyll 107 bands from 300 to 830 nm in 5nm steps
   CIE 15.2-1986 Table 1.1
   Part 1: CIE Standard Illuminant A relative spectral power distribution
   This is a 2848K tungsten filament lamp (Acording to the old temperature scale)
   and 2856 according to the newer temerature scale. */

static const luminosity_t il_A[] = {
  0.930483, 1.128210, 1.357690, 1.622190, 1.925080,
  2.269800, 2.659810, 3.098610, 3.589680, 4.136480,
  4.742380, 5.410700, 6.144620, 6.947200, 7.821350,
  8.769800, 9.795100, 10.899600, 12.085300, 13.354300,
  14.708000, 16.148000, 17.675300, 19.290700, 20.995000,
  22.788300, 24.670900, 26.642500, 28.702700, 30.850800,
  33.085900, 35.406800, 37.812100, 40.300200, 42.869300,
  45.517400, 48.242300, 51.041800, 53.913200, 56.853900,
  59.861100, 62.932000, 66.063500, 69.252500, 72.495900,
  75.790300, 79.132600, 82.519300, 85.947000, 89.412400,
  92.912000, 96.442300, 100.000000, 103.582000, 107.184000,
  110.803000, 114.436000, 118.080000, 121.731000, 125.386000,
  129.043000, 132.697000, 136.346000, 139.988000, 143.618000,
  147.235000, 150.836000, 154.418000, 157.979000, 161.516000,
  165.028000, 168.510000, 171.963000, 175.383000, 178.769000,
  182.118000, 185.429000, 188.701000, 191.931000, 195.118000,
  198.261000, 201.359000, 204.409000, 207.411000, 210.365000,
  213.268000, 216.120000, 218.920000, 221.667000, 224.361000,
  227.000000, 229.585000, 232.115000, 234.589000, 237.008000,
  239.370000, 241.675000, 243.924000, 246.116000, 248.251000,
  250.329000, 252.350000, 254.314000, 256.221000, 258.071000,
  259.865000, 261.602000
};
//   Illuminant B at 5nm interval Wyszecki & Stiles Color Science, 2nd edition.  Table II(3.3.4)  pp. 759.
//   Simulated direct sunlight, obsolette.
static const luminosity_t il_B[] = {
  0.02, 0.26, 0.50, 1.45, 2.40, 4.00, 5.60, 7.60, 9.6,
  12.4, 15.2, 18.8, 22.4, 26.85, 31.3, 36.18, 41.3, 46.62,
  52.1, 57.7, 63.2, 68.37, 73.1, 77.31, 80.8, 83.44, 85.4,
  86.88, 88.3, 90.08, 92, 93.75, 95.2, 96.23, 96.5, 95.71,
  94.2, 92.37, 90.7, 89.65, 89.5, 90.43, 92.2, 94.46, 96.9,
  99.16, 101, 102.2, 102.8, 102.92, 102.6, 101.9, 101, 100.07,
  99.2, 98.44, 98, 98.08, 98.5, 99.06, 99.7, 100.36, 101,
  101.56, 102.2, 103.05, 103.9, 104.59, 105, 105.08, 104.9, 104.55,
  103.9, 102.84, 101.6, 100.38, 99.1, 97.7, 96.2, 94.6, 92.9,
  91.1, 89.4, 88, 86.9, 85.9, 85.2, 84.8, 84.7, 84.9,
  85.4, 86.1, 87.0,
};


/* From Argyll. 93 bands from 320.0 to 780.0 */
/* CIE 15.2-1986 Table 1.1 */
/* Part 1: CIE Standard Illuminant C relative spectral power distribution */
/* This is a CIE Illuminant A combined with a filter to simulate daylight. */
static const luminosity_t il_C[] = {
	0.01,   0.20,   0.40,   1.55,   2.70,   4.85,   7.00,   9.95,   12.90,  17.20, 
	21.40,  27.50,  33.00,  39.92,  47.40,  55.17,  63.30,  71.81,  80.60,  89.53,
	98.10,  105.80, 112.40, 117.75, 121.50, 123.45, 124.00, 123.60, 123.10, 123.30,
	123.80, 124.09, 123.90, 122.92, 120.70, 116.90, 112.10, 106.98, 102.30, 98.81,
	96.90,  96.78,  98.00,  99.94,  102.10, 103.95, 105.20, 105.67, 105.30, 104.11,
	102.30, 100.15, 97.80,  95.43,  93.20,  91.22,  89.70,  88.83,  88.40,  88.19,
	88.10,  88.06,  88.00,  87.86,  87.80,  87.99,  88.20,  88.20,  87.90,  87.22,
	86.30,  85.30,  84.00,  82.21,  80.20,  78.24,  76.30,  74.36,  72.40,  70.40,
	68.30,  66.30,  64.40,  62.80,  61.50,  60.20,  59.20,  58.50,  58.10,  58.00,
	58.20,  58.50,  59.10
};

static luminosity_t
transmitance_to_absorbance (luminosity_t t)
{
  return 2 - log10 (t);
}

static luminosity_t
absorbance_to_transmitance (luminosity_t a)
{
  return pow (10, 2 - a);
}


/* Output gnuplottable data.  */
static void
print_transmitance_spectrum (FILE * out, const spectrum spec, int start = SPECTRUM_START, int end = SPECTRUM_END)
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    if (i * SPECTRUM_STEP + SPECTRUM_START >= start && i * SPECTRUM_STEP + SPECTRUM_START <= end)
      {
	fprintf (out, "%i %f\n", i * SPECTRUM_STEP + SPECTRUM_START, spec[i]);
	//assert (spec[i] > -100 && spec [i] < 100);
      }
}

static void
print_absorbance_spectrum (FILE * out, const spectrum spec)
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    fprintf (out, "%i %f\n", i * SPECTRUM_STEP + SPECTRUM_START,
	     transmitance_to_absorbance (spec[i]));
}

struct spectra_entry
{
  coord_t wavelength;
  coord_t transmitance;
};

// transmitance charts with iregular step
const static spectra_entry autochrome_violet[] = {
  {393.5, 0.127095 }, 
  {405.5, 0.1566675}, 
  {418  , 0.169205 }, 
  {430.5, 0.1837325}, 
  {442  , 0.1938125}, 
  {458.5, 0.211625 }, 
  {469  , 0.21933  }, 
  {482  , 0.218295 }, 
  {497  , 0.1910525}, 
  {512  , 0.1400325}, 
  {526.5, 0.0923225}, 
  {540.5, 0.06805  }, 
  {553  , 0.056125 }, 
  {567.5, 0.0512375}, 
  {581.5, 0.0581   }, 
  {599  , 0.074075 }, 
  {613.5, 0.10036  }, 
  {630  , 0.1587275}, 
  {642.5, 0.2249375}, 
  {660  , 0.34685  }, 
  {674  , 0.453125 }, 
  {687  , 0.532825 },
  {702.5, 0.596525 }, 
  {717.5, 0.6243   }, 
  {729  , 0.631325 }
};

const static spectra_entry autochrome_green[] =
{
  {393.5, 0.0169965 }, 
  {405.5, 0.013315  }, 
  {418  , 0.01199775}, 
  {430.5, 0.01231825}, 
  {442  , 0.01352325}, 
  {458.5, 0.018713  }, 
  {469  , 0.02652   }, 
  {482  , 0.0556475 }, 
  {497  , 0.1408075 }, 
  {512  , 0.257125  }, 
  {526.5, 0.28885   }, 
  {540.5, 0.250425  }, 
  {553  , 0.1931475 }, 
  {567.5, 0.1177475 }, 
  {581.5, 0.07777   }, 
  {599  , 0.05971   }, 
  {613.5, 0.054905  }, 
  {630  , 0.056885  }, 
  {642.5, 0.0627625 }, 
  {660  , 0.08448   }, 
  {674  , 0.1544125 }, 
  {687  , 0.299875  },
  {702.5, 0.49825   }, 
  {717.5, 0.604925  }, 
  {729  , 0.64265   }
};

const static spectra_entry autochrome_orange[] =
{
  {393.5, 0.020332 }, 
  {405.5, 0.0154836}, 
  {418  , 0.0136168}, 
  {430.5, 0.013252 }, 
  {442  , 0.0139408}, 
  {458.5, 0.0169314}, 
  {469  , 0.0198558}, 
  {482  , 0.0243   }, 
  {497  , 0.029428 }, 
  {512  , 0.032502 }, 
  {526.5, 0.03029  }, 
  {540.5, 0.028432 }, 
  {553  , 0.042744 }, 
  {567.5, 0.155518 }, 
  {581.5, 0.3822   }, 
  {599  , 0.5858   }, 
  {613.5, 0.62472  }, 
  {630  , 0.64806  }, 
  {642.5, 0.65596  }, 
  {660  , 0.67084  }, 
  {674  , 0.67944  }, 
  {687  , 0.69568  },
  {702.5, 0.71826  }, 
  {717.5, 0.7292   }, 
  {729  , 0.72862  }
};
/* Dufay_measuredODs_DC_MSI_NSMM11948.xlsx
 * NSMM, Bradford  - 11948*/
const static spectra_entry real_dufay_red[] = {
  {399.8, 1.6927},
  {415, 1.7791},
  {431.4, 2.0204},
  {448.6, 2.1196},
  {465, 1.9656},
  {479.6, 1.8325},
  {495, 1.8215},
  {511.6, 1.8198},
  {528, 1.918},
  {544.6, 2.0032},
  {559.8, 1.6813},
  {575.8, 0.95527},
  {591.8, 0.61793},
  {607.8, 0.53945},
  {624.4, 0.52953},
  {640, 0.51923},
  {655.4, 0.49664},
  {671.8, 0.46236},
  {688.4, 0.43002},
  {704, 0.40052},
  {719.8, 0.3778}
};

const static spectra_entry real_dufay_green[] = {
  {399.8, 1.6847},
  {415, 1.8519},
  {431.4, 2.1937},
  {448.6, 2.3151},
  {465, 2.0288},
  {479.6, 1.3976},
  {495, 0.89105},
  {511.6, 0.67346},
  {528, 0.68622},
  {544.6, 0.75878},
  {559.8, 0.8529},
  {575.8, 1.0047},
  {591.8, 1.2232},
  {607.8, 1.4468},
  {624.4, 1.5554},
  {640, 1.6181},
  {655.4, 1.6121},
  {671.8, 1.4628},
  {688.4, 1.1606},
  {704, 0.77729},
  {719.8, 0.53417}
};

const static spectra_entry real_dufay_blue[] = {
  {399.8, 1.0481},
  {415, 0.97954},
  {431.4, 1.0399},
  {448.6, 1.1047},
  {465, 1.0588},
  {479.6, 0.94428},
  {495, 0.88739},
  {511.6, 0.9773},
  {528, 1.2357},
  {544.6, 1.5597},
  {559.8, 1.792},
  {575.8, 1.869},
  {591.8, 1.8027},
  {607.8, 1.7517},
  {624.4, 1.7054},
  {640, 1.6319},
  {655.4, 1.4618},
  {671.8, 1.1179},
  {688.4, 0.8054},
  {704, 0.59388},
  {719.8, 0.474}
};

/* Dufay_measuredODs_DC_MSI_NSMM11951.xlsx
   NSMM, Bradford  - 11951 */
const static spectra_entry real_dufay_red2[] = {
  {399.8, 1.8533},
  {415, 1.968},
  {431.4, 2.152},
  {448.6, 2.1629},
  {465, 1.9818},
  {479.6, 1.8919},
  {495, 1.8868},
  {511.6, 1.8915},
  {528, 1.9458},
  {544.6, 2.0081},
  {559.8, 1.8989},
  {575.8, 1.2803},
  {591.8, 0.90078},
  {607.8, 0.81549},
  {624.4, 0.8354},
  {640, 0.84269},
  {655.4, 0.7865},
  {671.8, 0.70112},
  {688.4, 0.64347},
  {704, 0.61199},
  {719.8, 0.61987}
};

const static spectra_entry real_dufay_green2[] = {
  {399.8, 1.4331},
  {415, 1.513},
  {431.4, 1.6304},
  {448.6, 1.5451},
  {465, 1.2448},
  {479.6, 0.95866},
  {495, 0.77296},
  {511.6, 0.70791},
  {528, 0.72691},
  {544.6, 0.77999},
  {559.8, 0.85564},
  {575.8, 0.98678},
  {591.8, 1.1519},
  {607.8, 1.2991},
  {624.4, 1.4954},
  {640, 1.6041},
  {655.4, 1.4168},
  {671.8, 0.9952},
  {688.4, 0.69584},
  {704, 0.55954},
  {719.8, 0.52881}
};

const static spectra_entry real_dufay_blue2[] = {
  {399.8, 1.0851 },
  {415  , 1.0968 },
  {431.4, 1.1751 },
  {448.6, 1.221  },
  {465  , 1.1737 },
  {479.6, 1.1266 },
  {495  , 1.0915 },
  {511.6, 1.151  },
  {528  , 1.323  },
  {544.6, 1.5472 },
  {559.8, 1.7401 },
  {575.8, 1.8799 },
  {591.8, 1.9253 },
  {607.8, 1.9434 },
  {624.4, 1.9692 },
  {640  , 1.9159 },
  {655.4, 1.6896 },
  {671.8, 1.2867 },
  {688.4, 0.95971},
  {704  , 0.75514},
  {719.8, 0.66195}
};



/* Dufay_measuredODs_DC_MSI_NSMM11960.xlsx
   NSMM, Bradford  - 11960 */
const static spectra_entry real_dufay_red3[] = {
  {399.8, 1.7223 },
  {415  , 1.8139 },
  {431.4, 1.978  },
  {448.6, 1.9971 },
  {465  , 1.877  },
  {479.6, 1.7589 },
  {495  , 1.7396 },
  {511.6, 1.7447 },
  {528  , 1.797  },
  {544.6, 1.8695 },
  {559.8, 1.8032 },
  {575.8, 1.2207 },
  {591.8, 0.83176},
  {607.8, 0.74176},
  {624.4, 0.75947},
  {640  , 0.76662},
  {655.4, 0.70403},
  {671.8, 0.60837},
  {688.4, 0.54681},
  {704  , 0.5134 },
  {719.8, 0.47837}
};

const static spectra_entry real_dufay_green3[] = {
  {399.8, 1.3607 },
  {415  , 1.4427 },
  {431.4, 1.5687 },
  {448.6, 1.5079 },
  {465  , 1.2667 },
  {479.6, 0.95143},
  {495  , 0.77167},
  {511.6, 0.71681},
  {528  , 0.73318},
  {544.6, 0.78763},
  {559.8, 0.86442},
  {575.8, 0.99519},
  {591.8, 1.1528 },
  {607.8, 1.2903 },
  {624.4, 1.4726 },
  {640  , 1.5766 },
  {655.4, 1.3989 },
  {671.8, 0.98751},
  {688.4, 0.68867},
  {704  , 0.54908},
  {719.8, 0.47378}
};

const static spectra_entry real_dufay_blue3[] = {
  {399.8, 1.0618 },
  {415  , 1.0929 },
  {431.4, 1.1928 },
  {448.6, 1.2557 },
  {465  , 1.2389 },
  {479.6, 1.1284 },
  {495  , 1.0716 },
  {511.6, 1.1087 },
  {528  , 1.2352 },
  {544.6, 1.417  },
  {559.8, 1.589  },
  {575.8, 1.7311 },
  {591.8, 1.7831 },
  {607.8, 1.8115 },
  {624.4, 1.8573 },
  {640  , 1.8365 },
  {655.4, 1.6414 },
  {671.8, 1.2555 },
  {688.4, 0.93111},
  {704  , 0.7315 },
  {719.8, 0.60242}
};

/* Dufay_measuredODs_DC_MSI_NSMM11967.xlsx
   NSMM, Bradford  - 11960 (probably Spicer Dufay) */
const static spectra_entry real_dufay_red4[] = {
  {399.8, 1.4999 },
  {415  , 1.5488 },
  {431.4, 1.6861 },
  {448.6, 1.6924 },
  {465  , 1.5851 },
  {479.6, 1.5783 },
  {495  , 1.7847 },
  {511.6, 2.0285 },
  {528  , 2.243  },
  {544.6, 2.157  },
  {559.8, 1.5352 },
  {575.8, 1.0201 },
  {591.8, 0.82265},
  {607.8, 0.78033},
  {624.4, 0.83171},
  {640  , 0.88678},
  {655.4, 0.81072},
  {671.8, 0.62652},
  {688.4, 0.46347},
  {704  , 0.37381},
  {719.8, 0.33736}
};

const static spectra_entry real_dufay_green4[] = {
  {399.8, 1.589  },
  {415  , 1.7027 },
  {431.4, 1.8468 },
  {448.6, 1.7037 },
  {465  , 1.3414 },
  {479.6, 0.95984},
  {495  , 0.74934},
  {511.6, 0.69904},
  {528  , 0.75442},
  {544.6, 0.79839},
  {559.8, 0.85828},
  {575.8, 0.99681},
  {591.8, 1.2175 },
  {607.8, 1.4319 },
  {624.4, 1.7052 },
  {640  , 1.8639 },
  {655.4, 1.6296 },
  {671.8, 1.0919 },
  {688.4, 0.67033},
  {704  , 0.45825},
  {719.8, 0.38017}
};

const static spectra_entry real_dufay_blue4[] = {
  {399.8, 1.2124 },
  {415  , 1.2054 },
  {431.4, 1.2408 },
  {448.6, 1.1804 },
  {465  , 1.0732 },
  {479.6, 1      },
  {495  , 1.0586 },
  {511.6, 1.3329 },
  {528  , 1.7472 },
  {544.6, 2.0362 },
  {559.8, 2.0575 },
  {575.8, 2.0652 },
  {591.8, 2.0709 },
  {607.8, 2.0721 },
  {624.4, 2.0752 },
  {640  , 1.9618 },
  {655.4, 1.5912 },
  {671.8, 1.0474 },
  {688.4, 0.67086},
  {704  , 0.46989},
  {719.8, 0.37775}
};
























/* Dufay_measuredODs_DC_MSI_NSMM12075.xlsx
   Spicer-Dufay NSMM, Bradford  - 12075 (probably Spicer Dufay) */
const static spectra_entry real_dufay_red5[] = {
  {399.8, 0.73443 },
  {415  , 0.72961 },
  {431.4, 0.79942 },
  {448.6, 0.86928 },
  {465  , 0.90753 },
  {479.6, 1.0464  },
  {495  , 1.2993  },
  {511.6, 1.5107  },
  {528  , 1.6803  },
  {544.6, 1.5851  },
  {559.8, 1.0156  },
  {575.8, 0.51808 },
  {591.8, 0.33356 },
  {607.8, 0.29447 },
  {624.4, 0.31872 },
  {640  , 0.33544 },
  {655.4, 0.29066 },
  {671.8, 0.19609 },
  {688.4, 0.11962 },
  {704  , 0.078058},
  {719.8, 0.063112}
};

const static spectra_entry real_dufay_green5[] = {
  {399.8, 0.742   },
  {415  , 0.80711 },
  {431.4, 0.88456 },
  {448.6, 0.81187 },
  {465  , 0.60816 },
  {479.6, 0.40745 },
  {495  , 0.30496 },
  {511.6, 0.29288 },
  {528  , 0.33324 },
  {544.6, 0.36014 },
  {559.8, 0.38578 },
  {575.8, 0.48257 },
  {591.8, 0.63152 },
  {607.8, 0.79237 },
  {624.4, 1.0142  },
  {640  , 1.1369  },
  {655.4, 0.95171 },
  {671.8, 0.55545 },
  {688.4, 0.26571 },
  {704  , 0.12767 },
  {719.8, 0.079921}
};


const static spectra_entry real_dufay_blue5[] = {
  {399.8, 0.54229 },
  {415  , 0.52097 },
  {431.4, 0.56026 },
  {448.6, 0.58749 },
  {465  , 0.57181 },
  {479.6, 0.5746  },
  {495  , 0.65477 },
  {511.6, 0.88583 },
  {528  , 1.2167  },
  {544.6, 1.4602  },
  {559.8, 1.5044  },
  {575.8, 1.4776  },
  {591.8, 1.4719  },
  {607.8, 1.4672  },
  {624.4, 1.4474  },
  {640  , 1.3245  },
  {655.4, 1.0359  },
  {671.8, 0.63761 },
  {688.4, 0.3646  },
  {704  , 0.21458 },
  {719.8, 0.14175 }
};

/* Chart from Dufaycolor manual called "Transmission of Dufaycolor Reseau"  */
const static spectra_entry manual_dufay_red[] = {
  {399.5091807909605, 0},
  {569.7132768361582, 0},
  {572.970338983051, 0.129613559322034},
  {578.2210451977402, 0.26511779661016965},
  {583.4795197740114, 0.3830686440677966},
  {591.5275423728815, 0.49775677966101695},
  {599.5833333333334, 0.5948915254237288},
  {607.917372881356, 0.6632957627118643},
  {615.1942090395481, 0.7205567796610168},
  {623.1419491525425, 0.7618432203389829},
  {633.7478813559322, 0.7966788135593219},
  {646.2266949152543, 0.7995516949152541},
  {659.9081920903955, 0.7848406779661017},
  {668.2810734463278, 0.7654779661016948},
  {680.3792372881356, 0.7284669491525423},
  {688.2238700564972, 0.7027347457627118},
  {700.0614406779662, 0.6545601694915253}
};

const static spectra_entry manual_dufay_green[] = {
  {400, 0},
  {466.8912429378532, 0},
  {472.81214689265545, 0.24706440677966102},
  {479.6610169491526, 0.37135762711864406},
  {486.781779661017, 0.4812822033898305},
  {494.30790960451986, 0.5752389830508475},
  {501.84039548022605, 0.6548338983050848},
  {508.983757062147, 0.7136940677966102},
  {515.7316384180791, 0.7661813559322033},
  {523.2810734463277, 0.8074779661016949},
  {530.8453389830509, 0.8152635593220339},
  {538.8185028248588, 0.7991025423728813},
  {546.6638418079096, 0.7717745762711864},
  {553.9844632768362, 0.7300983050847457},
  {560.3742937853108, 0.6916372881355932},
  {567.5649717514125, 0.6435813559322033},
  {572.7620056497176, 0.6003635593220339},
  {578.7570621468927, 0.5539338983050848},
  {586.0833333333334, 0.4994915254237289},
  {592.7478813559322, 0.4402788135593221},
  {600.0833333333334, 0.3650915254237288},
  {608.3559322033899, 0.2723271186440679},
  {613.9597457627119, 0.20995000000000008},
  {620.3679378531074, 0.12999915254237315},
  {627.0437853107345, 0.04525423728813571},
  {631.5854519774011, -0.017095762711864193},
  {700.8891242937854, -0.015673728813559107}
};

const static spectra_entry manual_dufay_blue[] = {
  {399.4329096045198, 0.7547889830508474},
  {409.1165254237289, 0.7736906779661016},
  {418.2718926553673, 0.7862228813559321},
  {426.7655367231639, 0.7939847457627118},
  {433.93432203389835, 0.7953974576271186},
  {442.83050847457633, 0.7935745762711864},
  {451.8622881355933, 0.7853652542372881},
  {460.23305084745766, 0.7707898305084745},
  {467.5430790960453, 0.7530499999999999},
  {474.85451977401135, 0.7321186440677966},
  {482.03531073446334, 0.7064033898305085},
  {489.61864406779665, 0.6711033898305085},
  {496.6723163841808, 0.6326254237288136},
  {503.7309322033899, 0.5829771186440678},
  {509.99788135593224, 0.5221788135593222},
  {514.9343220338983, 0.46779745762711866},
  {520.2740112994351, 0.4022355932203392},
  {524.9526836158193, 0.33030762711864425},
  {530.1737288135594, 0.2328338983050846},
  {534.4639830508476, 0.1385754237288137},
  {536.75, 0.07309152542372899},
  {538.7803672316385, 0},
  {701.1546610169491, 0}
};

/* Old readout from deformed scan.  */
#if 0
/* Chart from Color Cinematography, third edition (1951)  */
const static spectra_entry color_cinematography_dufay_red[] = {
  {399.8642759485018, 0},
  {431.38230602711633,0},
  {453.6759428050587, 0},
  {460.2329953287, 0.1418836162697943},
  {467.39375640879575, 1.2570140708670436},
  {477.50427253047735, 1.2085920587900176},
  {487.89720291671415, 0.4404266833769981},
  {495.9141791044776, 0},
  {531.0036174091375, 0},
  {557.4753617409137, 0},
  {569.4358835593027, 2.9234789791500475},
  {575.5028768371881, 8.641548934715729},
  {578.9115016520451, 15.234419505525807},
  {581.4609205879002, 23.411864817135694},
  {584.0163210664236, 31.876637803349666},
  {586.5687307736129, 40.197746952261596},
  {589.400563974023, 47.6554489005355},
  {591.3014127834113, 53.24979349436026},
  {594.0824028711404, 58.26521020849948},
  {598.4040674490145, 65.85945510994645},
  {603.2576620713228, 70.43391107439899},
  {611.3733337131139, 74.56170958186169},
  {624.4306141050472, 73.20607126580836},
  {632.4057194941324, 70.5816694200752},
  {639.8369317534465, 70.40240116212829},
  {651.4851315939387, 72.78914350005697},
  {663.4217272416543, 74.74347014925374},
  {680.1072405149823, 76.24401845733166},
  {703.9086532983936, 76.70473966047625},
  {721.4473909080551, 76.3333855531503}
};

const static spectra_entry color_cinematography_dufay_green[] = {
  {399.2635581633816, 0},
  {439.7026318787741, 0},
  {473.3052295773043, 0},
  {480.49290759940754, 1.9126694770422716},
  {485.6408795716076, 6.342037427366975},
  {488.4128973453344, 10.926462629600096},
  {492.44616611598497, 18.95312321977896},
  {496.18804830807795, 27.26853566138773},
  {499.33220348638486, 35.44313261934603},
  {503.7286373476131, 46.628973453343974},
  {507.4406118263644, 53.50774752193233},
  {510.85521818388975, 60.38794576734648},
  {516.0390794120998, 66.54127976529566},
  {523.5899225247807, 72.10856499943034},
  {530.4921955109946, 75.09274951577989},
  {541.1436139911132, 72.45553007861457},
  {545.811780790703, 68.12282813034065},
  {551.9488435684175, 62.921022274125555},
  {559.2305172610231, 55.558562151076686},
  {565.0522672895066, 49.49619744787513},
  {569.3961490258631, 43.87194514070866},
  {573.7250769055486, 37.52937364703202},
  {578.3663267631309, 31.903697163039766},
  {585.3625954198474, 25.11731656602484},
  {590.292241084653, 19.059224393300667},
  {599.0906630967302, 13.126281759143225},
  {607.324256579697, 8.632825851657728},
  {615.5877577760054, 5.5760083171926595},
  {628.9065170331548, 2.494979776689064},
  {628.9065170331548, 2.494979776689064},
  {640.7653526261821, 0.7140466560328207},
  {652.0444058334283, 0},
  {667.8079070297367, 0},
  {682.7032300330409, 0.9442292355018793},
  {694.6577703087615, 3.760538908510881},
  {703.6894724849037, 9.033375583912502},
  {713.3159109034978, 14.303363905662536},
  {720.2002392617067, 16.425565398199836}
};

const static spectra_entry color_cinematography_dufay_blue[] = {
  {399.8057422809616, 83.1899068588356},
  {419.4320382818731, 83.09591118833315},
  {436.6524723709696, 81.7203343967187},
  {451.74646804147204, 78.19976928335421},
  {461.4728836732369, 73.98652016634385},
  {470.56867380653983, 68.0521533553606},
  {476.7087273555885, 62.99401133644754},
  {483.99339181952837, 55.775215050700695},
  {490.0915745698986, 48.70577930955908},
  {496.50207929816565, 42.353238578101866},
  {502.87370399908855, 34.133067961718126},
  {508.0797823857811, 27.067904751053902},
  {512.9914834225817, 20.1478295545175},
  {519.966816679959, 12.355802096388288},
  {528.1555485929133, 5.707388629372204},
  {535.2265865329839, 2.51260396490828},
  {545.5866184345448, 0.16413637917283097},
  {558.9622023470434, 0},
  {577.3960350917171, 0},
  {594.3490087729292, 0},
  {616.0479093084198, 0},
  {628.5523242565797, 0},
  {644.6520736014584, 1.7011792184117667},
  {653.8974023014698, 2.950004272530464},
  {661.1000341802438, 6.076428449356271},
  {667.4404694086818, 10.643763529679859},
  {672.627321408226, 16.940761364931063},
  {677.5377406858836, 24.24483023812236},
  {681.8235160077475, 30.11510909194486},
  {685.5534351145038, 37.85586618434546},
  {688.9710322433634, 44.87972826706164},
  {692.0852797083286, 51.617686851999544},
  {695.5148399225247, 59.2162042839239},
  {700.1278910789564, 66.52169733394098},
  {702.3290987809046, 72.258281588242},
  {707.5279138657855, 79.12993477270138},
  {712.4114162014355, 85.14102911017433},
  {716.9945596445255, 91.00988378717102},
  {721.2205195397061, 94.00688589495272},
};
#else
/* Chart from Color Cinematography, third edition (1951)  */
const static spectra_entry color_cinematography_dufay_red[] = {
  {400.2745059092264,  0},
  {406.1070612771874,  0},
  {412.48942298142816, 0},
  {418.43162180951435, 0},
  {424.37382063760055, 0},
  {429.87585658953225, 0},
  {435.3786870592909,  0},
  {440.22047869699077, 0},
  {444.6221074585361,  0},
  {449.464693614063,   0},
  {453.8663223756083,  0},
  {458.26715661932667, 0},
  {461.783692521601, 0.5470751812494115},
  {465.74078855894334, 1.1454215910220285},
  {470.1412255437482, 1.3108550998113486},
  {473.8818154732347, 1.4216903366769458},
  {477.1834343033072, 1.369773562419354},
  {482.4665805939021, 1.210894825702681},
  {486.8701956500149, 0.9431174893236687},
  {490.6139636508094, 0.6207418810210044},
  {494.360115205085,  0},
  {498.76214122554376,0},
  {503.60433012215714,0},
  {508.0059588837025, 0},
  {512.4071903863344, 0},
  {516.1485748336479, 0},
  {522.090773661734,  0},
  {526.4931969411064, 0},
  {530.0137054325156, 0},
  {535.296454464197,  0},
  {539.2575230906743, 0},
  {545.4198033568379, 0},
  {551.1411262290198, 0},
  {556.4226834839607, 0},
  {561.9207468467574, 0.6148574833648439},
  {566.0947462508691, 1.6465637103983255},
  {569.6057205283544, 3.0568825106764024},
  {572.4536696792135, 4.845813884199046},
  {574.415334194061, 7.446419704042171},
  {576.1565200119177, 10.101027907438691},
  {577.6752408382163, 13.080395272618944},
  {578.9734829675241, 16.11376502135269},
  {580.0516436587545, 19.14698579799385},
  {581.0229417022545, 21.746921243420417},
  {581.9894726387922, 24.99667295659947},
  {582.7391002085609, 27.81306485251764},
  {583.7040421094449, 31.279421988280873},
  {584.3436289601748, 34.09573939815276},
  {585.0916674942894, 37.1287367166551},
  {585.8436786175389, 39.62022047869699},
  {586.8117985897309, 42.65336676929189},
  {587.7783295262687, 45.90311848247096},
  {588.9649419008839, 49.153019167742585},
  {590.15393782898, 52.07801171913795},
  {591.3437282749032, 54.89470155924125},
  {592.9720925613268, 57.92829476611382},
  {594.3819644453273, 60.74513357830967},
  {596.0103287317509, 63.77872678518224},
  {597.9704042109444, 66.59593802760949},
  {600.1529446816962, 69.08839010825307},
  {602.9941404310259, 71.79789452775847},
  {606.2778826099911, 74.18278875757275},
  {610.0089383255536, 75.59325652994339},
  {614.408978051445, 75.81284139437881},
  {618.596881517529, 74.94925017380078},
  {622.1261297050353, 73.86860661436091},
  {625.2144204985599, 72.89596782202801},
  {628.7424769093257, 71.97777832952629},
  {632.0484655874466, 71.3301966431622},
  {636.2312046876552, 71.17057304598272},
  {640.8469560035753, 71.98597179461714},
  {645.6815969808322, 72.96397358228225},
  {649.6378985003475, 73.67062270334691},
  {654.0335683781905, 74.48587247988877},
  {657.9906644155328, 75.08421888966134},
  {661.9485549707022, 75.57426258814182},
  {666.7859767603536, 76.17320488628465},
  {671.624987585659, 76.55554176184327},
  {675.1439070414142, 76.88283344920052},
  {679.544344026219, 77.04826695798987},
  {685.2648723805739, 77.26874565498063},
  {689.8857880623696, 77.38017678021652},
  {694.5071010030788, 77.43745654980634},
  {698.028404012315, 77.43984010328731},
  {702.6497169530242, 77.49711987287714},
  {706.8312642764922, 77.49995034263583},
  {711.233290296951, 77.448778428841},
  {715.6353163174099, 77.39760651504619},
  {720.1477803158209, 77.2923577316516},
};

/* Charts published in book are ambigous on what represent green and blue sensitivity.
   consider both posibilities.  */
#define MORE_RED_IN_BLUE
const static spectra_entry color_cinematography_dufay_green[] = {
  {400, 0},
  {440, 0},
  {461.3482967524084, 0},
  {467.2916873572351, 0},
  {471.14271526467377, 0},
  {474.11341741980334, 0},
  {478.5051147085113, 1.208213328036578},
  {481.13576323368756, 2.6179362399443846},
  {483.43470056609397, 4.244041116297552},
  {485.2902969510378, 6.303058893633931},
  {486.81338762538485, 8.68676134670774},
  {488.55338166650114, 11.503823617042414},
  {489.8532128314629, 14.320587943191995},
  {491.5900288012713, 17.570861058695016},
  {492.9975171317907, 20.71260800476712},
  {494.29496474327146, 23.854280464792936},
  {495.59161783692525, 27.10425563611085},
  {496.7782302115404, 30.35415632138249},
  {497.85559638494385, 33.49567980931573},
  {499.1530439964247, 36.63735226934155},
  {500.7758466580594, 40.429064455258725},
  {502.0717052338862, 43.78734233786871},
  {503.369947363194, 46.820712086602455},
  {504.5589432912901, 49.74570463799782},
  {506.29496474327146, 53.104280464792936},
  {508.14182143211843, 56.354628066342244},
  {510.20717052338864, 59.82173006256828},
  {512.1656569669282, 62.8555467275797},
  {514.1273214817758, 65.45615254742279},
  {516.6391895918165, 68.05713079749728},
  {519.2634819743769, 70.33327539974178},
  {522.216307478399, 72.82624888270931},
  {524.9562022047869, 74.34434899195551},
  {528.7984904161287, 75.5924371834343},
  {532.9796404806833, 75.64941900883902},
  {536.2860264177177, 74.94768596682889},
  {539.5983712384547, 73.43368259012811},
  {542.2520607806138, 71.70262687456551},
  {544.9085311351673, 69.59251166948059},
  {547.7870692223657, 67.21178865825803},
  {550.0029794418513, 65.15552686463403},
  {552.2188896613368, 63.09926507101004},
  {554.2131294070911, 61.25945972787763},
  {556.4302314033171, 59.04074386731552},
  {558.6477306584566, 56.76787665110736},
  {560.8660244314232, 54.38670672360712},
  {562.864634025226, 51.95123646836827},
  {565.0829277981925, 49.57006654086801},
  {567.4144403615055, 46.755760254245715},
  {569.5242824510875, 44.15791041811502},
  {571.6357135763234, 41.343455159400136},
  {573.9696096931175, 38.20424073890159},
  {576.3011222564306, 35.38993445227928},
  {578.7442645744364, 32.35909722911909},
  {581.2966530936537, 29.436637203297252},
  {584.1815473234681, 26.189492501738016},
  {587.0640579998014, 23.26725593405503},
  {589.9441851226536, 20.669927500248306},
  {592.7134770086403, 18.180827291687365},
  {595.5904260601848, 16.01670970304899},
  {598.9083325057106, 13.744587347303622},
  {602.665607309564, 11.581065647035459},
  {606.0895818849935, 9.850531333796823},
  {609.4027212235575, 8.22822524580397},
  {612.9339557056312, 6.876824908133884},
  {616.6848743668686, 5.579724898202429},
  {621.0956400834244, 4.337223160194711},
  {625.5052140232397, 3.257175489125075},
  {631.6758367265866, 2.124168239149924},
  {637.8440758764525, 1.3160691230509656},
  {643.1284139437878, 0.9947363193961962},
#ifdef MORE_RED_IN_BLUE
  {649.0733935842685, 0.6196990763730668},
  {654.1380474724401, 0.24406594497969536},
  {659.8605621213626, 0.19378786374022638},
  {664.702751017976, 0.1429138941305581},
  {669.9847055318304, 0.14648922435202394},
  {675.2634819743768, 0.5832753997418223},
  {680.5402721223558, 1.2908183533618427},
  {685.8158704935942, 2.160815373919988},
  {690.2095540768696, 3.2468219286920714},
  {694.1622802661634, 4.440833250571075},
  {698.5504022246499, 6.284958784387769},
  {701.6184328135862, 8.074039130002987},
  {704.9025722514648, 10.404782004171224},
  {708.190287019565, 12.248162677525087},
  {711.9181646638197, 14.091841295064057},
  {715.6472340848147, 15.773065845664917},
  {720, 17.021228523189976},
#else
  {647.0807428741682, 2.2428989969212836},
  {651.4764127520111, 3.0581487734631594},
  {655.8681100407192, 4.414912106465451},
  {659.5971794617142, 6.096136657066253},
  {663.2126328334491, 8.264648922435214},
  {666.3855397755486, 10.757771377495288},
  {669.007448604628, 13.358824113616066},
  {670.97189393187, 15.580370443936829},
  {672.7154633032078, 17.91007051345717},
  {674.3485946965934, 20.293847452577225},
  {675.980931572152, 22.78592710298939},
  {677.6116794120567, 25.494612175985722},
  {679.1347700864037, 27.878314629059503},
  {680.5462310060582, 30.47854801867119},
  {682.1730062568279, 33.728746648127924},
  {683.364385738405, 36.32883106564705},
  {684.6642169033668, 39.145595391796604},
  {686.0724997517132, 42.17903962657664},
  {687.2630847154633, 44.887426755387835},
  {688.3452179958288, 47.37913397556858},
  {689.5350084417519, 50.19582381567187},
  {691.053332009137, 53.22934253649817},
  {692.3539576919258, 55.93780415135565},
  {693.9799384248684, 59.29630549210449},
  {695.7183434303306, 62.32997318502334},
  {697.2366669977157, 65.36349190584964},
  {698.8666203197934, 68.18047969013804},
  {700.496573641871, 70.99746747442646},
  {702.4542655675835, 74.13958685072997},
  {704.0866024431423, 76.63166650114212},
  {706.0450888866819, 79.66548316615354},
  {708.1144105670869, 82.59107160591915},
  {710.2945674843579, 85.40843182043898},
  {712.694011321879, 88.33424371834343},
  {714.5480186711688, 90.60986691826398},
  {716.8421888966134, 92.88578806236964},
  {719.4640977256927, 95.48684079849042},
  {720, 95.81219584864435},
#endif
};

const static spectra_entry color_cinematography_dufay_blue[] = {
  {400, 83.24908133876255},
  {404.39566987784286, 83.25191180852121},
  {409.23785877445624, 83.20103783891152},
  {414.0800476710696, 83.15016386930182},
  {418.0423080742874, 83.04454265567584},
  {422.6652100506505, 82.8852170026815},
  {428.1692322971497, 82.61818452676533},
  {433.4547621412255, 82.13439765617242},
  {438.7414837620419, 81.48815671864139},
  {443.811302016089, 80.40855596384944},
  {447.7799185619227, 79.43651305988678},
  {452.41195749329626, 78.03170622703348},
  {455.9431919753699, 76.68030588936338},
  {459.47561823418414, 75.16645148475519},
  {463.0096335286523, 73.43599165756282},
  {465.6625285529844, 71.81323865329227},
  {468.31701261297053, 69.97388022643759},
  {470.75141523487935, 68.13437282749032},
  {472.9669281954514, 66.13226238951236},
  {475.40291985301417, 64.07614956798093},
  {477.8408978051445, 61.74927996821929},
  {480.72062766908334, 59.20610289005862},
  {483.1597973979541, 56.71677922335883},
  {485.1556261793624, 54.660368457642285},
  {487.1514549607707, 52.603957691925714},
  {489.14847551891944, 50.385092859271026},
  {491.367563809713, 47.895620220478705},
  {493.144105670871, 45.73075777137751},
  {494.8090177773364, 43.7824262588142},
  {496.5855596384944, 41.61756380971299},
  {498.36130698182546, 39.56100407190387},
  {500.02780812394474, 37.396067136756386},
  {501.6935147482372, 35.33943291290099},
  {503.5808918462608, 33.06634223855397},
  {505.24818750620716, 30.793102592114423},
  {507.0255238851922, 28.519937431721146},
  {508.5827788260999, 26.246623299235296},
  {510.02800675340154, 24.243991458933365},
  {511.69291885986695, 22.295659946370066},
  {513.1373522693416, 20.401330817360233},
  {514.914291389413, 18.182317012612984},
  {516.578806236965, 16.28813685569571},
  {518.7971000099315, 13.906966928195473},
  {520.7921342735127, 11.958858873770993},
  {523.3397556857682, 9.686215115701671},
  {525.6641175886384, 7.846633230708136},
  {528.3178071307975, 6.115577515145503},
  {531.3016188300725, 4.3847452577217325},
  {534.8332505710597, 2.9791935644056338},
  {539.68417916377, 1.7369897705830226},
  {544.0913695501042, 0.9818502333896504},
  {548.7182441156024, 0.281011023934866},
  {554.222663621015, 0},
  {559.0644552587148, 0},
  {564.5672857284735, 0},
  {570.3990465786076, 0},
  {575.3504816764325, 0},
  {580.6324361902871, 0},
  {585.3637898500348, 0},
  {590.3164167246002, 0},
  {595.5983712384547, 0},
  {600.6610388320588, 0},
  {605.2827490316814, 0},
  {609.6839805343132, 0},
  {614.5261694309266, 0},
  {619.1478796305491, 0},
  {623.7664117588639, 0.2776591518522764},
  {628.3873274406594, 0.3890902770881297},
  {633.6665011421194, 0.7717250968319149},
  {637.8456649121065, 1.0994637004668277},
  {642.6838812195849, 1.5901032873175467},
#ifdef MORE_RED_IN_BLUE
  {647.0807428741682, 2.2428989969212836},
  {651.4764127520111, 3.0581487734631594},
  {655.8681100407192, 4.414912106465451},
  {659.5971794617142, 6.096136657066253},
  {663.2126328334491, 8.264648922435214},
  {666.3855397755486, 10.757771377495288},
  {669.007448604628, 13.358824113616066},
  {670.97189393187, 15.580370443936829},
  {672.7154633032078, 17.91007051345717},
  {674.3485946965934, 20.293847452577225},
  {675.980931572152, 22.78592710298939},
  {677.6116794120567, 25.494612175985722},
  {679.1347700864037, 27.878314629059503},
  {680.5462310060582, 30.47854801867119},
  {682.1730062568279, 33.728746648127924},
  {683.364385738405, 36.32883106564705},
  {684.6642169033668, 39.145595391796604},
  {686.0724997517132, 42.17903962657664},
  {687.2630847154633, 44.887426755387835},
  {688.3452179958288, 47.37913397556858},
  {689.5350084417519, 50.19582381567187},
  {691.053332009137, 53.22934253649817},
  {692.3539576919258, 55.93780415135565},
  {693.9799384248684, 59.29630549210449},
  {695.7183434303306, 62.32997318502334},
  {697.2366669977157, 65.36349190584964},
  {698.8666203197934, 68.18047969013804},
  {700.496573641871, 70.99746747442646},
  {702.4542655675835, 74.13958685072997},
  {704.0866024431423, 76.63166650114212},
  {706.0450888866819, 79.66548316615354},
  {708.1144105670869, 82.59107160591915},
  {710.2945674843579, 85.40843182043898},
  {712.694011321879, 88.33424371834343},
  {714.5480186711688, 90.60986691826398},
  {716.8421888966134, 92.88578806236964},
  {719.4640977256927, 95.48684079849042},
  {720, 95.81219584864435},
#else
  {649.0733935842685, 0.6196990763730668},
  {654.1380474724401, 0.24406594497969536},
  {659.8605621213626, 0.19378786374022638},
  {664.702751017976, 0.1429138941305581},
  {669.9847055318304, 0.14648922435202394},
  {675.2634819743768, 0.5832753997418223},
  {680.5402721223558, 1.2908183533618427},
  {685.8158704935942, 2.160815373919988},
  {690.2095540768696, 3.2468219286920714},
  {694.1622802661634, 4.440833250571075},
  {698.5504022246499, 6.284958784387769},
  {701.6184328135862, 8.074039130002987},
  {704.9025722514648, 10.404782004171224},
  {708.190287019565, 12.248162677525087},
  {711.9181646638197, 14.091841295064057},
  {715.6472340848147, 15.773065845664917},
  {720, 17.021228523189976},
#endif
};
#endif


/* 400 to 700 10nm bands.  */
const static luminosity_t tartrazine_data[] = {
	3.515, 3.584, 3.673, 3.785, 3.928,
	4.118, 4.359, 4.646, 5.054, 5.549,
	6.432, 7.768, 10.596, 16.05, 24.013,
	35.13, 47.59, 60.385, 71.63, 78.625,
	83.134, 86.293, 88.246, 89.348, 89.914,
	90.363, 90.535, 90.377, 90.264, 90.521,
	91.021};

const static luminosity_t rose_data[] = {
	29.753, 26.88, 24.764, 23.653, 22.746,
	21.441, 19.339, 15.616, 11.697, 8.784,
	6.582, 5.012, 4.028, 3.697, 3.667,
	3.399, 3.505, 3.148, 6.065, 16.857,
	32.822, 52.956, 71.318, 80.17, 84.432,
	86.681, 87.525, 88.024, 88.278, 88.738,
	89.232};
const static luminosity_t erythrosine_data[] = {
	10.625, 9.864, 9.194, 8.754, 8.073,
	6.622, 5.085, 3.935, 3.081, 2.647,
	2.486, 2.461, 2.583, 2.825, 3.132,
	3.047, 3.891, 6.17, 11.901, 24.623,
	39.47, 52.566, 63.498, 70.147, 74.383,
	77.371, 79.456, 81.175, 82.621, 84.049,
	85.365};
const static spectra_entry erythrosine_paper_data[] = {
  {359.8422239231262, 50.473856392368035},
  {373.5502320384302, 59.331899741810304},
  {381.94932575051445, 64.13197356155366},
  {394.97156869134335, 67.10010832014967},
  {409.3029782984745, 66.6936853770068},
  {421.6514581320549, 66.68841388081316},
  {437.08729325868194, 66.73901083088596},
  {450.5333739068649, 65.53235593877778},
  {457.8000372759245, 63.07023774784003},
  {465.9444988950843, 59.57838925579285},
  {474.85673981476725, 55.11404384988136},
  {482.0023046788574, 50.016827085766295},
  {488.0130529065566, 44.57926370061829},
  {495.29155831527976, 38.56471999565969},
  {508.61029467684216, 34.276915114595695},
  {523.1964493375305, 29.32978161246774},
  {541.2839317700285, 26.43986456132194},
  {551.7811374474943, 30.964547889201157},
  {556.5681831409305, 36.809243986800965},
  {560.088149417139, 43.395617006718105},
  {562.6521298586326, 49.158913672379406},
  {565.8511749772817, 54.92193923252218},
  {568.4144776549791, 60.52053929567675},
  {572.5651031436671, 66.03611329378164},
  {578.62126154572, 71.63322227658429},
  {584.3493822703521, 74.67766947329196},
  {602.4599086719251, 77.38743690737485},
  {630.4051266400571, 77.9519463733331},
  {652.5694260838234, 78.0742420727418},
  {673.5277804047904, 78.36174947514243},
  {693.3470848896555, 79.63792448251677},
  {711.6458940738472, 81.8041117966719},
  {728.0317827192943, 82.09357115880594},
  {748.7561458672184, 81.07677906733997},
  {777.1049450655095, 80.94609536318796},
  {800.8812785882807, 80.81736361876938},
  {825.5721052461556, 80.68824148240411}
};

const static spectra_entry o2_erythrosine_paper_data[] = {
  {359.90331943440407, 34.284400337962296},
  {369.9861674373492, 39.97202060918125},
  {377.78229461260094, 45.54203530646206},
  {386.03713232520477, 51.467599469184066},
  {395.658829841131, 56.20676250593762},
  {407.1090256373319, 60.82656320499296},
  {420.83911040215935, 63.90382772471863},
  {435.0235137949387, 66.26940772564191},
  {451.4936620355446, 68.51543019289363},
  {468.8748874817212, 69.93099139156479},
  {488.0782673390388, 69.68563005307476},
  {504.9876065196628, 67.54393983357396},
  {522.3580961873056, 66.35070684853855},
  {536.0667093950653, 64.21038300085115},
  {548.8749811757884, 65.50931460545087},
  {558.4942387420481, 69.6555698731802},
  {567.6557617508222, 73.68343878307803},
  {581.8430930832017, 76.76050810683037},
  {600.1378356846154, 77.93851580594514},
  {623.0021160219492, 78.40308222249745},
  {643.5782115617895, 78.39429840369709},
  {663.2407899463926, 78.6230680844531},
  {682.448073723177, 79.32635917640182},
  {700.7442802943909, 80.86011153693113},
  {718.1279456902342, 82.8685805046265},
  {738.7011132904744, 82.14830736299707},
  {758.8165463332292, 81.30964786353616},
  {775.2759587953014, 80.94687614708134},
  {796.3088129127606, 80.8193155785028},
  {811.8556841994621, 80.93126046921404},
  {829.6887883239237, 81.04222938005856},
};

const static spectra_entry patent_paper_data[] = {
  {359.8745688303544, 53.535353535353536},
  {366.64785199121985, 53.468013468013474},
  {374.9263091878332, 52.5925925925926},
  {381.95045468799003, 50.841750841750844},
  {389.22546252743814, 49.42760942760943},
  {397.75478206334276, 48.21548821548822},
  {404.1517717152713, 46.5993265993266},
  {409.04358733145193, 44.91582491582493},
  {413.93540294763255, 43.87205387205387},
  {420.08153026026974, 46.06060606060606},
  {424.09532768893075, 48.8888888888889},
  {427.2311069300722, 52.121212121212125},
  {429.3634368140483, 54.545454545454554},
  {430.86861084979626, 56.63299663299664},
  {432.87550956412673, 59.86531986531987},
  {436.63844465349644, 63.63636363636364},
  {440.15051740357484, 66.93602693602693},
  {444.41517717152715, 69.83164983164984},
  {451.43932267168395, 72.65993265993266},
  {462.72812793979307, 74.14141414141415},
  {474.2677955471935, 74.68013468013469},
  {485.30573847601136, 74.27609427609428},
  {491.57729695829414, 73.1986531986532},
  {501.8626528692381, 71.04377104377105},
  {510.39197240514267, 69.0909090909091},
  {516.6635308874255, 67.47474747474747},
  {524.0639698965193, 65.25252525252526},
  {531.5898400752587, 62.76094276094277},
  {535.9799310128567, 60.67340067340068},
  {543.0040765130135, 57.17171717171718},
  {549.777359673879, 52.659932659932664},
  {554.543744120414, 49.831649831649834},
  {560.0627155848229, 46.936026936026934},
  {565.5816870492317, 43.50168350168351},
  {571.2260896832863, 40.06734006734007},
  {576.4941988084039, 36.96969696969697},
  {581.5114455942303, 34.478114478114485},
  {587.9084352461588, 31.919191919191924},
  {594.9325807463156, 30.00000000000003},
  {603.7127626215115, 28.417508417508415},
  {614.7507055503293, 26.666666666666686},
  {622.52743806836, 24.848484848484844},
  {633.3145186578865, 22.289562289562298},
  {643.3490122295391, 21.279461279461287},
  {656.3938538726875, 22.289562289562298},
  {666.0520539354029, 24.57912457912458},
  {673.7033552837881, 27.74410774410775},
  {677.7171527124492, 30.370370370370374},
  {681.73095014111, 34.612794612794616},
  {685.2430228911885, 38.85521885521886},
  {687.7516462841018, 42.89562289562291},
  {692.768893069928, 51.24579124579125},
  {698.0370021950455, 58.65319865319866},
  {702.5525243022892, 63.70370370370371},
  {707.8206334274067, 68.28282828282829},
  {713.0887425525243, 72.45791245791247},
  {721.1163374098464, 76.4983164983165},
  {736.4189401066166, 79.5959595959596},
  {760.2508623392914, 79.93265993265993},
  {779.0655377861399, 80.13468013468014},
  {800.1379742866102, 80.40404040404042},
  {820.2069614299153, 80.60606060606061},
  {829.7397303229852, 80.74074074074075},
};

const static spectra_entry o2_patent_paper_data[] = {
  {360.1254311696457, 43.23232323232324},
  {367.4004390090938, 45.52188552188553},
  {372.9194104735027, 46.73400673400675},
  {381.19786767011607, 47.40740740740741},
  {389.22546252743814, 47.27272727272728},
  {396.50047036688625, 47.27272727272728},
  {405.28065224208217, 46.26262626262626},
  {414.0608341172782, 44.91582491582493},
  {419.3289432423958, 46.464646464646464},
  {424.59705236751336, 49.0909090909091},
  {428.8617121354657, 53.872053872053876},
  {435.38413295703987, 57.64309764309765},
  {440.4013797428662, 60.67340067340068},
  {449.1815616180621, 63.77104377104377},
  {463.98243963624964, 65.11784511784512},
  {477.27814361868934, 65.993265993266},
  {489.82126058325497, 65.4882154882155},
  {499.1031671370336, 64.57912457912458},
  {509.3885230479775, 63.70370370370371},
  {518.670429601756, 62.76094276094277},
  {527.1997491376608, 61.54882154882155},
  {539.2411414236439, 58.92255892255893},
  {548.0213232988399, 55.622895622895626},
  {553.7911571025401, 52.5925925925926},
  {559.8118532455316, 50.235690235690235},
  {565.8325493885231, 47.07070707070708},
  {572.3549702100972, 43.70370370370371},
  {579.6299780495453, 40.33670033670034},
  {585.9015365318282, 37.710437710437716},
  {593.9291313891503, 35.42087542087542},
  {603.2110379429289, 33.939393939393945},
  {611.4894951395422, 32.659932659932664},
  {620.2696770147381, 31.313131313131315},
  {630.0533082470995, 29.42760942760944},
  {642.5964252116652, 28.55218855218856},
  {655.3904045155222, 28.888888888888893},
  {664.9231734085921, 30.437710437710443},
  {671.6964565694575, 33.40067340067341},
  {675.4593916588274, 36.430976430976436},
  {678.9714644089056, 39.73063973063974},
  {682.2326748196928, 43.83838383838384},
  {684.9419880840389, 47.43434343434344},
  {687.9523361555347, 51.47474747474748},
  {691.5647538413295, 56.08080808080809},
  {695.7792411414237, 61.8989898989899},
  {701.4989024772657, 67.7979797979798},
  {707.5195986202572, 72.96969696969697},
  {715.0454687989966, 77.0909090909091},
  {725.8827218563813, 80.56565656565657},
  {747.2561931640014, 81.13131313131314},
  {764.7162119786767, 80.8888888888889},
  {783.9824396362496, 81.16363636363637},
  {803.8507369081217, 81.16363636363637},
  {819.0228911884603, 81.16363636363637},
  {829.4989024772656, 81.35757575757576},
};

const static spectra_entry tartrazine_paper_data[] = {
  {361.75493575681605, 45.694294940796546},
  {369.52679410842995, 44.85468245425187},
  {378.05076778439366, 43.82131324004305},
  {386.3240363522407, 42.787944025834214},
  {394.59730492008777, 41.62540365984929},
  {402.6198683798183, 40.527448869752405},
  {410.64243183954875, 39.55866523143163},
  {419.6678157317456, 38.91280947255112},
  {435.9636477593231, 38.78363832077502},
  {446.99467251645257, 39.55866523143163},
  {456.5214666248825, 41.36706135629708},
  {462.789094327797, 43.433799784714736},
  {468.5553118144783, 45.82346609257265},
  {474.4468818552178, 48.66523143164692},
  {480.08774678784084, 51.70075349838536},
  {485.8539642745221, 55.44671689989235},
  {491.36947665308685, 59.64477933261571},
  {495.1300532748355, 62.93864370290635},
  {499.14133500470075, 66.68460710441335},
  {503.40332184268266, 70.43057050592034},
  {509.92165465371363, 73.91819160387514},
  {517.442807897211, 77.14747039827773},
  {530.2287684111565, 79.60172228202369},
  {542.2626136007523, 80.76426264800862},
  {560.3133813851458, 80.15069967707214},
  {571.9711689125667, 79.66630785791175},
  {589.896584142902, 79.14962325080734},
  {607.4459417110625, 79.27879440258343},
  {622.7389533061737, 79.27879440258343},
  {639.2854904418679, 79.34337997847149},
  {657.586963334378, 79.34337997847149},
  {671.6264493889064, 79.34337997847149},
  {684.1617047947353, 79.92465016146396},
  {697.1983704167974, 80.95801937567278},
  {710.485741146976, 82.50807319698602},
  {722.7702914446884, 83.34768568353068},
  {740.3196490128488, 82.57265877287406},
  {754.3591350673771, 81.82992465016147},
  {770.9056722030713, 81.41011840688914},
  {785.9479786900661, 81.21636167922499},
  {801.2409902851773, 81.21636167922499},
  {813.7762456910061, 81.21636167922499},
  {829.5706675023505, 81.28094725511303},
};

const static spectra_entry rose_paper_data[] = {
  {360.1308044473513, 54.969453564171395},
  {363.79332897318517, 56.48237337624867},
  {371.9032047089602, 61.50216891560716},
  {377.6586003924134, 64.66538318758148},
  {385.2452583387836, 67.82875484458604},
  {395.7096141268804, 70.09856175064117},
  {407.22040549378687, 70.44332490115971},
  {417.68476128188365, 69.75667649781836},
  {429.98037933289737, 69.55146890196713},
  {442.79921517331593, 69.96509924500154},
  {454.31000654022245, 70.1035980716087},
  {467.3904512753434, 69.3484197293877},
  {476.0235448005233, 67.49278277218494},
  {480.7325049051668, 65.70556333598307},
  {486.6187050359713, 63.29965210413794},
  {492.7665140614781, 60.96251813050568},
  {497.9986919555265, 58.350286365809794},
  {501.92282537606286, 55.80669695787229},
  {504.2773054283846, 52.91919877529466},
  {508.0706344015698, 49.61929560456088},
  {511.2099411379988, 46.800619647347624},
  {516.0497056899935, 43.98208983337673},
  {516.0497056899935, 43.98208983337673},
  {523.3747547416613, 42.19509523293236},
  {530.699803793329, 42.53949864623894},
  {539.0712884238064, 40.61508443082331},
  {543.7802485284499, 37.79654337506453},
  {548.0967952910398, 34.84045904466788},
  {553.9829954218444, 32.0907739396371},
  {561.831262262917, 30.819485116122685},
  {569.941137998692, 33.32973138122603},
  {573.6036625245258, 36.49276578459437},
  {576.2197514715501, 39.93072935220823},
  {578.7050359712231, 43.91871987513123},
  {581.5827338129498, 48.93806574297477},
  {583.6756049705691, 53.5448155122683},
  {586.5533028122957, 58.770425704023225},
  {589.3001962066711, 63.85851510471602},
  {592.7011118378025, 68.80915116507393},
  {596.2328319162852, 72.59096729838853},
  {605.2583387835186, 76.92329378389087},
  {621.4780902550688, 78.2997832583298},
  {637.4362328319163, 78.71368340427318},
  {652.3479398299542, 78.98998406663932},
  {665.1667756703728, 78.99108576185097},
  {679.8168737737083, 79.19860916600425},
  {693.6821451929366, 80.36863196435004},
  {707.8090255068672, 81.88245111945724},
  {721.6742969260954, 83.32749301635155},
  {740.5101373446697, 82.43529976352275},
  {755.68345323741, 81.54279174063348},
  {771.3799869195552, 81.26912165662984},
  {785.7684761281885, 81.16722609134028},
  {800.1569653368215, 81.20284007532499},
  {811.9293655984303, 81.10071967427794},
  {829.9803793328974, 81.4460449141902},
};

const static spectra_entry o2_rose_paper_data[] = {
  {360.3924133420537, 35.51187482544004},
  {365.8862001308045, 39.56887868412127},
  {372.1648136036626, 44.31349773990102},
  {377.6586003924134, 48.09548250003374},
  {383.9372138652715, 52.01504426016796},
  {390.21582733812954, 55.59083214711655},
  {397.2792674950949, 59.16668748479238},
  {407.4820143884893, 62.46779352682867},
  {420.0392413342054, 64.94404462540115},
  {433.90451275343366, 66.9391247193925},
  {449.3394375408765, 68.79683016556407},
  {462.41988227599745, 70.3793141610054},
  {475.238718116416, 71.82426612359671},
  {491.9816873773709, 72.23823372026736},
  {503.2308698495749, 71.07036934519334},
  {512.3871811641596, 69.55855122832772},
  {526.7756703727928, 69.49103305035672},
  {537.7632439502944, 69.76699645908664},
  {547.1811641595815, 67.70516262869974},
  {552.6749509483323, 65.23046289685385},
  {562.0928711576194, 63.58115771428972},
  {571.2491824722041, 66.26338085028888},
  {577.0045781556573, 69.56410467153745},
  {582.4983649444082, 72.79605123457316},
  {589.0385873119686, 75.61555908408909},
  {601.0725964682799, 78.02301044087295},
  {615.4610856769131, 78.78054955854749},
  {631.1576193590582, 79.05691767164087},
  {646.8541530412035, 79.33328578473426},
  {659.672988881622, 79.12812315603452},
  {671.7069980379333, 79.19791217515605},
  {683.7410071942446, 80.02400371528599},
  {696.2982341399608, 80.91889499720455},
  {705.4545454545455, 82.0885130911869},
  {719.8430346631785, 83.28608276653904},
  {735.5395683453237, 82.54488021500295},
  {751.8639633747548, 81.96874308317774},
  {769.1301504251144, 81.55769835135433},
  {785.7684761281885, 81.22910538851369},
  {829.404839764552, 81.54637742129374},
};

const static spectra_entry flexo_paper_data[] = {
  {360.50955414012736, 48.72},
  {368.1528662420382, 48.51428571428571},
  {379.87261146496814, 47.005714285714284},
  {388.5350318471337, 44.81142857142857},
  {397.452229299363, 42.34285714285714},
  {404.84076433121015, 40.628571428571426},
  {417.8343949044586, 38.84571428571429},
  {427.77070063694265, 42.068571428571424},
  {431.8471337579617, 45.01714285714286},
  {439.3630573248407, 52.49142857142857},
  {445.85987261146494, 59.82857142857143},
  {449.936305732484, 64.21714285714286},
  {455.92356687898086, 68.81142857142856},
  {464.968152866242, 72.48},
  {481.27388535031844, 73.54285714285714},
  {493.2484076433121, 70.90285714285714},
  {501.91082802547766, 68.12571428571428},
  {508.5350318471337, 65.89714285714285},
  {515.9235668789809, 62.50285714285714},
  {524.0764331210191, 58.457142857142856},
  {530.4458598726114, 54.96},
  {536.1783439490446, 51.325714285714284},
  {542.1656050955414, 47.34857142857143},
  {548.0254777070063, 43.92},
  {552.9936305732484, 40.69714285714286},
  {559.4904458598726, 36.85714285714286},
  {566.4968152866242, 33.291428571428575},
  {574.0127388535032, 30.000000000000007},
  {584.2038216560509, 27.188571428571436},
  {598.9808917197452, 24.994285714285695},
  {612.4840764331209, 23.21142857142857},
  {625.4777070063694, 21.085714285714275},
  {639.4904458598726, 19.714285714285708},
  {655.796178343949, 21.017142857142844},
  {668.28025477707, 23.554285714285726},
  {677.4522292993629, 26.982857142857142},
  {683.8216560509552, 31.78285714285714},
  {687.8980891719744, 36.03428571428572},
  {691.8471337579617, 40.56},
  {695.1592356687898, 45.01714285714286},
  {698.5987261146497, 49.885714285714286},
  {702.0382165605095, 55.028571428571425},
  {706.2420382165604, 60.51428571428571},
  {710.4458598726114, 65.65714285714286},
  {715.5414012738853, 70.38857142857142},
  {722.4203821656051, 75.12},
  {732.7388535031846, 78.27428571428571},
  {749.2993630573247, 79.67999999999999},
  {765.0955414012737, 80.09142857142857},
  {777.8343949044586, 80.19428571428571},
  {789.2993630573247, 80.53714285714285},
  {804.5859872611463, 80.94857142857143},
  {816.56050955414, 81.01714285714286},
  {830.0636942675158, 81.1542857142857},
};

const static spectra_entry o2_flexo_paper_data[] = {
  {360.25477707006365, 32.26285714285714},
  {367.6433121019108, 35.417142857142856},
  {374.01273885350315, 38.64000000000001},
  {383.43949044585986, 42.205714285714286},
  {393.8853503184713, 44.26285714285714},
  {408.6624203821656, 44.81142857142857},
  {420.3821656050955, 46.04571428571429},
  {428.0254777070063, 48.582857142857144},
  {435.41401273885344, 52.49142857142857},
  {443.312101910828, 56.05714285714286},
  {452.2292993630573, 59.48571428571428},
  {463.9490445859872, 61.748571428571424},
  {478.4713375796178, 63.325714285714284},
  {493.75796178343944, 64.01142857142858},
  {508.0254777070063, 63.25714285714285},
  {520.764331210191, 62.16},
  {532.2292993630573, 60.03428571428571},
  {539.872611464968, 57.42857142857143},
  {548.7898089171974, 54.27428571428572},
  {555.4140127388534, 50.84571428571429},
  {563.0573248407643, 47.074285714285715},
  {568.9171974522292, 43.78285714285715},
  {577.0700636942674, 40.628571428571426},
  {587.0063694267515, 37.74857142857143},
  {600, 35.485714285714295},
  {612.4840764331209, 33.77142857142857},
  {625.7324840764331, 32.26285714285714},
  {642.0382165605095, 31.577142857142853},
  {657.3248407643312, 32.948571428571434},
  {666.496815286624, 36.24000000000001},
  {672.3566878980891, 40.011428571428574},
  {675.9235668789809, 44.12571428571429},
  {680, 48.44571428571429},
  {683.8216560509554, 52.354285714285716},
  {687.388535031847, 56.605714285714285},
  {690.700636942675, 61.611428571428576},
  {696.3057324840763, 66.20571428571428},
  {700.8917197452229, 70.38857142857142},
  {707.0063694267515, 74.57142857142857},
  {716.1783439490446, 78.87771428571429},
  {728.1019108280254, 81.264},
  {747.3630573248406, 81.264},
  {762.343949044586, 81.18171428571428},
  {778.5477707006369, 80.85257142857142},
  {795.9745222929935, 80.98422857142857},
  {811.016560509554, 81.08297142857143},
  {829.7273885350317, 80.98422857142857},
};

const static spectra_entry crystal_paper_data[] = {
  {360, 45.52003081664099},
  {368.619000979432, 47.53081664098613},
  {378.54391119817177, 49.333590138674886},
  {385.8570029382958, 51.899075500770415},
  {391.864185439112, 55.01926040061633},
  {398.3937316356513, 58.20878274268105},
  {405.8374142997062, 61.32896764252696},
  {414.3258243552074, 64.24114021571648},
  {424.7730982696703, 67.153312788906},
  {435.48155403199485, 67.98536209553158},
  {447.4959190336272, 66.80662557781201},
  {457.9431929480902, 64.10246533127889},
  {464.86451191642186, 61.60631741140215},
  {472.699967352269, 58.20878274268105},
  {480.2742409402547, 53.771186440677965},
  {486.54260528893246, 49.12557781201849},
  {492.941560561541, 43.64791987673344},
  {502.6052889324193, 37.823574730354395},
  {512.6607900750898, 33.03929121725732},
  {524.2833823049299, 30.057781201848996},
  {542.3049298073785, 27.977657935285052},
  {560.5876591576887, 26.382896764252706},
  {579.1315703558603, 25.412172573189522},
  {598.7202089454784, 24.718798151001536},
  {615.4358472086192, 25.550847457627114},
  {626.7972575905976, 27.63097072419106},
  {635.2856676460987, 31.16718027734977},
  {648.3447600391773, 42.74653312788906},
  {657.747306562194, 51.34437596302003},
  {663.885079986941, 57.44607087827426},
  {670.9369898792036, 63.33975346687211},
  {680.2089454782894, 69.37211093990754},
  {692.2233104799217, 74.57241910631741},
  {704.7600391772772, 77.62326656394453},
  {720.1697682011102, 80.32742681047766},
  {738.9748612471435, 80.25808936825887},
  {758.3023179888999, 79.63405238828967},
  {773.4508651648712, 79.63405238828967},
  {791.2112308194583, 79.59938366718028},
  {809.2327783219067, 79.49537750385208},
  {829.8661443029711, 79.77272727272727}
};

const static spectra_entry o2_crystal_paper_data[] = {
  {360, 33.31664098613251},
  {366.2683643486778, 36.50616332819723},
  {372.53672869735556, 39.973035439137135},
  {378.2827293503102, 43.57858243451464},
  {385.0734573947111, 47.11479198767334},
  {392.1253672869736, 50.92835130970724},
  {401.2667319621287, 54.53389830508474},
  {411.7140058765916, 57.238058551617875},
  {429.47437153117863, 58.902157164869024},
  {447.23473718576565, 59.04083204930662},
  {461.8609206660137, 59.768875192604},
  {475.18119490695403, 60.0115562403698},
  {486.4120143650017, 58.20878274268105},
  {493.4639242572642, 55.365947611710325},
  {500.51583414952665, 52.4537750385208},
  {507.04538034606605, 49.333590138674886},
  {514.0972902383285, 46.560092449922955},
  {520.6268364348679, 43.717257318952235},
  {529.2458374142998, 41.567796610169495},
  {540.2154750244858, 39.21032357473036},
  {553.013385569703, 37.4768875192604},
  {565.0277505713354, 36.090138674884436},
  {580.6986614430298, 34.77272727272727},
  {595.0636630754163, 33.94067796610169},
  {610.4733920992492, 34.28736517719568},
  {621.9653934051585, 36.367488443759626},
  {632.4126673196214, 39.90369799691834},
  {639.2033953640223, 43.23189522342064},
  {644.1658504733922, 46.90677966101695},
  {648.605941887039, 50.026964560862865},
  {653.5683969964089, 54.048536209553156},
  {658.5308521057788, 57.44607087827426},
  {662.4485798237024, 60.91294298921417},
  {667.9333986287954, 64.58782742681048},
  {674.2017629774732, 68.33204930662558},
  {680.7313091740125, 71.86825885978428},
  {691.1785830884754, 75.88983050847457},
  {703.715311785831, 79.35670261941448},
  {715.9908586353249, 82.06086286594761},
  {732.7169441723802, 82.6959938366718},
  {751.8981390793341, 81.99707241910632},
  {769.5749265426055, 81.59768875192604},
  {786.4995102840353, 81.49784283513097},
  {802.2957884427033, 81.3979969183359},
  {819.2203721841332, 81.49784283513097},
  {829.751224289912, 81.6975346687211},
};
const static luminosity_t patent_data[] = {
	4.109, 3.429, 4.551, 7.879, 12.157,
	16.729, 19.668, 18.52, 15.802, 13.106,
	10.459, 8.196, 6.274, 4.773, 3.666,
	2.99, 2.605, 2.418, 2.374, 2.396,
	2.471, 2.545, 2.641, 2.74, 2.859,
	3.011, 3.165, 3.283, 3.522, 4.02,
	4.722};
/* Described as malachite */
const static luminosity_t flexo_data[] = {
	19.459, 17.381, 18.342, 22.466, 29.516,
	40.348, 49.614, 52.108, 50.776, 46.243,
	39.993, 33.718, 27.426, 21.506, 16.355,
	12.579, 9.8, 7.86, 6.613, 5.931,
	5.58, 5.305, 5.137, 4.972, 4.965,
	5.21, 5.82, 6.881, 8.833, 12.118,
	16.567};
const static luminosity_t crystal_data[] = {
	38.315, 40.266, 39.171, 34.427, 28.003,
	21.398, 15.17, 10.28, 6.66, 4.782,
	3.949, 3.522, 3.41, 3.351, 3.366,
	3.433, 3.545, 3.684, 3.841, 3.974,
	4.143, 4.377, 4.831, 5.544, 6.886,
	9.098, 12.809, 18.647, 26.089, 34.848,
	45.039};

/* Absolutes spectral sensitivity of panchromatic emulsion. log.  */
const static spectra_entry absolute_panchromatic[] = {
  {337.07194243011116, 0.047135149544788035},
  {338.2769364579749, 0.1294267981014965},
  {339.14068001310187, 0.21079121681531277},
  {340.58215190049447, 0.2758827517863658},
  {341.82141420119524, 0.35933343764669035},
  {343.2638014867538, 0.4312401119630027},
  {345.66109050572857, 0.5012790804529179},
  {347.1727197895808, 0.5807559241294173},
  {349.26050014530193, 0.6322171804099508},
  {351.5553473024728, 0.7014812496740204},
  {354.2263483794551, 0.7775604582833493},
  {357.30486977462795, 0.8400093882021586},
  {360.72449841697414, 0.9023192336445338},
  {364.82685930073484, 0.9682055370523521},
  {369.6110023333529, 1.0305948593384047},
  {374.7361245107772, 1.0918913750239043},
  {380.5437861829985, 1.1553293501084663},
  {387.37496245118774, 1.2197858731265079},
  {394.88764708716496, 1.2787071149612221},
  {402.3984975301567, 1.3239727900187916},
  {409.90693634903784, 1.3512839235730798},
  {417.4137787406909, 1.3667096564139274},
  {424.91973800238793, 1.375560486732447},
  {432.4253236321805, 1.3816296275222886},
  {439.92972043318616, 1.3788479379936112},
  {447.4330303050152, 1.3679740607451443},
  {454.93647604299133, 1.3581117069616515},
  {462.43975194828363, 1.3469849488469419},
  {469.94309578664945, 1.336363952464719},
  {477.4466094576992, 1.3270073604137123},
  {484.9499872626018, 1.3166392448977327},
  {492.4538745655559, 1.3100643423754046},
  {499.95830533309834, 1.30753553371297},
  {507.4640607955747, 1.3148690788340294},
  {514.9716164844999, 1.3356053098659881},
  {522.4805308348958, 1.3664567755476842},
  {529.9905321144684, 1.4054004289491688},
  {536.4796011983823, 1.462551504720179},
  {541.9459293685547, 1.5244440967332529},
  {548.4350409106396, 1.581911273587067},
  {555.945789454021, 1.6264183060459065},
  {563.4550095032479, 1.6595456995237932},
  {570.9640936863276, 1.691661569536706},
  {578.4719211075469, 1.7144208474986122},
  {585.978016235391, 1.7242832012821054},
  {593.4808166091685, 1.709616111039988},
  {600.9833792171887, 1.6931788547341662},
  {608.4876061855106, 1.6891327608742719},
  {615.992036953053, 1.6866039522118377},
  {623.4934107322862, 1.6613158655874973},
  {630.9939013815635, 1.6294528764408276},
  {638.4956487927012, 1.6069464793451642},
  {645.9985170995523, 1.592785150835534},
  {653.5023364694329, 1.5857044865807182},
  {661.008567463424, 1.5965783638291846},
  {668.517923378798, 1.630717280772045},
  {676.0275170599293, 1.6666263637786085},
  {683.53028346717, 1.6517063926702473},
  {691.034340602808, 1.6463958944791361},
  {698.5386694707402, 1.6431084432179714},
  {706.0464629254226, 1.6656148403136348},
  {713.5581285652969, 1.7169496561610469},
  {721.0694205732665, 1.7655027824797807},
  {728.5792180536184, 1.8029291506838052},
  {736.0819165277858, 1.7875034178429572},
  {741.5314805137359, 1.7245866583215976},
  {744.080135823604, 1.6517063926702473},
  {745.2661368963245, 1.5925954901858512},
  {746.6224207095011, 1.5313983205549464},
  {748.319674771486, 1.469042113620426},
  {749.6752113208537, 1.4022815649321667},
  {750.7569753194292, 1.3290304073436596},
  {752.6561462897808, 1.246136059389071},
  {753.7390810016572, 1.1816008623237533},
  {755.3665468510881, 1.1076079208609326},
  {757.3543433091768, 1.007281651859964},
  {758.7543005405186, 0.932608741845689},
  {760.1755210597564, 0.8469288409047437},
  {761.5306139212374, 0.7768650359011797},
  {762.5459586215976, 0.717058711034614},
  {763.9016819869174, 0.6516890071106931},
  {765.5288115676344, 0.5751925450720625},
  {766.9506117352574, 0.49382812635824624},
  {768.3058680606966, 0.42498131052347876},
  {769.3207768571682, 0.3619296812067887},
  {770.9478939834883, 0.2853404961838688},
  {772.3703293253488, 0.20870494966880404},
  {773.3838992741628, 0.13568559954102088},
  {773.709893110801, 0.02302717362958262},
};

/* Panchromatic emulsion wedge sensitivity to thungsten light.  */
const static spectra_entry wedge_thungsten_panchromatic[] = {
  {355.14229725410485, 0.033397353819889286},
  {358.33024315663425, 0.08409932860875857},
  {361.4818246572336, 0.13541217056375832},
  {364.560677353973, 0.18788566013440677},
  {367.5607405131974, 0.23736590059101426},
  {370.4517104666318, 0.28645344072653733},
  {373.50632022875124, 0.33357747925663883},
  {376.5609299908706, 0.3807015177867408},
  {379.61553975299, 0.4281397165737104},
  {382.88833592668936, 0.47707017658079964},
  {386.3793185119687, 0.5265504170374067},
  {389.870301097248, 0.5741064259207014},
  {393.7976565056872, 0.6214425226241889},
  {398.37957114886626, 0.6644453497846585},
  {403.17967220362533, 0.6966324961018857},
  {407.9797732583844, 0.7214225963710543},
  {412.7798743131434, 0.740814852226775},
  {417.5799753679025, 0.7576081459575026},
  {422.38007642266155, 0.7706029565824699},
  {427.18017747742056, 0.7821983260632102},
  {431.9802785321796, 0.7935937753804894},
  {436.7803795869387, 0.8029900230631584},
  {441.5804806416977, 0.8109868296015998},
  {446.3805816964568, 0.8157849135246646},
  {451.18068275121584, 0.8205829974477299},
  {455.98078380597485, 0.8229820394092622},
  {460.7808848607339, 0.8239816402265674},
  {465.580985915493, 0.8239816402265674},
  {470.381086970252, 0.8213826781015741},
  {475.18118802501107, 0.817384274832353},
  {479.98128907977014, 0.8139856320535155},
  {484.78139013452915, 0.806988426332379},
  {489.5814911892882, 0.7975921786497102},
  {494.3815922440473, 0.7867964898228141},
  {499.1816932988063, 0.7797992841016776},
  {503.98179435356536, 0.7789996034478335},
  {508.78189540832443, 0.7855969688420479},
  {513.5819964630834, 0.7977920988131713},
  {518.3820975178426, 0.8137857118900544},
  {523.1821985726016, 0.831578606438087},
  {527.9822996273606, 0.8499712614765025},
  {532.7824006821196, 0.86876375684184},
  {537.5825017368787, 0.8871564118802557},
  {542.3826027916377, 0.9051492265917491},
  {547.1827038463967, 0.9231420413032427},
  {551.9828049011559, 0.940735015687814},
  {556.7829059559149, 0.9571284690916191},
  {561.5830070106739, 0.9681240780819762},
  {566.383108065433, 0.9741216829858075},
  {571.183209120192, 0.9795195273992556},
  {575.9833101749512, 0.9797194475627167},
  {580.78341122971, 0.9727222418415802},
  {585.5835122844692, 0.9617266328512231},
  {590.3836133392283, 0.940335175360892},
  {595.1837143939872, 0.9215426799955544},
  {599.9838154487463, 0.9115466718225025},
  {604.7839165035055, 0.9073483483898206},
  {609.5840175582643, 0.9069485080628985},
  {614.3841186130235, 0.9129461129667298},
  {619.1842196677825, 0.9247414026109311},
  {623.9843207225415, 0.9309389276782232},
  {628.7844217773006, 0.9183439573801777},
  {632.3844975683699, 0.8734618806831744},
  {634.0208956552196, 0.8195833966304245},
  {634.8390946986444, 0.7648802419033978},
  {636.1482131681241, 0.7101770871763711},
  {637.4246036758668, 0.654209437415453},
  {638.7664501070836, 0.5966474243509334},
  {640.0428406148263, 0.5416144013541961},
  {641.5846912566581, 0.48287341465904365},
  {642.6938055155229, 0.43198817972033554},
  {644.4938434110575, 0.36832360366616745},
  {646.4575211152771, 0.3036144447579159},
  {648.2030124079167, 0.24203903441191565},
  {650.1182042428964, 0.17670679099421083},
  {651.912181404776, 0.11586442124756768},
  {653.8516161743756, 0.06259680436094861},
  {655.6213504016353, 0.02212685460477326},
};

/* Panchromatic emulsion wedge sensitivity to thungsten light.  */
const static spectra_entry wedge_Neopan_100_acros_daylight_5400k [] = {
  {380.1729818452725, 1.5732847620784898},
  {385.81266010382103, 1.5310698897253516},
  {391.61046018270264, 1.543692036238022},
  {397.62787390093587, 1.5757761441660834},
  {403.2060603404659, 1.5699302283904912},
  {409.0038604193476, 1.5370814898371168},
  {414.8016604982292, 1.534298199879324},
  {420.5994605771108, 1.5392176281567633},
  {426.39726065599245, 1.5426462077435126},
  {432.1950607348741, 1.543590039512445},
  {437.9928608137557, 1.5415521738999973},
  {443.79066089263733, 1.5340478630883534},
  {449.588460971519, 1.5185923592596957},
  {455.3862610504006, 1.4909615911237357},
  {461.1840611292822, 1.4526464073711645},
  {466.9818612081639, 1.4098586775465227},
  {472.77966128704554, 1.364834674685846},
  {478.57746136592715, 1.3205560961705145},
  {484.37526144480876, 1.2802531141636897},
  {490.1730615236904, 1.2479013251738782},
  {495.9708616025721, 1.2344336195994736},
  {501.5659413989753, 1.2578948398937064},
  {507.5664617603353, 1.292476583819997},
  {513.364261839217, 1.3359096032735946},
  {519.1620619180986, 1.3813304209814463},
  {524.9598619969802, 1.42699971347108},
  {530.7576620758618, 1.470184258142897},
  {536.5554621547435, 1.5101386306515514},
  {542.3532622336252, 1.5433841840521012},
  {548.1510623125067, 1.5587395531643709},
  {553.9488623913884, 1.5688769518592252},
  {559.7466624702699, 1.5879594426982198},
  {565.5444625491516, 1.6174778743720448},
  {571.3422626280333, 1.6452569825733976},
  {577.1400627069149, 1.6640909986306105},
  {582.9378627857966, 1.6610592338910364},
  {588.7356628646781, 1.62647117186519},
  {594.5334629435598, 1.5886529376761818},
  {600.2907189659458, 1.5551738055673625},
  {606.4218812871252, 1.5171827953158257},
  {611.9268631802047, 1.497064015905944},
  {617.7246632590864, 1.5191282041263188},
  {623.522463337968, 1.5660398705248606},
  {629.3202634168497, 1.582140663982475},
  {633.4489998366593, 1.5295525936078467},
  {634.8545271285093, 1.4730538556747668},
  {636.1722089646188, 1.4133671166384905},
  {637.602834958109, 1.3411195936516283},
  {638.5440362696158, 1.2762299674575592},
  {639.3346453712816, 1.2187343580789802},
  {640.4766362959097, 1.1586847065554307},
  {641.5307817647972, 1.0912561126093014},
  {643.6566417937206, 0.9619563256169599},
  {644.5300766107989, 0.8838306780362957},
  {645.6595181846069, 0.7975291825817941},
  {646.7136636534945, 0.7228640564195863},
  {647.9654613977984, 0.6462546830680491},
};
/* Process chart with regular step to a spectrum.
   cubically interpolate for missing data.  */

static void
compute_spectrum (spectrum s, luminosity_t start, luminosity_t end, int size,
		  const luminosity_t data[], bool absorbance, luminosity_t norm = 1)
{
  luminosity_t step = (end - start) / (luminosity_t) (size - 1);
  luminosity_t repnorm = 1 / norm;
  //printf ("start %i end %i step %f %i size\n",start,end,step,size);
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      int p = SPECTRUM_START + i * SPECTRUM_STEP;
      coord_t sp = (p - start) / (coord_t) step;
      int ri;
      coord_t rp = my_modf (sp, &ri);


      /* If out of range continue interpolating linearly.
       * ??? maybe this gets to too extreme values towards the end.  */
      if (ri < 1)
	{
	  rp += ri - 1;
	  ri = 1;
	  s[i] = data[1] + rp * (data[1] - data[0]);
#if 1
	  /* Just clamp when data are missing.  */
	  if (p < start)
	    {
	      s[i] = 0;
	      continue;
	    }
#endif
	}
      else if (ri >= size - 2)
	{
	  rp += ri - size + 2;
	  ri = size - 2;
	  s[i] = data[size - 2] + rp * (data[size - 1] - data[size - 2]);
#if 1
	  if (p > end)
	    {
	      s[i] = 0;
	      continue;
	    }
#endif
	}
      else
	s[i] =
	  cubic_interpolate (data[ri - 1], data[ri], data[ri + 1],
			     data[ri + 2], rp) * repnorm;
      if (absorbance)
	s[i] = absorbance_to_transmitance (s[i]) * repnorm;
    }
}

static void
compute_spectrum (spectrum s, const xspect &in)
{
  compute_spectrum (s, (luminosity_t)in.spec_wl_short, (luminosity_t)in.spec_wl_long, in.spec_n, in.spec, false, (luminosity_t)in.norm);
}

/* Process absorbance chart with regular step to a spectrum.
   Since I am lazy use linear interpolation.  */

void
compute_spectrum (spectrum s, int size, const spectra_entry * data, bool absorbance = false, luminosity_t norm = 1, luminosity_t max_transmitance = -1, luminosity_t min_transmitance = -1)
{
  /* Check that data are linearly ordered.  */
  luminosity_t repnorm = 1 / norm;
  for (int i = 1; i < size; i++)
    if (data[i-1].wavelength > data[i].wavelength)
      {
	printf ("%f %f\n", data[i-1].wavelength, data[i].wavelength);
        abort ();
      }
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      int p = SPECTRUM_START + i * SPECTRUM_STEP;
      int first;
      if (data[0].wavelength > p)
	{
	  first = 0;
	  //s[i]=0;continue;
	}
      else if (data[size - 1].wavelength < p)
	{
	  first = size - 2;
	  //s[i]=0;continue;
	}
      else
	for (first = 0; data[first + 1].wavelength < p; first++)
	  ;
      coord_t pos =
	(p - data[first].wavelength) / (data[first + 1].wavelength -
					data[first].wavelength);
      s[i] =
	(data[first].transmitance + (data[first + 1].transmitance -
				    data[first].transmitance) * pos) * repnorm;
      if (absorbance)
	s[i] = absorbance_to_transmitance (s[i]);
      if (max_transmitance > 0 && s[i] > max_transmitance * repnorm)
	      s[i] = max_transmitance * repnorm;
      if (min_transmitance >= 0 && s[i] < min_transmitance * repnorm)
	      s[i] = min_transmitance * repnorm;
    }
}

/* Taken from Argyll
   General temperature Daylight spectra from CIE 15.2004 Appendix C.   
   ## uses improved interpolation rather than CIE 15.2004 Section 3.1 ##   
   Assumong 1931 observer & 5 nm spacing. (Need Lagrange interpolated S0, S1 for 1nm)   
   i.e. 300 - 830nm at 5nm intervals.   
   Fill in the given xspect with the specified daylight illuminant   
   Return nz if temperature is out of range */
static int
daylight_il (spectrum spec, double ct)
{
  static double s0[107] = {
    0.04000, -0.15625, 6.00000, 16.56625, 29.60000,
    43.80000, 55.30000, 57.62500, 57.30000, 59.69375,
    61.80000, 61.47500, 61.50000, 65.46875, 68.80000,
    66.40625, 63.40000, 62.45000, 65.80000, 79.82500,
    94.80000, 101.54375, 104.80000, 106.54375, 105.90000,
    100.35000, 96.80000, 104.05000, 113.90000, 120.82500,
    125.60000, 126.54375, 125.50000, 123.39375, 121.30000,
    121.52500, 121.30000, 117.42500, 113.50000, 112.95625,
    113.10000, 112.19375, 110.80000, 108.36250, 106.50000,
    107.60000, 108.80000, 107.25000, 105.30000, 104.90625,
    104.40000, 102.39375, 100.00000, 97.78125, 96.00000,
    95.67500, 95.10000, 91.95625, 89.10000, 89.43750,
    90.50000, 90.60625, 90.30000, 89.61250, 88.40000,
    86.01250, 84.00000, 84.47500, 85.10000, 83.52500,
    81.90000, 81.90625, 82.60000, 84.01875, 84.90000,
    83.83125, 81.30000, 76.22500, 71.90000, 72.38125,
    74.30000, 76.31875, 76.40000, 69.45625, 63.30000,
    66.35000, 71.70000, 75.61250, 77.00000, 72.52500,
    65.20000, 54.40625, 47.70000, 57.28125, 68.60000,
    68.04375, 65.00000, 65.58750, 66.00000, 64.04375,
    61.00000, 56.48750, 53.30000, 55.43125, 58.90000,
    61.71875, 61.90000
  };

  static double s1[107] = {
    0.02000, -0.15000, 4.50000, 12.50500, 22.40000,
    33.40625, 42.00000, 42.46250, 40.60000, 41.23750,
    41.60000, 39.58750, 38.00000, 40.21875, 42.40000,
    40.94375, 38.50000, 35.98125, 35.00000, 38.80000,
    43.40000, 45.52500, 46.30000, 45.70625, 43.90000,
    40.37500, 37.10000, 36.52500, 36.70000, 36.48125,
    35.90000, 34.49375, 32.60000, 30.26875, 27.90000,
    26.06875, 24.30000, 22.21875, 20.10000, 18.07500,
    16.20000, 14.74375, 13.20000, 10.86875, 8.60000,
    7.18125, 6.10000, 5.13750, 4.20000, 3.05000,
    1.90000, 0.90625, 0.00000, -0.80000, -1.60000,
    -2.65000, -3.50000, -3.47500, -3.50000, -4.56250,
    -5.80000, -6.55625, -7.20000, -7.93125, -8.60000,
    -9.05000, -9.50000, -10.26875, -10.90000, -10.80625,
    -10.70000, -11.21250, -12.00000, -13.10625, -14.00000,
    -14.02500, -13.60000, -12.69375, -12.00000, -12.57500,
    -13.30000, -13.32500, -12.90000, -11.66250, -10.60000,
    -10.91875, -11.60000, -12.08750, -12.20000, -11.38750,
    -10.20000, -8.66250, -7.80000, -9.40000, -11.20000,
    -11.00000, -10.40000, -10.50625, -10.60000, -10.25000,
    -9.70000, -8.88125, -8.30000, -8.68125, -9.30000,
    -9.79375, -9.80000
  };

  static double s2[107] = {
    0.00000, 1.15625, 2.00000, 2.84375, 4.00000,
    6.41875, 8.50000, 8.50000, 7.80000, 7.29375,
    6.70000, 5.88125, 5.30000, 5.80625, 6.10000,
    4.71250, 3.00000, 2.05000, 1.20000, -0.10000,
    -1.10000, -0.93125, -0.50000, -0.53125, -0.70000,
    -0.87500, -1.20000, -1.91250, -2.60000, -2.84375,
    -2.90000, -2.88125, -2.80000, -2.69375, -2.60000,
    -2.63750, -2.60000, -2.21875, -1.80000, -1.61250,
    -1.50000, -1.38750, -1.30000, -1.25000, -1.20000,
    -1.12500, -1.00000, -0.75000, -0.50000, -0.38750,
    -0.30000, -0.15000, 0.00000, 0.10000, 0.20000,
    0.26250, 0.50000, 1.25000, 2.10000, 2.69375,
    3.20000, 3.68125, 4.10000, 4.43125, 4.70000,
    4.83750, 5.10000, 5.88750, 6.70000, 7.01875,
    7.30000, 7.91250, 8.60000, 9.25625, 9.80000,
    10.19375, 10.20000, 9.19375, 8.30000, 8.90000,
    9.60000, 9.22500, 8.50000, 7.64375, 7.00000,
    7.18125, 7.60000, 7.91875, 8.00000, 7.46875,
    6.70000, 5.73125, 5.20000, 6.24375, 7.40000,
    7.22500, 6.80000, 6.90000, 7.00000, 6.76875,
    6.40000, 5.87500, 5.50000, 5.71875, 6.10000,
    6.43125, 6.50000,
  };

  /* M values for [1nm,5nm][1931,1964][M1,M2][g, h, i, j, k, l] */
  double ms[2][2][2][6] = {
    {				/* 1nm */
     {
      {-1.77864, 5.90745, -1.34666, 0.25540, -0.73218, 0.02387},
      {-31.44505, 30.06408, 0.03656, 0.25540, -0.73218, 0.02387}
      },
     {
      {-1.57049, 5.56450, -1.31211, 0.21249, -0.71591, 0.04663},
      {-30.15166, 31.07906, -0.73912, 0.21249, -0.71591, 0.04663}
      }
     },
    {				/* 5nm */
     {
      {-1.77861, 5.90757, -1.34674, 0.25539, -0.73217, 0.02387},
      {-31.44464, 30.06400, 0.03638, 0.25539, -0.73217, 0.02387}
      },
     {
      {-1.57049, 5.56460, -1.31215, 0.21250, -0.71592, 0.04663},
      {-30.15139, 31.07931, -0.73928, 0.21250, -0.71592, 0.04663}
      }
     }
  };

  int i;
  double xd, yd;
  int sint = 1;			/* 5nm */
  int obs = 0;			/* 1931 */
  double m1, m2;

  if (ct < 2500.0 || ct > 25000.0)
    {				/* Only accurate down to about 4000 */
      abort ();
      return 1;
    }

  /* Compute chromaticity coordinates */
  if (ct < 7000.0)
    {
      xd =
	-4.6070e9 / (ct * ct * ct) + 2.9678e6 / (ct * ct) + 0.09911e3 / ct +
	0.244063;
    }
  else
    {
      xd =
	-2.0064e9 / (ct * ct * ct) + 1.9018e6 / (ct * ct) + 0.24748e3 / ct +
	0.237040;
    }
  yd = -3.000 * xd * xd + 2.870 * xd - 0.275;

  /* Compute m factors */
  m1 =
    (ms[sint][obs][0][0] * xd + ms[sint][obs][0][1] * yd +
     ms[sint][obs][0][2]) / (ms[sint][obs][0][3] * xd +
			     ms[sint][obs][0][4] * yd + ms[sint][obs][0][5]);
  m2 =
    (ms[sint][obs][1][0] * xd + ms[sint][obs][1][1] * yd +
     ms[sint][obs][1][2]) / (ms[sint][obs][1][3] * xd +
			     ms[sint][obs][1][4] * yd + ms[sint][obs][1][5]);

  /* Compute spectral values.
     Argyll starts from 300,w hile we start from 380 thus offset is 80/5=16. */
  for (i = 16; i < 16 + SPECTRUM_SIZE; i++)
    {
      spec[i - 16] = s0[i] + m1 * s1[i] + m2 * s2[i];
    }

#if 0
  sp->spec_n = 107;		/* 5nm spacing */
  sp->spec_wl_short = 300.0;
  sp->spec_wl_long = 830;
  sp->norm = 100.0;		/* Arbitrary */
#endif

  return 0;
}

}

/* Adjust xscale, yscale and zscale so dye rgb (1,1,1) results
   in intensity 1  */
void
spectrum_dyes_to_xyz::normalize_brightness ()
{
  spectrum s;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    s[i] = red [i] * rscale + green [i] * gscale + blue [i] * bscale;
  struct xyz ret = get_xyz (s);
  xscale = yscale = zscale = 1 / ret.y;
  if (debug)
    {
      printf ("Normalizing xyz luminosity range\n");
      printf ("Combined xyz %f %f %f\n", ret.x, ret.y, ret.z);
      printf ("rscale %f gscale %f bscale %f\n", rscale, gscale, bscale);
      printf ("xscale %f yscale %f zscale %f\n", xscale, yscale, zscale);
    }
}
/* Adjust xscale, yscale and zscale so dye rgb (1,1,1) results
   in sRGB white  */
void
spectrum_dyes_to_xyz::normalize_xyz_to_backlight_whitepoint ()
{
  xscale = yscale = zscale = 1;
  xyz whitepoint = whitepoint_xyz ();
  xyz dyewhitepoint = dyes_rgb_to_xyz (1, 1, 1);
  xscale = whitepoint.x / whitepoint.y / dyewhitepoint.x;
  yscale = 1 / dyewhitepoint.y;
  zscale = whitepoint.z / whitepoint.y / dyewhitepoint.z;

  if (debug)
    {
      printf ("Normalizing dyes to backlight by scaling xyz\n"
	      "Whitepoint xyz %f %f %f\n", whitepoint.x / whitepoint.y, whitepoint.y / whitepoint.y, whitepoint.z / whitepoint.y);
      printf ("Dye whitepoint xyz %f %f %f\n", dyewhitepoint.x, dyewhitepoint.y, dyewhitepoint.z);
      printf ("rscale %f gscale %f bscale %f\n", rscale, gscale, bscale);
      printf ("xscale %f yscale %f zscale %f\n", xscale, yscale, zscale);
      dyewhitepoint = dyes_rgb_to_xyz (1, 1, 1);
      printf ("Dye whitepoint xyz %f %f %f\n", dyewhitepoint.x, dyewhitepoint.y, dyewhitepoint.z);
    }
}

/* Autochrome screen was made by mixing dyes to be gray.  Simulate same thing: find
   rscale, gscale and wscale so together they produce a given.  */
void
spectrum_dyes_to_xyz::set_daylight_backlight (luminosity_t temperature)
{
  //compute_spectrum (backlight, 300, 830, sizeof (il_A)/sizeof (luminosity_t), il_A, false);
  daylight_il (backlight, temperature);
}

/* Autochrome screen was made by mixing dyes to be gray.  Simulate same thing: find
   rscale, gscale and wscale so together they produce a given.  */
void
spectrum_dyes_to_xyz::normalize_dyes (luminosity_t temperature)
{
  spectrum backlight_bck;
  memcpy (backlight_bck, backlight, sizeof (backlight));
  daylight_il (backlight, temperature);
  rscale = gscale = bscale = 1;
  xyz rxyz = get_xyz (red);
  xyz gxyz = get_xyz (green);
  xyz bxyz = get_xyz (blue);
  xyz whitepoint = whitepoint_xyz ();

  color_matrix m (rxyz.x, gxyz.x, bxyz.x, 0,
		  rxyz.y, gxyz.y, bxyz.y, 0,
		  rxyz.z, gxyz.z, bxyz.z, 0, 0, 0, 0, 1);
  color_matrix n = m.invert ();
  n.apply_to_rgb (whitepoint.x, whitepoint.y, whitepoint.z, &rscale, &gscale, &bscale);
  if (debug)
    {
      printf ("Normalizing dyes to be neutral at %fK daylight\n"
	      "Whitepoint xyz %f %f %f\n", temperature, whitepoint.x / whitepoint.y, whitepoint.y / whitepoint.y, whitepoint.z / whitepoint.y);
      printf ("Red dye xyz %f %f %f\n", rxyz.x, rxyz.y, rxyz.z);
      printf ("Green dye xyz %f %f %f\n", gxyz.x, gxyz.y, gxyz.z);
      printf ("Blue dye xyz %f %f %f\n", bxyz.x, bxyz.y, bxyz.z);
      printf ("rscale %f gscale %f bscale %f\n", rscale, gscale, bscale);
      printf ("xscale %f yscale %f zscale %f\n", xscale, yscale, zscale);
      xyz dyewhitepoint = dyes_rgb_to_xyz (1, 1, 1);
      printf ("Adjusted dye whitepoint xyz %f %f %f\n", dyewhitepoint.x, dyewhitepoint.y, dyewhitepoint.z);
    }

  memcpy (backlight, backlight_bck, sizeof (backlight));
}

void
change_concentration (spectrum s, luminosity_t concentration)
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    s[i] = pow (s[i], concentration);
}

void
spectrum_dyes_to_xyz::set_dyes_to_dufay (int measurement, luminosity_t age)
{
  spectrum new_red, new_green, new_blue;
  compute_spectrum (new_red, sizeof (color_cinematography_dufay_red) / sizeof (spectra_entry), color_cinematography_dufay_red, false, 100);
  compute_spectrum (new_green, sizeof (color_cinematography_dufay_green) / sizeof (spectra_entry), color_cinematography_dufay_green, false, 100);
  compute_spectrum (new_blue, sizeof (color_cinematography_dufay_blue) / sizeof (spectra_entry), color_cinematography_dufay_blue, false, 100);
  if (debug)
    printf ("Setting dyes to dufay measurement %i\n", measurement);
  if (measurement == 0)
    {
      compute_spectrum (red, sizeof (real_dufay_red) / sizeof (spectra_entry), real_dufay_red, true);
      compute_spectrum (green, sizeof (real_dufay_green) / sizeof (spectra_entry), real_dufay_green, true);
      compute_spectrum (blue, sizeof (real_dufay_blue) / sizeof (spectra_entry), real_dufay_blue, true);
    }
  else if (measurement == 1)
    {
      compute_spectrum (red, sizeof (real_dufay_red2) / sizeof (spectra_entry), real_dufay_red2, true);
      compute_spectrum (green, sizeof (real_dufay_green2) / sizeof (spectra_entry), real_dufay_green2, true);
      compute_spectrum (blue, sizeof (real_dufay_blue2) / sizeof (spectra_entry), real_dufay_blue2, true);
    }
  else if (measurement == 2)
    {
      compute_spectrum (red, sizeof (real_dufay_red3) / sizeof (spectra_entry), real_dufay_red3, true);
      compute_spectrum (green, sizeof (real_dufay_green3) / sizeof (spectra_entry), real_dufay_green3, true);
      compute_spectrum (blue, sizeof (real_dufay_blue3) / sizeof (spectra_entry), real_dufay_blue3, true);
    }
  else if (measurement == 3)
    {
      compute_spectrum (red, sizeof (real_dufay_red4) / sizeof (spectra_entry), real_dufay_red4, true);
      compute_spectrum (green, sizeof (real_dufay_green4) / sizeof (spectra_entry), real_dufay_green4, true);
      compute_spectrum (blue, sizeof (real_dufay_blue4) / sizeof (spectra_entry), real_dufay_blue4, true);
    }
  else if (measurement == 4)
    {
      compute_spectrum (red, sizeof (real_dufay_red5) / sizeof (spectra_entry), real_dufay_red5, true);
      compute_spectrum (green, sizeof (real_dufay_green5) / sizeof (spectra_entry), real_dufay_green5, true);
      compute_spectrum (blue, sizeof (real_dufay_blue5) / sizeof (spectra_entry), real_dufay_blue5, true);
    }
  else
    abort ();
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      red[i] = (new_red[i] * (1 - age) + red[i] * age) / 1;
      green[i] = (new_green[i] * (1 - age) + green[i] * age) / 1;
      blue[i] = (new_blue[i] * (1 - age) + blue[i] * age) / 1;
    }
#if 0
  change_concentration (red, 1);
  change_concentration (green, 1);
  change_concentration (blue, 1);
#endif
}
void
spectrum_dyes_to_xyz::set_dyes_to_dufay_manual ()
{
  compute_spectrum (red, sizeof (manual_dufay_red) / sizeof (spectra_entry), manual_dufay_red, false);
  compute_spectrum (green, sizeof (manual_dufay_green) / sizeof (spectra_entry), manual_dufay_green, false);
  compute_spectrum (blue, sizeof (manual_dufay_blue) / sizeof (spectra_entry), manual_dufay_blue, false);
}
void
spectrum_dyes_to_xyz::set_dyes_to_dufay_color_cinematography ()
{
  compute_spectrum (red, sizeof (color_cinematography_dufay_red) / sizeof (spectra_entry), color_cinematography_dufay_red, false, 100);
  compute_spectrum (green, sizeof (color_cinematography_dufay_green) / sizeof (spectra_entry), color_cinematography_dufay_green, false, 100);
  compute_spectrum (blue, sizeof (color_cinematography_dufay_blue) / sizeof (spectra_entry), color_cinematography_dufay_blue, false, 100);
}

void
spectrum_dyes_to_xyz::set_dyes_to_autochrome ()
{
  if (debug)
    printf ("Setting dyes to autochrome\n");
  compute_spectrum (red,
		    sizeof (autochrome_orange) / sizeof (spectra_entry),
		    autochrome_orange, false, 1);
  compute_spectrum (green,
		    sizeof (autochrome_green) / sizeof (spectra_entry),
		    autochrome_green, false, 1);
  compute_spectrum (blue,
		    sizeof (autochrome_violet) / sizeof (spectra_entry),
		    autochrome_violet, false, 1);
}
void
spectrum_dyes_to_xyz::set_dyes_to_autochrome2 (luminosity_t orange_erythrosine, luminosity_t orange_rose, luminosity_t orange_tartrazine,
					       luminosity_t green_patent, luminosity_t green_tartrazine,
					       luminosity_t violet_crystal, luminosity_t violet_flexo,
					       luminosity_t age)
{
  spectrum tartrazine, rose, erythrosine, patent, flexo, crystal;
  spectrum o2_rose, o2_erythrosine, o2_patent,  o2_flexo,  o2_crystal;
  FILE *f;
  if (debug)
    printf ("Setting dyes to autochrome by Casella Tsukada age %f\n", age);
  //compute_spectrum (tartrazine, 400, 700, sizeof tartrazine_data / sizeof (luminosity_t), tartrazine_data, false);
  compute_spectrum (tartrazine,
		    sizeof (tartrazine_paper_data) / sizeof (spectra_entry),
		    tartrazine_paper_data, false, 100);
  //compute_spectrum (rose, 400, 700, sizeof rose_data / sizeof (luminosity_t), rose_data, false);
  compute_spectrum (rose,
		    sizeof (rose_paper_data) / sizeof (spectra_entry),
		    rose_paper_data, false, 100);
  compute_spectrum (o2_rose,
		    sizeof (o2_rose_paper_data) / sizeof (spectra_entry),
		    o2_rose_paper_data, false, 100);
  //compute_spectrum (erythrosine, 400, 700, sizeof erythrosine_data / sizeof (luminosity_t), erythrosine_data, false);
  compute_spectrum (erythrosine,
		    sizeof (erythrosine_paper_data) / sizeof (spectra_entry),
		    erythrosine_paper_data, false, 100);
  compute_spectrum (o2_erythrosine,
		    sizeof (o2_erythrosine_paper_data) / sizeof (spectra_entry),
		    o2_erythrosine_paper_data, false, 100);
  //compute_spectrum (patent, 400, 700, sizeof patent_data / sizeof (luminosity_t), patent_data, false);
  compute_spectrum (patent,
		    sizeof (patent_paper_data) / sizeof (spectra_entry),
		    patent_paper_data, false, 100);
  compute_spectrum (o2_patent,
		    sizeof (o2_patent_paper_data) / sizeof (spectra_entry),
		    o2_patent_paper_data, false, 100);
  //compute_spectrum (flexo, 400, 700, sizeof flexo_data / sizeof (luminosity_t), flexo_data, false);
  compute_spectrum (flexo,
		    sizeof (flexo_paper_data) / sizeof (spectra_entry),
		    flexo_paper_data, false, 100);
  compute_spectrum (o2_flexo,
		    sizeof (o2_flexo_paper_data) / sizeof (spectra_entry),
		    o2_flexo_paper_data, false, 100);
  //compute_spectrum (crystal, 400, 700, sizeof crystal_data / sizeof (luminosity_t), crystal_data, false);
  compute_spectrum (crystal,
		    sizeof (crystal_paper_data) / sizeof (spectra_entry),
		    crystal_paper_data, false, 100);
  compute_spectrum (o2_crystal,
		    sizeof (o2_crystal_paper_data) / sizeof (spectra_entry),
		    o2_crystal_paper_data, false, 100);
  if (debug)
    {
      f = fopen ("/tmp/tartrazine-trans.dat", "w");
      print_transmitance_spectrum (f, tartrazine);
      fclose (f);
      f = fopen ("/tmp/rose-trans.dat", "w");
      print_transmitance_spectrum (f, rose);
      fclose (f);
      f = fopen ("/tmp/o2_rose-trans.dat", "w");
      print_transmitance_spectrum (f, o2_rose);
      fclose (f);
      f = fopen ("/tmp/erythrosine-trans.dat", "w");
      print_transmitance_spectrum (f, erythrosine);
      fclose (f);
      f = fopen ("/tmp/o2_erythrosine-trans.dat", "w");
      print_transmitance_spectrum (f, o2_erythrosine);
      fclose (f);
      f = fopen ("/tmp/patent-trans.dat", "w");
      print_transmitance_spectrum (f, patent);
      fclose (f);
      f = fopen ("/tmp/o2_patent-trans.dat", "w");
      print_transmitance_spectrum (f, o2_patent);
      fclose (f);
      f = fopen ("/tmp/flexo-trans.dat", "w");
      print_transmitance_spectrum (f, flexo);
      fclose (f);
      f = fopen ("/tmp/o2_flexo-trans.dat", "w");
      print_transmitance_spectrum (f, o2_flexo);
      fclose (f);
      f = fopen ("/tmp/crystal-trans.dat", "w");
      print_transmitance_spectrum (f, crystal);
      fclose (f);
      f = fopen ("/tmp/o2_crystal-trans.dat", "w");
      print_transmitance_spectrum (f, o2_crystal);
      fclose (f);
      daylight_il (backlight, 6500);
    }
#define scale(n,m,w) ((100-(100-((n)+(((m)-(n))*age)))*(w)*1.0)/100)
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      red[i] = (scale (erythrosine[i], o2_erythrosine[i], orange_erythrosine)* scale (rose[i], o2_rose[i], orange_rose) * scale (tartrazine[i], tartrazine[i], orange_tartrazine));
      green[i] = (scale (patent[i], o2_patent[i], green_patent) * scale (tartrazine[i], tartrazine[i], green_tartrazine));
      blue[i] = (scale (crystal[i], o2_crystal[i], violet_crystal) * scale (flexo[i], o2_flexo[i], violet_flexo));
    }
  debug_write_spectra ();
}

void
spectrum_dyes_to_xyz::debug_write_spectra ()
{
  FILE *f = fopen ("/tmp/red.dat", "wt");
  print_absorbance_spectrum (f, red);
  fclose (f);
  f = fopen ("/tmp/green.dat", "wt");
  print_absorbance_spectrum (f, green);
  fclose (f);
  f = fopen ("/tmp/blue.dat", "wt");
  print_absorbance_spectrum (f, blue);
  fclose (f);
  f = fopen ("/tmp/red-trans.dat", "wt");
  print_transmitance_spectrum (f, red);
  fclose (f);
  f = fopen ("/tmp/green-trans.dat", "wt");
  print_transmitance_spectrum (f, green);
  fclose (f);
  f = fopen ("/tmp/blue-trans.dat", "wt");
  print_transmitance_spectrum (f, blue);
  fclose (f);
  f = fopen ("/tmp/backlight.dat", "wt");
  print_transmitance_spectrum (f, backlight);
  fclose (f);
  f = fopen ("/tmp/x.dat", "wt");
  print_transmitance_spectrum (f, cie_cmf_x);
  fclose (f);
  f = fopen ("/tmp/y.dat", "wt");
  print_transmitance_spectrum (f, cie_cmf_y);
  fclose (f);
  f = fopen ("/tmp/z.dat", "wt");
  print_transmitance_spectrum (f, cie_cmf_z);
  fclose (f);
}

color_matrix
spectrum_dyes_to_xyz::xyz_matrix ()
{
	xyz r = dyes_rgb_to_xyz (1, 0, 0);
	xyz g = dyes_rgb_to_xyz (0, 1, 0);
	xyz b = dyes_rgb_to_xyz (0, 0, 1);
#if 0
	printf ("red %f %f %f\n",r.x, r.y, r.z);
	printf ("green %f %f %f\n",g.x, g.y, g.z);
	printf ("blue %f %f %f\n",b.x, b.y, b.z);
#endif
	color_matrix m (r.x, g.x, b.x, 0,
			r.y, g.y, b.y, 0,
			r.z, g.z, b.z, 0,
			0  , 0  , 0  , 1);
	return m;
}

bool
spectrum_dyes_to_xyz::is_linear ()
{
  const int steps = 16;
  const luminosity_t max_error = (0.5 / 65546);
  for (int r = 0; r < steps; r++)
    for (int g = 0; g < steps; g++)
      for (int b = 0; b < steps; b++)
        {
	  luminosity_t rr = r / (luminosity_t) steps;
	  luminosity_t gg = g / (luminosity_t) steps;
	  luminosity_t bb = b / (luminosity_t) steps;
	  xyz v1 = dyes_rgb_to_xyz (rr, gg, bb);
	  xyz v2 = xyz::from_linear_srgb (rr, gg, bb);
	  if (fabs (v1.x - v2.x) > max_error
	      || fabs (v1.y - v2.y) > max_error
	      || fabs (v1.z - v2.z) > max_error)
	    return false;
        }
  return true;
}

/* Return XYZ of a daylight with given TEMPERATURE.  */
xyz
spectrum_dyes_to_xyz::temperature_xyz (luminosity_t temperature)
{
  spectrum_dyes_to_xyz dyes;
  dyes.set_daylight_backlight (temperature);
  return dyes.whitepoint_xyz ();
}

/* Compute XYZ values.  */
static inline struct xyz
get_xyz_old_observer (spectrum backlight, spectrum s, const char *filename = NULL)
{
  struct xyz ret = { 0, 0, 0 };
  luminosity_t sum = 0;
  FILE *f = NULL;
  if (filename)
     f = fopen(filename, "wt");
  /* TODO: CIE recommends going by 1nm bands and interpolate.
     We can implement that easily if that makes difference.  */
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      ret.x += (cie_cmf_x[i] * s[i] * backlight[i]);
      ret.y += (cie_cmf_y[i] * s[i] * backlight[i]);
      ret.z += (cie_cmf_z[i] * s[i] * backlight[i]);
      sum += cie_cmf_y[i] * backlight[i];
      if (f)
        fprintf (f, "%i %f\n", i * SPECTRUM_STEP + SPECTRUM_START, s[i] * backlight[i]);
    }
  if (f)
    fclose (f);
  luminosity_t scale = 1 / sum;
  ret.x *= scale;
  ret.y *= scale;
  ret.z *= scale;
  /* Argyll scales by backlight.  */
  return ret;
}

void
spectrum_dyes_to_xyz::set_il_A_backlight ()
{
  compute_spectrum (backlight, 300, 830, sizeof (il_A)/sizeof (luminosity_t), il_A, false);
}
void
spectrum_dyes_to_xyz::set_il_B_backlight ()
{
  compute_spectrum (backlight, 320, 780, sizeof (il_B)/sizeof (luminosity_t), il_B, false);
}
void
spectrum_dyes_to_xyz::set_il_C_backlight ()
{
  compute_spectrum (backlight, 320, 780, sizeof (il_B)/sizeof (luminosity_t), il_C, false);
}

xyz
combined_xyz (luminosity_t *dye1, luminosity_t *dye2, luminosity_t *backlight, const char *filename = NULL, const char *filename2 = NULL)
{
  spectrum tmp;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      tmp [i] = (dye1 ? dye1[i] : 1) * (dye2 ? dye2[i] : 1);
    }
  if (filename)
    {
      FILE *f = fopen (filename, "wt");
      print_transmitance_spectrum (f, tmp);
      fclose (f);
    }

  xyz ret = get_xyz_old_observer (backlight, tmp, filename2);
  return ret;
}

/* Simulate density of recording BACKLIGHT filtred by FILTER1 and FILTER2
   on film with sensitivity RESPONSE.

   RESPONSE is not wedge histogram, but transmitance loss computed by
   log_sensitivity_to_reversal_transmitance

   BACKLIGHT may be NULL if film response is already relative to some backlight.
   FILTER2 may be NULL if filter is missing.  */

luminosity_t
simulated_response (luminosity_t *backlight, luminosity_t *response, luminosity_t *filter1 = NULL, luminosity_t *filter2 = NULL)
{
  luminosity_t sum = 0;
  luminosity_t rsum = 0;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      luminosity_t val = response[i];
      assert (val >= 0);
      if (backlight)
	{
	   assert (backlight[i]>0);
	   val *= backlight[i];
	}
      rsum += val;
      if (filter1)
	{
	  val *= filter1[i];
	  assert (filter1[i] >= 0 && filter1[i] <= 1);
	}
      if (filter2)
        {
          assert (filter2[i] >= 0 && filter2[i] <= 1);
	  val *= filter2[i];
        }
      sum += val;
    }
  return sum / rsum;
}

/* Wedge histograms seems to be log sensitivity.  Lets assume that it is base 10 logarithm.
   Sensitivity is the reciprocal of time needed to obtain given density.  For reversal film
   I assume that it is reciprocal of time needed to get maximal brightness.  So to translate
   this to linear data and assuming that iflm is linear it should be 1/time, where time is
   10^{1/response}.  */

void
log_sensitivity_to_reversal_transmitance(spectrum response)
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
  {
    if (response[i]>0)
      //response[i] = 1/ (pow(10,1/response[i]));
      // We do flipping positive to negative by 1/density.  This should be done by
      // characteristic curve.
      response[i] = pow(10,response[i]);
    else
      response[i]=0;
  }
}

/* Increase/decrease concentration of filter S to reach luminosity Y.
   NORM is base for no filter, i.e. estimated density of film base.  */

luminosity_t
adjust_concentration_to_y (spectrum backlight, spectrum s, luminosity_t y, luminosity_t norm = 1)
{
  luminosity_t bestc = 0, bestc_y = 1;
  luminosity_t sum = 0;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    sum += cie_cmf_y[i] * backlight[i];
  for (luminosity_t c = 0.001 ; c < 10; c+=0.001)
    {
      luminosity_t ysum = 0;
      for (int i = 0; i < SPECTRUM_SIZE; i++)
	ysum += (cie_cmf_y[i] * my_pow (s[i] / norm, c) * norm * backlight[i]) ;
      ysum /= sum;
      //printf ("%f %f %f\n",y, ysum, bestc_y);
      if (fabs (ysum - y) < fabs (bestc_y - y))
	{
	  bestc_y = ysum;
	  bestc = c;
	}
    }
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    s[i] = my_pow (s[i]/norm, bestc) * norm;
  return bestc;
}
color_matrix
dufaycolor_correction_matrix ()
{
  const bool output_tiffs = true;
  const bool output_spectra = true;
  const bool verbose = true;
  void *buffer;
  size_t len;

  xyz whitep = xyz::from_linear_srgb (1, 1, 1);

#if 1
  //xyz target_red_xyz = xyY_to_xyz (0.633, 0.365, 0.177);
  //xyz target_green_xyz = xyY_to_xyz (0.233, 0.647, 0.43);
  //xyz target_blue_xyz = xyY_to_xyz (0.140, 0.089, 0.037);
  xyz target_red_xyz = dufaycolor::red_dye;
  xyz target_green_xyz = dufaycolor::green_dye;
  xyz target_blue_xyz = dufaycolor::blue_dye;

  color_matrix cm = dufaycolor::corrected_dye_matrix ();
  luminosity_t rw, gw,bw;
  cm.normalize_grayscale (whitep.x, whitep.y, whitep.z, &rw, &gw, &bw);
  printf ("Scaling weights %f %f %f\n",rw,gw,bw);
#else
  xyz target_red_xyz = xyY_to_xyz (0.6345861569, 0.3649735847, 0.177);
  xyz target_green_xyz = xyY_to_xyz (0.2987423914, 0.6949214652, 0.43);
  xyz target_blue_xyz = xyY_to_xyz (0.133509341, 0.04269239, 0.037);
#endif
  //xy_t best_white(0.33,0.33);  // neutral white
  //xy_t best_white(0.31006, 0.31616); // Illuminant C white
  //xy_t best_white(0.34842,0.35161); // Illuminant B white
  xy_t best_white(0.44757, 0.40745); // Illuminant A white
#if 0
  bool best_white_found = 0;
  luminosity_t best_white_dist = 0;
  for (luminosity_t x = 0.01; x < 1; x += 0.01)
    for (luminosity_t y = 0.01; y < 1; y += 0.01)
      {
	xy_t w (x, y);
	luminosity_t d1 = dominant_wavelength (target_red_xyz, w);
	luminosity_t d2 = dominant_wavelength (target_green_xyz, w);
        luminosity_t d3 = dominant_wavelength (target_blue_xyz, w);
	if (!d1 || !d2 || !d3)
	  continue;
	luminosity_t d = abs (601.7 - d1) + abs (549.6 - d2) + abs (466 - d3);
	if (!best_white_found || d < best_white_dist)
	{
	  best_white = w;
	  best_white_dist = d;
	  best_white_found = true;
	}
      }
#endif
  //xy_t ilc_white = {0.31006, 0.31616};
  //xy_t ilc_white = {0.33, 0.33};
  printf ("Best white %f %f\n", best_white.x, best_white.y);
  printf ("Target red %f %f %f, dominant wavelength %f\n", target_red_xyz.x, target_red_xyz.y, target_red_xyz.z, dominant_wavelength (target_red_xyz, best_white));
  printf ("Target green %f %f %f, dominant wavelength %f\n", target_green_xyz.x, target_green_xyz.y, target_green_xyz.z, dominant_wavelength (target_green_xyz, best_white));
  printf ("Target blue %f %f %f, dominant wavelength %f\n", target_blue_xyz.x, target_blue_xyz.y, target_blue_xyz.z, dominant_wavelength (target_blue_xyz, best_white));

  color_matrix cm2 (target_red_xyz.x, target_green_xyz.x, target_blue_xyz.x, 0,
		    target_red_xyz.y, target_green_xyz.y, target_blue_xyz.y, 0,
		    target_red_xyz.z, target_green_xyz.z, target_blue_xyz.z, 0,
		    0,0,0, 1);
  cm2.normalize_grayscale (whitep.x, whitep.y, whitep.z, &rw, &gw, &bw);
  printf ("Scaling weights %f %f %f\n",rw,gw,bw);

  /* f0 contains the primaries as specified in Color Cinematography book using xyY values.  */
  if (output_tiffs)
    {
      len = create_wide_gammut_rgb_profile (&buffer);
      tiff_writer_params par;
      par.filename="/tmp/f0.tif";
      par.width = par.height = 19;
      par.height = 19;
      par.height = 19;
      par.depth = 32;
      par.hdr = true;
      par.icc_profile = buffer;
      par.icc_profile_len = len;
      const char *error;
      tiff_writer tiff (par, &error);
      luminosity_t r,g,b;
      for (int i = 0; i < 19; i++)
	{
	  for (int j = 0; j < 19; j++)
	    tiff.put_hdr_pixel (j, 0, 0, 0);
	  luminosity_t br = 1;
	  int mul = 1;
	  xyz f = target_red_xyz;
	  xyz_to_wide_gammut_rgb (f.x * br, f.y * br, f.z * br, &r, &g, &b);
	  tiff.put_hdr_pixel (4, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (5, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (6, r*mul, g*mul, b*mul);
	  f = target_green_xyz;
	  xyz_to_wide_gammut_rgb (f.x * br, f.y * br, f.z * br, &r, &g, &b);
	  tiff.put_hdr_pixel (8, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (9, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (10, r*mul, g*mul, b*mul);
	  f = target_blue_xyz;
	  xyz_to_wide_gammut_rgb (f.x * br, f.y * br, f.z * br, &r, &g, &b);
	  tiff.put_hdr_pixel (12, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (13, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (14, r*mul, g*mul, b*mul);
	  tiff.write_row ();
	}
    }

  /* Compute red, green, blue and transparent filters using spectra in Color Cinematography.   */
  spectrum red, green, blue, white;
  luminosity_t lmax = 96;
  compute_spectrum (red, sizeof (color_cinematography_dufay_red) / sizeof (spectra_entry), color_cinematography_dufay_red, false, 100, lmax);
  compute_spectrum (green, sizeof (color_cinematography_dufay_green) / sizeof (spectra_entry), color_cinematography_dufay_green, false, 100, lmax);
  compute_spectrum (blue, sizeof (color_cinematography_dufay_blue) / sizeof (spectra_entry), color_cinematography_dufay_blue, false, 100, lmax);
  bool cut = false;
  if (cut)
    {
      for (int i = 0 ; SPECTRUM_START + i * SPECTRUM_STEP < 400; i++)
	red[i] = green[i] = blue[i] = 0;
      for (int i = SPECTRUM_SIZE - 1 ; SPECTRUM_START + i * SPECTRUM_STEP > 720; i--)
	red[i] = green[i] = blue[i] = 0;
    }

#if 0
  if (output_spectra)
    {
      FILE *f = fopen ("/tmp/dufay-filter-red.dat", "wt");
      print_transmitance_spectrum (f, red);
      fclose (f);
      f = fopen ("/tmp/dufay-filter-green.dat", "wt");
      print_transmitance_spectrum (f, green);
      fclose (f);
      f = fopen ("/tmp/dufay-filter-blue.dat", "wt");
      print_transmitance_spectrum (f, blue);
      fclose (f);
    }
#endif
  for (int i = 0; i < SPECTRUM_SIZE; i++)
	  white[i]=1;

  /* Try to match densities of filters specified using spectra to ones in the book.
     For that we need to guess the baclight used to do the xyz measurements.
     This is not specified in the book.  hope that one of the three 1931 CIE illuminants was used.   */

  spectrum dufay_backlight;
  compute_spectrum (dufay_backlight, 320, 780, sizeof (il_A)/sizeof (luminosity_t), il_A, false);
  //compute_spectrum (dufay_backlight, 320, 780, sizeof (il_B)/sizeof (luminosity_t), il_B, false);
  //compute_spectrum (dufay_backlight, 320, 780, sizeof (il_C)/sizeof (luminosity_t), il_C, false);
  const bool concentrations = false;
  if (concentrations)
    {
      luminosity_t a = adjust_concentration_to_y (dufay_backlight, red, 0.177, lmax/100);
      printf ("Red filter concentration adjustment: %f\n",a);
      a = adjust_concentration_to_y (dufay_backlight, green, 0.43, lmax/100);
      printf ("Green filter concentration adjustment: %f\n",a);
      a = adjust_concentration_to_y (dufay_backlight, blue, 0.037, lmax/100);
      printf ("Blue filter concentration adjustment: %f\n",a);
    }

  /* Compute XYZ values using 1931 CIE observer.  */
  xyz filter_white = get_xyz_old_observer (dufay_backlight, white, output_spectra ? "/tmp/dufay-backlight.dat" : NULL);
  xyz filter_red = get_xyz_old_observer (dufay_backlight, red, output_spectra ? "/tmp/dufay-red-backlight.dat" : NULL);
  xyz filter_green = get_xyz_old_observer (dufay_backlight, green, output_spectra ? "/tmp/dufay-green-backlight.dat" : NULL);
  xyz filter_blue = get_xyz_old_observer (dufay_backlight, blue, output_spectra ? "/tmp/dufay-blue-backlight.dat" : NULL);

  /* Optionally scale to values as given in the book.  */
  const bool scale = false;
  luminosity_t white_scale = scale ? 1 / filter_white.y : 1;
  luminosity_t red_scale = scale ? 0.177 / filter_red.y : 1;
  luminosity_t green_scale = scale ? 0.43 / filter_green.y : 1;
  luminosity_t blue_scale = scale ? 0.037 / filter_blue.y : 1;

  if (scale)
    {
      filter_white *= white_scale;
      filter_red *= red_scale;
      filter_green *= green_scale;
      filter_blue *= blue_scale;
      /* To make mxing go right, we need to scale transmitance data.  */
      for (int i = 0; i < SPECTRUM_SIZE; i++)
	{
	  red[i] *= red_scale;
	  green[i] *= green_scale;
	  blue[i] *= blue_scale;
#if 0
	  /* Allow small corrections if scales are more than 1.  */
	  if (red[i] > 1 && red[i] < 1.1)
	    red[i]=1;
	  if (green[i] > 1 && green[i] < 1.1)
	    green[i]=1;
	  if (blue[i] > 1 && blue[i] < 1.1)
	    blue[i]=1;
#endif
	  assert (red[i]>=0 && green[i]>=0 && blue[i]>=0);
	  assert (red[i]<=1 && green[i]<=1 && blue[i]<=1);
	}
    }
  luminosity_t x,y,Y;
  xyz_to_xyY (filter_white.x, filter_white.y, filter_white.z, &x, &y, &Y);
  if (verbose)
    printf ("no filter xyY:   %f %f %f scaled by:%f\n", x, y, Y, white_scale);
  xyz_to_xyY (filter_red.x, filter_red.y, filter_red.z, &x, &y, &Y);
  if (verbose)
    printf ("Red filter xyY:   %f %f %f deltaE %f scaled by:%f wavelength:%f\n", x, y, Y, deltaE (target_red_xyz, filter_red), red_scale, dominant_wavelength (filter_red, best_white));
  xyz_to_xyY (filter_green.x, filter_green.y, filter_green.z, &x, &y, &Y);
  if (verbose)
    printf ("Green filter xyY: %f %f %f deltaE %f scaled by:%f wavelength:%f\n", x, y, Y, deltaE (target_green_xyz, filter_green), green_scale, dominant_wavelength (filter_green, best_white));
  xyz_to_xyY (filter_blue.x, filter_blue.y, filter_blue.z, &x, &y, &Y);
  if (verbose)
    printf ("Blue filter xyY:  %f %f %f deltaE %f scaled by:%f wavelength:%f\n", x, y, Y, deltaE (target_blue_xyz, filter_blue), blue_scale, dominant_wavelength (filter_blue, best_white));


  /* Output tiff with simulated filters.  */
  if (output_tiffs)
    {
      tiff_writer_params par;
      par.filename="/tmp/f1b.tif";
      par.width = par.height = 19;
      par.depth = 32;
      par.hdr = true;
      par.icc_profile = buffer;
      par.icc_profile_len = len;
      const char *error;
      tiff_writer tiff (par, &error);
      luminosity_t r,g,b;
      for (int i = 0; i < 19; i++)
	{
	  luminosity_t br = 1;
	  int mul = 1;
	  xyz_to_wide_gammut_rgb (filter_white.x * br, filter_white.y * br, filter_white.z * br, &r, &g, &b);
	  for (int j = 0; j < 19; j++)
	    tiff.put_hdr_pixel (j, r*mul, g*mul, b*mul);
	  tiff.write_row ();
	}
    }
  if (output_tiffs)
    {
      tiff_writer_params par;
      par.filename="/tmp/f1.tif";
      par.width = 19;
      par.height = 19;
      par.depth = 32;
      par.hdr = true;
      par.icc_profile = buffer;
      par.icc_profile_len = len;
      const char *error;
      tiff_writer tiff (par, &error);
      luminosity_t r,g,b;
      for (int i = 0; i < 19; i++)
	{
	  luminosity_t br = 1;
	  int mul = 1;
	  xyz_to_wide_gammut_rgb (filter_white.x * br, filter_white.y * br, filter_white.z * br, &r, &g, &b);
	  for (int j = 0; j < 19; j++)
	    tiff.put_hdr_pixel (j, r*mul, g*mul, b*mul);
	  xyz_to_wide_gammut_rgb (filter_red.x * br, filter_red.y * br, filter_red.z * br, &r, &g, &b);
	  tiff.put_hdr_pixel (4, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (5, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (6, r*mul, g*mul, b*mul);
	  xyz_to_wide_gammut_rgb (filter_green.x * br, filter_green.y * br, filter_green.z * br, &r, &g, &b);
	  tiff.put_hdr_pixel (8, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (9, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (10, r*mul, g*mul, b*mul);
	  xyz_to_wide_gammut_rgb (filter_blue.x * br, filter_blue.y * br, filter_blue.z * br, &r, &g, &b);
	  tiff.put_hdr_pixel (12, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (13, r*mul, g*mul, b*mul);
	  tiff.put_hdr_pixel (14, r*mul, g*mul, b*mul);
	  tiff.write_row ();
	}
    }

  /* Now output tiff with overlapping filters.  */
  if (output_tiffs)
    {
      tiff_writer_params par;
      par.filename="/tmp/f2.tif";
      par.width = 19;
      par.height = 19;
      par.depth = 32;
      par.hdr = true;
      par.icc_profile = buffer;
      par.icc_profile_len = len;
      const char *error;
      tiff_writer tiff (par, &error);
      luminosity_t r,g,b;
      for (int i = 0; i < 5; i++)
	{
	  int br = /*200*/1;
	  for (int d = 0; d < (i == 4 ? 3 : 4); d++)
	    {
	      xyz_to_wide_gammut_rgb (filter_white.x * br, filter_white.y * br, filter_white.z * br, &r, &g, &b);
	      int i1 = i == 0 || i == 4 || d == 3 ? -1 : i-1;
	      for (int j = 0; j < 19; j++)
		tiff.put_hdr_pixel (j, r, g, b);
	      for (int j = 0; j < 5; j++)
		{
		  xyz_to_wide_gammut_rgb (filter_white.x * br, filter_white.y * br, filter_white.z * br, &r, &g, &b);
		  for (int d2 = 0; d2 < (j == 4 ? 3 : 4); d2++)
		    {
		      int mul = 1;
		      const char *filename = NULL;
		      const char *filename2 = NULL;
		      std::string sfile, sfile2;
		      int i2 = j == 0 || j == 4 || d2 == 3 ? -1 : j-1;
		      if (output_spectra)
			{
			  const char *name[3]={"red","green","blue"};
			  sfile = std::string ("/tmp/");
			  sfile2 = std::string ("/tmp/");
			  if (i1 >= 0)
			    {
			      sfile = sfile + std::string (name[i1]);
			      sfile2 = sfile2 + std::string (name[i1]);
			    }
			  if (i2 >= 0)
			    {
			      sfile = sfile + std::string (name[i2]);
			      sfile2 = sfile2 + std::string (name[i2]);
			    }
			  sfile = sfile + ".dat";
			  sfile2 = sfile2 + "-backlight.dat";
			  filename = sfile.c_str ();
			  filename2 = sfile2.c_str ();
			}
		      xyz f = combined_xyz (i1 < 0 ? NULL : i1 == 0 ? red : i1 == 1 ? green : blue,
					    i2 < 0 ? NULL : i2 == 0 ? red : i2 == 1 ? green : blue,
					    dufay_backlight, filename, filename2);
		      int br2 = (i && j) ? br : 1;
		      xyz_to_wide_gammut_rgb (f.x * br2, f.y * br2, f.z * br2, &r, &g, &b);
		      tiff.put_hdr_pixel (j*4+d2, r*mul, g*mul, b*mul);
		    }
		}
	      tiff.write_row ();
	    }
	}
    }

  /* Simulate film response.
     It is not clear what panchromatic emulsion was used.  We probabl want to simulate response in daylight.  */
  spectrum response;
  //compute_spectrum (response, sizeof (wedge_thungsten_panchromatic) / sizeof (spectra_entry), wedge_thungsten_panchromatic, false);
  compute_spectrum (response, sizeof (wedge_Neopan_100_acros_daylight_5400k) / sizeof (spectra_entry), wedge_Neopan_100_acros_daylight_5400k, false);
  luminosity_t *backlight = NULL;

#if 0
  compute_spectrum (response, sizeof (absolute_panchromatic) / sizeof (spectra_entry), absolute_panchromatic, false);
  spectrum daylight;
  daylight_il (daylight, 5400);
  backlight = daylight;
#endif
  //daylight_il (backlight, 6500);

  //daylight_il (backlight, 6500);
  log_sensitivity_to_reversal_transmitance (response);

  /* Simulate response.  */
  rgbdata dred = {0,0,0}, dgreen = {0,0,0}, dblue = {0,0,0}, dwhite = {0,0,0};

  dred.red   = simulated_response (backlight, response, red, red);
  dred.green = simulated_response (backlight, response, red, green);
  dred.blue  = simulated_response (backlight, response, red, blue);
  dgreen.red   = simulated_response (backlight, response, green, red);
  dgreen.green = simulated_response (backlight, response, green, green);
  dgreen.blue  = simulated_response (backlight, response, green, blue);
  dblue.red   = simulated_response (backlight, response, blue, red);
  dblue.green = simulated_response (backlight, response, blue, green);
  dblue.blue  = simulated_response (backlight, response, blue, blue);
  dwhite.red   = simulated_response (backlight, response, red);
  dwhite.green = simulated_response (backlight, response, green);
  dwhite.blue  = simulated_response (backlight, response, blue);
  luminosity_t dglass = simulated_response (backlight, response);

  //double m = std::max (dwhite.red, std::max (dwhite.green, dwhite.blue));
  dred = dred * (1/dglass);
  dgreen = dgreen * (1/dglass);
  dblue = dblue * (1/dglass);
  dwhite = dwhite * (1/dglass);

  color_matrix m (filter_red.x, filter_green.x, filter_blue.x, 0,
		  filter_red.y, filter_green.y, filter_blue.y, 0,
		  filter_red.z, filter_green.z, filter_blue.z, 0,
		  0, 0, 0, 1);
  xyz whitepp = xyz::from_linear_srgb (1, 1, 1);
  m.normalize_grayscale (whitepp.x, whitepp.y, whitepp.z);


  printf ("white: %f %f %f\n", dwhite.red, dwhite.green, dwhite.blue);
  printf ("red: %f %f %f\n", dred.red, dred.green, dred.blue);
  printf ("green: %f %f %f\n", dgreen.red, dgreen.green, dgreen.blue);
  printf ("blue: %f %f %f\n", dblue.red, dblue.green, dblue.blue);
  if (output_tiffs)
    {
      tiff_writer_params par;
      par.filename="/tmp/f3.tif";
      par.width = 23;
      par.height = 19;
      par.depth = 32;
      par.hdr = true;
      par.icc_profile = buffer;
      par.icc_profile_len = len;
      const char *error;
      tiff_writer tiff (par, &error);
      luminosity_t gamma = 2.8;

#if 0
      int mul = 1;
      tiff.put_hdr_pixel (0, mul, mul, mul);
      luminosity_t val = invert_gamma (dwhite.red, gamma) * mul;
      tiff.put_hdr_pixel (1, val, val, val);
      val = invert_gamma (dwhite.green, gamma) * mul;
      tiff.put_hdr_pixel (2, val, val, val);
      val = invert_gamma (dwhite.blue, gamma) * mul;
      tiff.put_hdr_pixel (3, val, val, val);
      xyz c = (filter_red* dwhite.red) + (filter_green * dwhite.green) + (filter_blue * dwhite.blue);
      luminosity_t r,g,b;
      xyz_to_wide_gammut_rgb (c.x, c.y, c.z, &r, &g, &b);
      r = invert_gamma (r, gamma);
      g = invert_gamma (g, gamma);
      b = invert_gamma (b, gamma);
      tiff.put_hdr_pixel (4, r*mul, g*mul, b*mul);
      tiff.write_row ();
      for (int i = 0; i < 3; i++)
      {
	luminosity_t v = i == 0 ? dwhite.red : i == 1 ? dwhite.green : dwhite.blue;
	val = invert_gamma (v, gamma) * mul;
	tiff.put_hdr_pixel (0, val, val, val);
	rgbdata &f = i == 0 ? dred : i == 1 ? dgreen : dblue;
	val = invert_gamma (f.red, gamma) * mul;
	tiff.put_hdr_pixel (1, val, val, val);
	val = invert_gamma (f.green, gamma) * mul;
	tiff.put_hdr_pixel (2, val, val, val);
	val = invert_gamma (f.blue, gamma) * mul;
	tiff.put_hdr_pixel (3, val, val, val);
	xyz c = (filter_red * f.red) + (filter_green * f.green) + (filter_blue * f.blue);
	xyz_to_wide_gammut_rgb (c.x, c.y, c.z, &r, &g, &b);
	//printf ("RGB %f %f %f %f %f %f\n", f.red, f.green, f.blue,r,g,b);
	tiff.put_hdr_pixel (4, r*mul, g*mul, b*mul);
	tiff.write_row ();
#endif
      for (int i = 0; i < 5; i++)
	{
	  for (int d = 0; d < (i == 4 ? 3 : 4); d++)
	    {
	      int i1 = i == 0 || i == 4 || d == 3 ? -1 : i-1;
	      luminosity_t g = invert_gamma (dglass, gamma);
	      for (int j = 0; j < 19; j++)
		tiff.put_hdr_pixel (j, g, g, g);
	      for (int j = 0; j < 5; j++)
		{
		  for (int d2 = 0; d2 < (j == 4 ? 3 : 4); d2++)
		    {
		      luminosity_t dd;

		      int i2 = j == 0 || j == 4 || d2 == 3 ? -1 : j-1;
		      if (i1 == -1 && i2 == -1)
			dd = dglass;
		      else if (i1 == -1 || i2 == -1)
			{
			  int c = i1 == -1 ? i2 : i1;
			  dd = dwhite[c];
			}
		      else if (i1 == 0)
			dd = dred[i2];
		      else if (i1 == 1)
			dd = dgreen[i2];
		      else 
			dd = dblue[i2];
		      g = invert_gamma (dd, gamma);
		      tiff.put_hdr_pixel (j*4+d2, g,g,g);
		    }
		}
	      luminosity_t r=1, b=1;
	      g=1;
	      if (i1 != -1 || (i == 0 && d < 3))
		{
		  rgbdata &f = i == 0 ? dwhite : (i1 == 0) ? dred : (i1 == 1) ? dgreen : dblue;
		  //xyz c = (filter_red * f.red) + (filter_green * f.green) + (filter_blue * f.blue);
		  xyz c (0,0,0);
		  m.apply_to_rgb (f.red, f.green, f.blue, &c.x, &c.y, &c.z);
		  xyz_to_wide_gammut_rgb (c.x, c.y, c.z, &r, &g, &b);
		}
	      tiff.put_hdr_pixel (19, 0, 0, 0);
	      tiff.put_hdr_pixel (20, r, g, b);
	      tiff.put_hdr_pixel (21, r, g, b);
	      tiff.put_hdr_pixel (22, r, g, b);
	      tiff.write_row ();
	    }
	}
#if 0
      for (int i = 0; i < 4; i++)
	{
	  int br = 200;
	  for (int j = 0; j < 4; j++)
	    {
	      int mul = 255;
	      xyz f = combined_xyz (i == 0 ? NULL : i == 1 ? red : i == 2 ? green : blue,
				    j == 0 ? NULL : j == 1 ? red : j == 2 ? green : blue,
				    backlight);
	      int br2 = (i && j) ? br : 1;
	      xyz_to_wide_gammut_rgb (f.x * br2, f.y * br2, f.z * br2, &r, &g, &b);
	      r = apply_gamma (std::min ((luminosity_t)1, std::max ((luminosity_t)0, r)), -1);
	      g = apply_gamma (std::min ((luminosity_t)1, std::max ((luminosity_t)0, g)), -1);
	      b = apply_gamma (std::min ((luminosity_t)1, std::max ((luminosity_t)0, b)), -1);
	      tiff.put_hdr_pixel (j, r*mul, g*mul, b*mul);
	    }
	  tiff.write_row ();
	  tiff.write_row ();
	}
#endif
    }

  spectrum checker_backlight;
  daylight_il (checker_backlight, 5400);
  rgbdata dwhite2;
  dwhite2.red   = simulated_response (checker_backlight, response, red);
  dwhite2.green = simulated_response (checker_backlight, response, green);
  dwhite2.blue  = simulated_response (checker_backlight, response, blue);
  if (output_tiffs)
    {
      tiff_writer_params par;
      color_matrix m (filter_red.x, filter_green.x, filter_blue.x, 0,
		      filter_red.y, filter_green.y, filter_blue.y, 0,
		      filter_red.z, filter_green.z, filter_blue.z, 0,
		      0, 0, 0, 1);
      xyz whitepp = combined_xyz (NULL, NULL, checker_backlight);
      //srgb_to_xyz (1, 1, 1, &whitepp.x, &whitepp.y, &whitepp.z);
      m.normalize_grayscale (whitepp.x, whitepp.y, whitepp.z);
      par.filename="/tmp/f4.tif";
      par.width = 12;
      par.height = 8;
      par.depth = 32;
      par.hdr = true;
      par.icc_profile = buffer;
      par.icc_profile_len = len;
      const char *error;
      tiff_writer tiff (par, &error);
      for (int y = 0; y < 4; y++)
	{
	  for (int d = 0; d < 2; d++)
	    {
	      for (int x = 0; x < 6; x++)
		{
		  xspect &xtile = TLCI_2012_TCS [y * 6 + x];
		  spectrum tile;
		  compute_spectrum (tile, xtile);
		  xyz real_color = get_xyz_old_observer (checker_backlight, tile);
		  rgbdata color =
		    {
		      simulated_response (checker_backlight, response, tile, red),
		      simulated_response (checker_backlight, response, tile, green),
		      simulated_response (checker_backlight, response, tile, blue)
		    };
		  //double mm = 3.8 * std::max (dwhite.red, std::max (dwhite.green, dwhite.blue)) / dglass;
		  //double mm = 1/std::max (dwhite.red, std::max (dwhite.green, dwhite.blue));
		  color.red /= dwhite2.red;
		  color.green /= dwhite2.green; 
		  color.blue /= dwhite2.blue;
		  //color *= mm;
		  //xyz dufay_color = (filter_red * color.red) + (filter_green * color.green) + (filter_blue * color.blue);
		  xyz dufay_color (0,0,0);
		  m.apply_to_rgb (color.red, color.green, color.blue, &dufay_color.x, &dufay_color.y, &dufay_color.z);
		  luminosity_t r,g,b;
		  xyz_to_wide_gammut_rgb (real_color.x, real_color.y, real_color.z, &r, &g, &b);
		  tiff.put_hdr_pixel (x * 2, r, g, b);
		  xyz_to_wide_gammut_rgb (dufay_color.x, dufay_color.y, dufay_color.z, &r, &g, &b);
		  tiff.put_hdr_pixel (x * 2 + 1, r, g, b);
		}
	      tiff.write_row ();
	    }
	}
    }
  FILE *f=fopen("/tmp/dufay.ti3","wt");
  fprintf (f, "CTI3\n\n");
  fprintf (f, "DESCRIPTOR \"Colorscreen produced Argyll Calibration Target chart information 3\"\n");
  fprintf (f, "ORIGINATOR \"Argyll target\"\n");
  fprintf (f, "DEVICE_CLASS \"INPUT\"\n");
  fprintf (f, "COLOR_REP \"XYZ_RGB\"\n\n");
  fprintf (f, "NUMBER_OF_FIELDS 10\n");
  fprintf (f, "BEGIN_DATA_FORMAT\n");
  fprintf (f, "SAMPLE_ID XYZ_X XYZ_Y XYZ_Z RGB_R RGB_G RGB_B STDEV_R STDEV_G STDEV_B\n");
  fprintf (f, "END_DATA_FORMAT\n\n");
  fprintf (f, "NUMBER_OF_SETS 24\n");
  fprintf (f, "BEGIN_DATA\n");

  for (int y = 0; y < 4; y++)
    {
      for (int x = 0; x < 6; x++)
	{
	  xspect &xtile = TLCI_2012_TCS [y * 6 + x];
	  spectrum tile;
	  compute_spectrum (tile, xtile);
	  xyz real_color = get_xyz_old_observer (checker_backlight, tile);
	  rgbdata color =
	    {
	      simulated_response (checker_backlight, response, tile, red),
	      simulated_response (checker_backlight, response, tile, green),
	      simulated_response (checker_backlight, response, tile, blue)
	    };
#if 0
	  color.red /= dwhite.red / 2;
	  color.green /= dwhite.green / 2;
	  color.blue /= dwhite.blue / 2;
	  xyz dufay_color = (filter_red * color.red) + (filter_green * color.green) + (filter_blue * color.blue);
#endif
	  color.red /= dwhite2.red;
	  color.green /= dwhite2.green; 
	  color.blue /= dwhite2.blue;
	  fprintf (f, "A%c%i %f %f %f %f %f %f %f %f %f\n", 'A'+y,x+1, real_color.x * 100, real_color.y * 100, real_color.z * 100, color.red * 100, color.green * 100, color.blue * 100, 0.0, 0.0, 0.0);
	}
    }
  fprintf (f, "END_DATA\n");
  fclose (f);
#if 0
  spectrum_dyes_to_xyz spec;
  spec.set_dyes_to_dufay_color_cinematography ();
  spec.set_daylight_backlight (6500);
  spec.normalize_brightness ();
  color_matrix m1 = spec.xyz_matrix ();
#endif
  printf ("Filter matrix\n");
  color_matrix m1 (filter_red.x,  filter_green.x, filter_blue.x,  0,
		   filter_red.y,  filter_green.y, filter_blue.y,  0,
		   filter_red.z,  filter_green.z, filter_blue.z,  0,
		   0  , 0  , 0  , 1);
  m1.print (stdout);
#if 0
  xyz r, g, b;
  r = spec.dyes_rgb_to_xyz (dred.red, dred.green, dred.blue);
  g = spec.dyes_rgb_to_xyz (dgreen.red, dgreen.green, dgreen.blue);
  b = spec.dyes_rgb_to_xyz (dblue.red, dblue.green, dblue.blue);
  color_matrix m2 (r.x, g.x, b.x, 0,
		   r.y, g.y, b.y, 0,
		   r.z, g.z, b.z, 0,
		   0  , 0  , 0  , 1);
#endif
  printf ("Density matrix\n");
  color_matrix m2 (dred.red,   dgreen.red,   dblue.red,   0,
		   dred.green, dgreen.green, dblue.green, 0,
		   dred.blue,  dgreen.blue,  dblue.blue,  0,
		   0  , 0  , 0  , 1);
  m2.print (stdout);
  //m2.normalize_grayscale (1,1,1);
  m2 = m2.invert ();
  //m2.normalize_grayscale (1,1,1);
  printf ("Invered density matrix\n");
  m2.print (stdout);
  m1 = m1 * m2;
  //m1.apply_to_rgb (dred.red, dred.green, dred.blue, &x, &y, &z);
  //printf ("Original red filter xyz:   %f %f %f\n", filter_red.x, filter_red.y, filter_red.z);
  //printf ("Reconstructed red filter xyz:   %f %f %f\n", x, y, z);
  m1.normalize_grayscale (whitep.x, whitep.y, whitep.z);
  printf ("Dyes to XYZ matrix\n");
  m1.print (stdout);
  printf ("Camera to xyz\n");
  m1.invert().print (stdout);
  
  return m1;
}
void
spectrum_dyes_to_xyz::write_spectra (const char *reds, const char *greens, const char *blues, const char *backlights, int start, int end)
{
  if (reds)
    {
      FILE *f = fopen (reds, "wt");
      print_transmitance_spectrum (f, red, start, end);
      fclose (f);
    }
  if (greens)
    {
      FILE *f = fopen (greens, "wt");
      print_transmitance_spectrum (f, green, start, end);
      fclose (f);
    }
  if (blues)
    {
      FILE *f = fopen (blues, "wt");
      print_transmitance_spectrum (f, blue, start, end);
      fclose (f);
    }
  if (backlights)
    {
      FILE *f = fopen (backlights, "wt");
      print_transmitance_spectrum (f, backlight, start, end);
      fclose (f);
    }
}
