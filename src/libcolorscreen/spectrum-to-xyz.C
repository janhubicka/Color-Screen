#include <string>
#include "include/spectrum-to-xyz.h"
#include "include/scr-to-img.h"
#include "include/render.h"
#include "include/tiff-writer.h"
#include "include/solver.h"
#include "icc.h"
#include "dufaycolor.h"
#include "spectrum.h"
#include "spectrum-dyes.h"

/* EBU TLCI ColorChecker samples */
static xspect TLCI_2012_TCS[] = {

	/* 1 Dark skin */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05400, 0.05700, 0.06300, 0.06600, 0.07500,
			0.07800, 0.07800, 0.07600, 0.07400, 0.07000,
			0.06600, 0.06400, 0.06200, 0.06000, 0.05900,
			0.06000, 0.05800, 0.06000, 0.06000, 0.06200,
			0.05800, 0.06300, 0.06300, 0.06700, 0.06800,
			0.07000, 0.07200, 0.07700, 0.07900, 0.08100,
			0.08100, 0.08300, 0.08300, 0.08400, 0.08400,
			0.08800, 0.09300, 0.09800, 0.10400, 0.11100,
			0.12100, 0.12700, 0.13300, 0.14000, 0.14400,
			0.14900, 0.15100, 0.15400, 0.16000, 0.16400,
			0.17000, 0.17500, 0.17900, 0.18400, 0.19300,
			0.20300, 0.21300, 0.22000, 0.23600, 0.24100,
			0.24800, 0.25700, 0.26900, 0.28000, 0.28900,
			0.30000, 0.31400, 0.33700, 0.34600, 0.36100,
			0.38200, 0.40400, 0.42500, 0.43900, 0.46400,
			0.47600, 0.49000
		}
	},
	/* 2 Light skin */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.09200, 0.10900, 0.13400, 0.16100, 0.18600,
			0.20000, 0.20500, 0.20600, 0.20700, 0.20900,
			0.21100, 0.21300, 0.21600, 0.22100, 0.22700,
			0.23700, 0.24600, 0.25900, 0.27300, 0.28500,
			0.29400, 0.30400, 0.30500, 0.30900, 0.31400,
			0.32300, 0.33400, 0.34000, 0.33200, 0.31600,
			0.30000, 0.29200, 0.29000, 0.29500, 0.30000,
			0.30200, 0.29700, 0.29500, 0.30400, 0.32800,
			0.36500, 0.40900, 0.45000, 0.48800, 0.52000,
			0.54000, 0.55600, 0.56600, 0.57400, 0.58200,
			0.59300, 0.60200, 0.60700, 0.62500, 0.63100,
			0.63900, 0.65500, 0.66100, 0.68700, 0.69300,
			0.71100, 0.72200, 0.73700, 0.75700, 0.76800,
			0.78600, 0.79800, 0.81500, 0.82200, 0.82300,
			0.83500, 0.84500, 0.85500, 0.84800, 0.86200,
			0.86100, 0.86800
		}
	},
	/* 3 Blue sky */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10500, 0.12700, 0.16400, 0.21300, 0.27100,
			0.31400, 0.33300, 0.34400, 0.34500, 0.34400,
			0.34600, 0.34600, 0.34700, 0.34300, 0.33700,
			0.33300, 0.32700, 0.32400, 0.31900, 0.30600,
			0.29000, 0.28800, 0.28000, 0.27400, 0.26500,
			0.25800, 0.25000, 0.24000, 0.22900, 0.22000,
			0.21200, 0.20700, 0.20300, 0.19800, 0.19300,
			0.19100, 0.18700, 0.18100, 0.17400, 0.17000,
			0.16700, 0.16200, 0.15800, 0.16100, 0.15600,
			0.15200, 0.15000, 0.14500, 0.14200, 0.13700,
			0.13300, 0.13200, 0.12600, 0.12700, 0.12100,
			0.11800, 0.11500, 0.11500, 0.11200, 0.11000,
			0.11000, 0.10900, 0.10800, 0.10800, 0.10600,
			0.10500, 0.10500, 0.10600, 0.10600, 0.10500,
			0.10700, 0.10500, 0.10600, 0.10500, 0.10800,
			0.10700, 0.11000
		}
	},
	/* 4 Foliage */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05000, 0.05200, 0.05200, 0.05000, 0.05200,
			0.05200, 0.05200, 0.05300, 0.05100, 0.05300,
			0.05300, 0.05300, 0.05500, 0.05800, 0.05900,
			0.06100, 0.06000, 0.06300, 0.06300, 0.06700,
			0.06500, 0.06700, 0.06900, 0.07200, 0.07700,
			0.08800, 0.10500, 0.13200, 0.15900, 0.18200,
			0.19500, 0.19900, 0.19100, 0.18000, 0.16700,
			0.15600, 0.14400, 0.13300, 0.13100, 0.13000,
			0.12900, 0.12300, 0.11800, 0.11400, 0.11000,
			0.10200, 0.10100, 0.10300, 0.10400, 0.10500,
			0.10500, 0.10600, 0.10200, 0.10200, 0.10100,
			0.10100, 0.10100, 0.10100, 0.10700, 0.11500,
			0.13200, 0.15200, 0.18500, 0.23300, 0.28300,
			0.33900, 0.38300, 0.41900, 0.44400, 0.44500,
			0.46500, 0.47300, 0.47700, 0.48000, 0.48900,
			0.49200, 0.49800
		}
	},
	/* 5 Blue flower */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10100, 0.12700, 0.17000, 0.23300, 0.31000,
			0.37300, 0.40900, 0.42400, 0.43200, 0.43700,
			0.43700, 0.43800, 0.43700, 0.43200, 0.42800,
			0.42300, 0.41700, 0.41200, 0.40500, 0.39500,
			0.38000, 0.37300, 0.36400, 0.35500, 0.34200,
			0.33300, 0.31600, 0.29600, 0.26700, 0.24500,
			0.22700, 0.21200, 0.20600, 0.20300, 0.20300,
			0.20400, 0.19600, 0.19000, 0.19000, 0.19400,
			0.20100, 0.21000, 0.21600, 0.22500, 0.22800,
			0.23200, 0.23800, 0.24000, 0.23600, 0.23600,
			0.24000, 0.24800, 0.26100, 0.28900, 0.32200,
			0.36200, 0.40700, 0.44600, 0.48800, 0.51200,
			0.54600, 0.54600, 0.55500, 0.56300, 0.56400,
			0.57500, 0.57800, 0.58600, 0.59000, 0.58900,
			0.60100, 0.60400, 0.60600, 0.60500, 0.61400,
			0.61600, 0.61700
		}
	},
	/* 6 Bluish green */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10800, 0.13200, 0.16800, 0.21300, 0.26000,
			0.29200, 0.30800, 0.31700, 0.32000, 0.32800,
			0.33600, 0.34200, 0.35200, 0.36000, 0.37100,
			0.38600, 0.40500, 0.43300, 0.46500, 0.49700,
			0.52800, 0.55700, 0.57600, 0.59100, 0.58600,
			0.59100, 0.58600, 0.58200, 0.56700, 0.55900,
			0.54500, 0.53300, 0.51200, 0.49200, 0.47200,
			0.44500, 0.42900, 0.40200, 0.38000, 0.35500,
			0.33200, 0.30900, 0.28400, 0.26200, 0.24700,
			0.23300, 0.22400, 0.21700, 0.21200, 0.20900,
			0.20700, 0.20500, 0.20000, 0.19800, 0.19900,
			0.19700, 0.19900, 0.20300, 0.21000, 0.21600,
			0.21800, 0.22600, 0.23200, 0.23600, 0.23800,
			0.24200, 0.24200, 0.23900, 0.23200, 0.22700,
			0.22900, 0.23000, 0.23700, 0.24800, 0.25600,
			0.26900, 0.27400
		}
	},
	/* 7 Orange */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05200, 0.05400, 0.05200, 0.05000, 0.05200,
			0.05200, 0.05200, 0.05100, 0.05000, 0.05000,
			0.05200, 0.05000, 0.05100, 0.05100, 0.05200,
			0.05100, 0.05100, 0.05300, 0.05300, 0.05400,
			0.05500, 0.05600, 0.05500, 0.05800, 0.06100,
			0.06300, 0.06800, 0.07700, 0.08600, 0.09800,
			0.12000, 0.14500, 0.17500, 0.20600, 0.23600,
			0.27000, 0.30200, 0.34100, 0.37500, 0.41000,
			0.44000, 0.46700, 0.48800, 0.50900, 0.51800,
			0.53200, 0.54000, 0.55100, 0.55700, 0.56200,
			0.56800, 0.57500, 0.58100, 0.58400, 0.58500,
			0.59000, 0.60100, 0.59600, 0.60000, 0.59600,
			0.60400, 0.60300, 0.60600, 0.60700, 0.60800,
			0.61500, 0.61700, 0.62100, 0.62200, 0.61900,
			0.62500, 0.62800, 0.63000, 0.62700, 0.63500,
			0.63900, 0.64000
		}
	},
	/* 8 Purplish blue */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.09400, 0.11300, 0.14100, 0.18600, 0.23500,
			0.27500, 0.29700, 0.31600, 0.31700, 0.33300,
			0.34600, 0.35500, 0.36800, 0.37800, 0.38100,
			0.37700, 0.36800, 0.35600, 0.34000, 0.32200,
			0.29600, 0.26900, 0.24100, 0.22000, 0.19700,
			0.18200, 0.16600, 0.15100, 0.13800, 0.12700,
			0.12000, 0.11500, 0.10800, 0.10400, 0.10100,
			0.09500, 0.09000, 0.08400, 0.08200, 0.08100,
			0.08100, 0.08100, 0.08100, 0.08300, 0.08300,
			0.08000, 0.07900, 0.08000, 0.08100, 0.08100,
			0.08400, 0.08900, 0.09200, 0.09600, 0.10300,
			0.10700, 0.11200, 0.11100, 0.11200, 0.10900,
			0.10400, 0.10200, 0.09900, 0.09900, 0.10000,
			0.10000, 0.10300, 0.10600, 0.10900, 0.11300,
			0.12200, 0.12700, 0.13800, 0.15300, 0.17300,
			0.19300, 0.21500
		}
	},
	/* 9 Moderate red */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08800, 0.10200, 0.12100, 0.13600, 0.15100,
			0.15300, 0.15100, 0.14400, 0.14200, 0.14100,
			0.13900, 0.13500, 0.13600, 0.13500, 0.13300,
			0.13200, 0.12900, 0.13000, 0.12900, 0.12700,
			0.12100, 0.11800, 0.10900, 0.10500, 0.10500,
			0.10400, 0.10100, 0.10000, 0.09400, 0.09100,
			0.08900, 0.09200, 0.09500, 0.09700, 0.10400,
			0.10900, 0.11100, 0.11300, 0.11600, 0.13400,
			0.16700, 0.22300, 0.29100, 0.36200, 0.42600,
			0.47400, 0.51100, 0.53700, 0.55100, 0.56200,
			0.56500, 0.57000, 0.57500, 0.57400, 0.57900,
			0.57700, 0.57900, 0.57700, 0.58000, 0.58100,
			0.57900, 0.58100, 0.58100, 0.58300, 0.58100,
			0.58100, 0.58000, 0.58600, 0.58500, 0.58400,
			0.58900, 0.58700, 0.59000, 0.58200, 0.58900,
			0.59200, 0.59000
		}
	},
	/* 10 Purple */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08300, 0.10000, 0.12500, 0.15400, 0.18300,
			0.19800, 0.20600, 0.20700, 0.20700, 0.20100,
			0.19400, 0.18400, 0.17500, 0.16300, 0.15400,
			0.14200, 0.12900, 0.12000, 0.10900, 0.10200,
			0.09500, 0.09000, 0.08100, 0.07700, 0.07000,
			0.06700, 0.06500, 0.06300, 0.05900, 0.05800,
			0.05600, 0.05300, 0.05200, 0.05200, 0.05100,
			0.05300, 0.05500, 0.05600, 0.05400, 0.05200,
			0.05300, 0.04900, 0.05100, 0.05500, 0.05800,
			0.06300, 0.07300, 0.08700, 0.10300, 0.12000,
			0.13700, 0.14900, 0.16100, 0.17500, 0.18800,
			0.19700, 0.20800, 0.21800, 0.22900, 0.24100,
			0.24900, 0.26200, 0.27200, 0.28400, 0.29200,
			0.30400, 0.31200, 0.32500, 0.32900, 0.33300,
			0.34300, 0.34600, 0.35000, 0.35000, 0.35900,
			0.36000, 0.36200
		}
	},
	/* 11 Yellow green */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04500, 0.04800, 0.05000, 0.05000, 0.05400,
			0.05300, 0.05300, 0.05500, 0.05300, 0.05700,
			0.05900, 0.05900, 0.06200, 0.06500, 0.07000,
			0.07500, 0.08100, 0.09200, 0.10200, 0.11600,
			0.13600, 0.15800, 0.18500, 0.22500, 0.27400,
			0.32800, 0.39000, 0.44600, 0.48500, 0.51100,
			0.52900, 0.53800, 0.53900, 0.53500, 0.52600,
			0.52100, 0.51100, 0.50000, 0.48400, 0.46700,
			0.45000, 0.43500, 0.41200, 0.39500, 0.37700,
			0.36300, 0.35200, 0.34600, 0.33900, 0.33700,
			0.33700, 0.33100, 0.32600, 0.32200, 0.32300,
			0.32000, 0.32500, 0.32700, 0.33400, 0.34000,
			0.34700, 0.35500, 0.36200, 0.36900, 0.37300,
			0.37600, 0.37500, 0.37900, 0.37200, 0.36500,
			0.36700, 0.37500, 0.37900, 0.38800, 0.40300,
			0.41500, 0.43000
		}
	},
	/* 12 Orange yellow */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04900, 0.05200, 0.05400, 0.05500, 0.05400,
			0.05700, 0.05700, 0.05900, 0.05700, 0.05700,
			0.05900, 0.05700, 0.05800, 0.06000, 0.06100,
			0.06100, 0.06200, 0.06700, 0.07200, 0.08100,
			0.08800, 0.09800, 0.10600, 0.11200, 0.12000,
			0.13000, 0.14300, 0.16300, 0.18800, 0.21800,
			0.25600, 0.30400, 0.35100, 0.39900, 0.44200,
			0.47600, 0.50500, 0.53200, 0.54400, 0.56100,
			0.57900, 0.53900, 0.59700, 0.60400, 0.61700,
			0.61700, 0.61800, 0.62400, 0.62500, 0.63000,
			0.64700, 0.63500, 0.63800, 0.64200, 0.64900,
			0.65000, 0.64900, 0.65000, 0.67700, 0.65700,
			0.65300, 0.65900, 0.65800, 0.66200, 0.66100,
			0.66600, 0.66800, 0.67200, 0.67100, 0.66700,
			0.67700, 0.67800, 0.68200, 0.67800, 0.68600,
			0.69300, 0.69000
		}
	},
	/* 13 Blue */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.06800, 0.08400, 0.10400, 0.12700, 0.15600,
			0.17800, 0.19400, 0.20900, 0.22100, 0.23400,
			0.25000, 0.26400, 0.28700, 0.30800, 0.31800,
			0.32300, 0.31700, 0.30300, 0.27600, 0.25500,
			0.22500, 0.19300, 0.16000, 0.13900, 0.11700,
			0.10400, 0.08700, 0.07700, 0.06600, 0.06000,
			0.05600, 0.05300, 0.05000, 0.04700, 0.04500,
			0.04200, 0.04300, 0.04000, 0.04000, 0.03800,
			0.03800, 0.03700, 0.03600, 0.03700, 0.03800,
			0.03600, 0.03700, 0.03700, 0.03700, 0.03900,
			0.03900, 0.04200, 0.04000, 0.04200, 0.04400,
			0.04500, 0.04700, 0.04800, 0.05000, 0.04800,
			0.04600, 0.05000, 0.04800, 0.05100, 0.04900,
			0.05200, 0.05400, 0.05700, 0.06000, 0.06500,
			0.06900, 0.07600, 0.08700, 0.10200, 0.12300,
			0.14700, 0.17400
		}
	},
	/* 14 Green */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04500, 0.04800, 0.05400, 0.05400, 0.05700,
			0.05900, 0.06000, 0.06000, 0.06000, 0.06200,
			0.05400, 0.06400, 0.06900, 0.07000, 0.07500,
			0.07900, 0.08300, 0.09000, 0.09900, 0.10900,
			0.12000, 0.13200, 0.14400, 0.15800, 0.17500,
			0.19600, 0.23100, 0.27200, 0.30700, 0.33800,
			0.35200, 0.35700, 0.35300, 0.34100, 0.32300,
			0.30500, 0.28600, 0.26500, 0.24400, 0.22400,
			0.20300, 0.18000, 0.16100, 0.14400, 0.12400,
			0.10800, 0.09800, 0.08900, 0.08400, 0.08000,
			0.07600, 0.07500, 0.07100, 0.07100, 0.07000,
			0.06700, 0.06700, 0.06700, 0.06800, 0.07000,
			0.07000, 0.07400, 0.07600, 0.07900, 0.08000,
			0.08200, 0.08600, 0.08500, 0.08300, 0.08100,
			0.08100, 0.08100, 0.08300, 0.08600, 0.09100,
			0.09400, 0.09800
		}
	},
	/* 15 Red */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04300, 0.04500, 0.04600, 0.04500, 0.04700,
			0.04600, 0.04800, 0.04600, 0.04600, 0.04600,
			0.04800, 0.04400, 0.04600, 0.04700, 0.04700,
			0.04700, 0.04600, 0.04600, 0.04400, 0.04400,
			0.04000, 0.04200, 0.03900, 0.04000, 0.04000,
			0.03900, 0.04000, 0.04000, 0.03800, 0.03800,
			0.03900, 0.03800, 0.04000, 0.04000, 0.04100,
			0.04200, 0.04400, 0.04600, 0.04700, 0.05400,
			0.06400, 0.08100, 0.11200, 0.15600, 0.21600,
			0.28300, 0.35800, 0.43400, 0.49900, 0.54900,
			0.58500, 0.60700, 0.62400, 0.63300, 0.65000,
			0.65200, 0.65200, 0.65600, 0.66100, 0.66600,
			0.66400, 0.67100, 0.67100, 0.67700, 0.67300,
			0.67800, 0.68000, 0.68900, 0.68800, 0.68500,
			0.69100, 0.69400, 0.69600, 0.69200, 0.69800,
			0.70400, 0.70000
		}
	},
	/* 16 Yellow */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.04700, 0.04700, 0.04800, 0.04700, 0.05000,
			0.05200, 0.05200, 0.05100, 0.05100, 0.05300,
			0.05300, 0.05300, 0.05700, 0.05600, 0.05800,
			0.06000, 0.06200, 0.06700, 0.07600, 0.09000,
			0.10900, 0.14200, 0.18300, 0.22800, 0.27400,
			0.31900, 0.36000, 0.40500, 0.44300, 0.47500,
			0.51000, 0.54400, 0.57100, 0.59400, 0.61200,
			0.63000, 0.64600, 0.65600, 0.66800, 0.67700,
			0.69100, 0.69600, 0.70100, 0.70200, 0.72900,
			0.70100, 0.70400, 0.70700, 0.70800, 0.71300,
			0.72100, 0.71600, 0.71700, 0.71800, 0.72600,
			0.72900, 0.73000, 0.72800, 0.74700, 0.73900,
			0.73700, 0.74300, 0.74000, 0.75600, 0.74200,
			0.74900, 0.75100, 0.75300, 0.75400, 0.75000,
			0.76000, 0.76200, 0.76900, 0.76200, 0.77400,
			0.77600, 0.77900
		}
	},
	/* 17 Magenta */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.10600, 0.12900, 0.16800, 0.22900, 0.29700,
			0.34600, 0.36700, 0.37200, 0.37700, 0.37300,
			0.36200, 0.35100, 0.34000, 0.32300, 0.30600,
			0.29300, 0.27600, 0.25900, 0.25000, 0.23400,
			0.22000, 0.20600, 0.19000, 0.17900, 0.16900,
			0.16300, 0.15200, 0.14000, 0.12600, 0.11300,
			0.10400, 0.09800, 0.09800, 0.10200, 0.10400,
			0.10300, 0.10400, 0.10300, 0.10600, 0.11800,
			0.14000, 0.17000, 0.21200, 0.25700, 0.31300,
			0.35400, 0.40300, 0.45700, 0.50100, 0.54600,
			0.58700, 0.61200, 0.63700, 0.65500, 0.67700,
			0.68400, 0.69300, 0.69500, 0.71400, 0.71000,
			0.72000, 0.71500, 0.71400, 0.73900, 0.71900,
			0.72600, 0.72800, 0.73300, 0.73700, 0.73200,
			0.74300, 0.74200, 0.74800, 0.74100, 0.75300,
			0.75400, 0.76100
		}
	},
	/* 18 Cyan */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08500, 0.10200, 0.13000, 0.16300, 0.20100,
			0.22800, 0.24700, 0.25400, 0.26200, 0.27800,
			0.28200, 0.30000, 0.31900, 0.33200, 0.34800,
			0.36300, 0.38200, 0.40100, 0.41900, 0.43100,
			0.43800, 0.44100, 0.43800, 0.42900, 0.41500,
			0.40400, 0.38100, 0.35800, 0.33900, 0.31600,
			0.28800, 0.26200, 0.23600, 0.21000, 0.18600,
			0.16200, 0.14200, 0.12900, 0.11600, 0.10500,
			0.09900, 0.09200, 0.08800, 0.08600, 0.08100,
			0.07700, 0.07800, 0.07600, 0.07600, 0.07600,
			0.07600, 0.07600, 0.07600, 0.07700, 0.07800,
			0.07700, 0.08100, 0.08000, 0.08100, 0.07900,
			0.07900, 0.07900, 0.07700, 0.07600, 0.07500,
			0.07400, 0.07400, 0.07600, 0.07700, 0.08100,
			0.08400, 0.09000, 0.09800, 0.11100, 0.13000,
			0.15100, 0.17900
		}
	},
	/* 19 White */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.12600, 0.16900, 0.21200, 0.26400, 0.31800,
			0.49100, 0.66400, 0.75700, 0.85100, 0.86800,
			0.88700, 0.88800, 0.89000, 0.89300, 0.89500,
			0.89600, 0.89800, 0.90000, 0.90200, 0.90000,
			0.89700, 0.90400, 0.90100, 0.90000, 0.90000,
			0.89800, 0.89700, 0.90000, 0.90200, 0.90200,
			0.90100, 0.90000, 0.89900, 0.89600, 0.89300,
			0.89500, 0.89800, 0.90000, 0.90200, 0.90400,
			0.90500, 0.90600, 0.90700, 0.90500, 0.90300,
			0.90400, 0.90500, 0.90700, 0.89800, 0.89700,
			0.89600, 0.89800, 0.90000, 0.90000, 0.89900,
			0.90100, 0.90400, 0.90400, 0.90500, 0.90200,
			0.89900, 0.89900, 0.90000, 0.89900, 0.89800,
			0.89800, 0.89900, 0.89800, 0.89800, 0.89900,
			0.90100, 0.89800, 0.89600, 0.89500, 0.89800,
			0.89900, 0.89800
		}
	},
	/* 20 Neutral 8 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.08400, 0.11300, 0.14100, 0.17600, 0.21100,
			0.32700, 0.44200, 0.50400, 0.56700, 0.57800,
			0.59000, 0.59100, 0.59200, 0.59400, 0.59500,
			0.59600, 0.59700, 0.59900, 0.60000, 0.59900,
			0.59700, 0.60200, 0.59900, 0.59900, 0.59900,
			0.59700, 0.59700, 0.59900, 0.60000, 0.60000,
			0.59900, 0.59900, 0.59800, 0.59600, 0.59400,
			0.59500, 0.59700, 0.59900, 0.60000, 0.60200,
			0.60200, 0.60300, 0.60400, 0.60200, 0.60100,
			0.60200, 0.60200, 0.60400, 0.59700, 0.59700,
			0.59600, 0.59700, 0.59900, 0.59900, 0.59800,
			0.59900, 0.60200, 0.60200, 0.60200, 0.60000,
			0.59800, 0.59800, 0.59900, 0.59800, 0.59700,
			0.59700, 0.59800, 0.59700, 0.59700, 0.59800,
			0.59900, 0.59700, 0.59600, 0.59500, 0.59700,
			0.59800, 0.59700
		}
	},
	/* 21 Neutral 6.5 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.05100, 0.06800, 0.08500, 0.10600, 0.12800,
			0.19800, 0.26700, 0.30500, 0.34200, 0.34900,
			0.35700, 0.35700, 0.35800, 0.35900, 0.36000,
			0.36000, 0.36100, 0.36200, 0.36300, 0.36200,
			0.36100, 0.36400, 0.36200, 0.36200, 0.36200,
			0.36100, 0.36100, 0.36200, 0.36300, 0.36300,
			0.36200, 0.36200, 0.36100, 0.36000, 0.35900,
			0.36000, 0.36100, 0.36200, 0.36300, 0.36400,
			0.36400, 0.36400, 0.36500, 0.36400, 0.36300,
			0.36400, 0.36400, 0.36500, 0.36100, 0.36100,
			0.36000, 0.36100, 0.36200, 0.36200, 0.36100,
			0.36200, 0.36400, 0.36400, 0.36400, 0.36300,
			0.36100, 0.36100, 0.36200, 0.36100, 0.36100,
			0.36100, 0.36100, 0.36100, 0.36100, 0.36100,
			0.36200, 0.36100, 0.36000, 0.36000, 0.36100,
			0.36100, 0.36100
		}
	},
	/* 22 Neutral 5 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.02770, 0.03720, 0.04650, 0.05800, 0.06980,
			0.10790, 0.14570, 0.16630, 0.18690, 0.19070,
			0.19470, 0.19490, 0.19540, 0.19600, 0.19650,
			0.19670, 0.19710, 0.19760, 0.19800, 0.19760,
			0.19690, 0.19850, 0.19780, 0.19760, 0.19760,
			0.19710, 0.19690, 0.19760, 0.19800, 0.19800,
			0.19780, 0.19760, 0.19740, 0.19670, 0.19600,
			0.19650, 0.19710, 0.19760, 0.19800, 0.19850,
			0.19870, 0.19890, 0.19910, 0.19870, 0.19820,
			0.19850, 0.19870, 0.19910, 0.19710, 0.19690,
			0.19670, 0.19710, 0.19760, 0.19760, 0.19740,
			0.19780, 0.19850, 0.19850, 0.19870, 0.19800,
			0.19740, 0.19740, 0.19760, 0.19740, 0.19710,
			0.19710, 0.19740, 0.19710, 0.19710, 0.19740,
			0.19780, 0.19710, 0.19670, 0.19650, 0.19710,
			0.19740, 0.19710
		}
	},
	/* 23 Neutral 3.5 */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.01260, 0.01690, 0.02120, 0.02640, 0.03180,
			0.04910, 0.06640, 0.07570, 0.08510, 0.08680,
			0.08860, 0.08870, 0.08890, 0.08930, 0.08950,
			0.08960, 0.08980, 0.09000, 0.09020, 0.09000,
			0.08970, 0.09040, 0.09010, 0.09000, 0.09000,
			0.08980, 0.08970, 0.09000, 0.09020, 0.09020,
			0.09010, 0.09000, 0.08990, 0.08960, 0.08930,
			0.08950, 0.08980, 0.09000, 0.09020, 0.09040,
			0.09050, 0.09060, 0.09070, 0.09050, 0.09030,
			0.09040, 0.09050, 0.09070, 0.08980, 0.08970,
			0.08960, 0.08980, 0.09000, 0.09000, 0.08990,
			0.09010, 0.09040, 0.09040, 0.09050, 0.09020,
			0.08990, 0.08990, 0.09000, 0.08990, 0.08980,
			0.08980, 0.08990, 0.08980, 0.08980, 0.08990,
			0.09010, 0.08980, 0.08960, 0.08950, 0.08980,
			0.08990, 0.08980
		}
	},
	/* 24 Black */
	{
		77, 380.0, 760.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{
			0.00439, 0.00589, 0.00737, 0.00919, 0.01105,
			0.01708, 0.02308, 0.02635, 0.02961, 0.03020,
			0.03084, 0.03087, 0.03094, 0.03105, 0.03112,
			0.03115, 0.03122, 0.03129, 0.03136, 0.03129,
			0.03119, 0.03143, 0.03133, 0.03129, 0.03129,
			0.03122, 0.03119, 0.03129, 0.03136, 0.03136,
			0.03133, 0.03129, 0.03126, 0.03115, 0.03105,
			0.03112, 0.03122, 0.03129, 0.03136, 0.03143,
			0.03147, 0.03150, 0.03154, 0.03147, 0.03140,
			0.03143, 0.03147, 0.03154, 0.03122, 0.03119,
			0.03115, 0.03122, 0.03129, 0.03129, 0.03126,
			0.03133, 0.03143, 0.03143, 0.03147, 0.03136,
			0.03126, 0.03126, 0.03129, 0.03126, 0.03122,
			0.03122, 0.03126, 0.03122, 0.03122, 0.03126,
			0.03133, 0.03122, 0.03115, 0.03112, 0.03122,
			0.03126, 0.03122
		}
	},
	/* 30 added backlight white.  */
	{
		2, 380.0, 780.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{ 1, 1 }
	},
	/* 26 added gray.  */
	{
		2, 380.0, 780.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{ 4/5.0, 4/5.0 }
	},
	/* 27 added gray.  */
	{
		2, 380.0, 780.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{ 3/5.0, 3/5.0 }
	},
	/* 28 added gray.  */
	{
		2, 380.0, 780.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{ 2/5.0, 2/5.0 }
	},
	/* 29 added gray.  */
	{
		2, 380.0, 780.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{ 1/5.0, 1/5.0 }
	},
	/* 25 added black.  */
	{
		2, 380.0, 780.0,	/* 77 bands from 380 to 760 nm in 5nm steps */
		1.0,				/* Scale factor */
		{ 0, 0 }
	},
	/* 26 my skin try 2.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		50,			/* Scale factor.  */
		{11.05781, 12.29471, 12.77711, 12.84787, 12.91089, 13.61572, 15.31931, 17.30442, 19.05421, 20.32610, 21.11653, 21.71328, 22.47914, 23.01395, 22.98638, 22.24767, 21.56637, 21.33456, 21.43618, 21.75184, 22.18575, 24.94142, 28.16140, 30.05566, 30.97144, 31.21856, 31.30698, 31.36347, 31.47188, 31.38079, 31.47548, 31.33909, 31.45063, 31.24354, 30.10174, 28.23979}
	},
	/* 27 paprika.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		20,			/* Scale factor.  */
		{1.906835, 1.938999, 1.889491, 1.828394, 1.783566, 1.721460, 1.668272, 1.644804, 1.627632, 1.605743, 1.576768, 1.563838, 1.562760, 1.566539, 1.580958, 1.611949, 1.674046, 1.808827, 2.073560, 2.626282, 3.622958, 5.143784, 6.974639, 8.666264, 9.972983, 10.79505, 11.26441, 11.49941, 11.60748, 11.54034, 11.53023, 11.42045, 11.42383, 11.24037, 10.59212, 9.657345}
	},
#if 0
	/* 26 my skin try 1.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		20,			/* Scale factor.  */
		{5.394621, 6.099174, 6.514502, 6.529451, 6.779758, 7.363187, 8.084518, 8.737588, 9.519582, 10.22716, 10.68055, 10.79956, 11.20590, 11.56449, 11.77895, 11.64186, 11.38929, 11.22360, 11.21184, 11.34279, 11.56265, 12.96909, 14.72412, 15.77141, 16.29990, 16.43326, 16.48844, 16.55361, 16.67534, 16.63674, 16.77187, 16.71653, 16.87816, 16.69063, 15.62913, 13.98665}
	},
#endif
	/* 26 lemon.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		50,			/* Scale factor.  */
		//100,			/* Scale factor.  */
		{3.289540, 3.257631, 3.111730, 3.164866, 3.303574, 3.359016, 3.472269, 3.842140, 4.332043, 4.857711, 5.375723, 6.292153, 8.312763, 11.80561, 16.82850, 21.85183, 25.46601, 27.60164, 28.77972, 30.41682, 31.65333, 32.49346, 33.22311, 33.65060, 33.85559, 33.83316, 33.91016, 34.05925, 34.24132, 34.14090, 34.30626, 34.51846, 34.94987, 34.89717, 33.79895, 31.98493}
	},
#if 0
	/* 28 cameraback.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		50,			/* Scale factor.  */
		//100,			/* Scale factor.  */
		{0.770405, 0.765791, 0.793526, 0.811531, 0.877929, 0.952244, 1.011818, 1.055026, 1.145591, 1.246965, 1.357303, 1.494646, 1.705871, 1.993166, 2.364005, 2.819393, 3.373086, 4.039928, 4.799112, 5.689959, 6.661289, 7.745727, 8.933324, 10.21910, 11.58699, 13.04088, 14.61079, 16.25992, 18.03257, 19.80185, 21.66983, 23.52554, 25.52820, 27.49729, 29.06403, 30.18065}
	},
#endif
	/* 28 dufay red.  */
	{
		65, 400, 720,		/* 38 bands from 380 to 730 nm in 10nm steps */
		1,			/* Scale factor.  */
		//100,			/* Scale factor.  */
		{0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.002696, 0.010334, 0.013055, 0.014041, 0.012851, 0.010568, 0.006736, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.004001, 0.013760, 0.033045, 0.083378, 0.190017, 0.367571, 0.516993, 0.618965, 0.689137, 0.732547, 0.755899, 0.756910, 0.745196, 0.729635, 0.717315, 0.712176, 0.718364, 0.728261, 0.737378, 0.746320, 0.753330, 0.759521, 0.764271, 0.768694, 0.770658, 0.772585, 0.773816, 0.774378, 0.774643, 0.774987, 0.774631, 0.774050, 0.772958}
	},
	/* 28 dufay green.  */
	{
		65, 400, 720,		/* 38 bands from 380 to 730 nm in 10nm steps */
		1,			/* Scale factor.  */
		//100,			/* Scale factor.  */
		{ 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.002439, 0.020093, 0.059809, 0.145953, 0.256214, 0.386163, 0.505990, 0.594740, 0.663598, 0.709551, 0.743586, 0.756088, 0.752206, 0.731717, 0.695169, 0.651583, 0.604720, 0.553163, 0.496591, 0.435238, 0.369605, 0.309213, 0.253598, 0.206198, 0.164608, 0.131160, 0.104012, 0.079996, 0.061624, 0.046459, 0.033809, 0.024319, 0.016887, 0.011850, 0.008767, 0.005510, 0.002365, 0.001923, 0.001431, 0.001478, 0.005615, 0.012184, 0.020263, 0.031950, 0.047929, 0.071303, 0.104594, 0.131432, 0.154813, 0.170212 }
	},
	/* 28 dufay blue.  */
	{
		65, 400, 720,		/* 38 bands from 380 to 730 nm in 10nm steps */
		1,			/* Scale factor.  */
		//100,			/* Scale factor.  */
		{ 0.832491, 0.832456, 0.831930, 0.831256, 0.829771, 0.827719, 0.824506, 0.819455, 0.812202, 0.801174, 0.787632, 0.770413, 0.749097, 0.722185, 0.687022, 0.644162, 0.598425, 0.548207, 0.494298, 0.435497, 0.374322, 0.311315, 0.242828, 0.180848, 0.127324, 0.083722, 0.051398, 0.029365, 0.016829, 0.008442, 0.002156, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000512, 0.003074, 0.005060, 0.008763, 0.013179, 0.019340, 0.027843, 0.041467, 0.063377, 0.096691, 0.144813, 0.212883, 0.294723, 0.398689, 0.511248, 0.610764, 0.701393, 0.780466, 0.850278, 0.910583, 0.958122}
	},
#if 0
	/* 26 apple - red side.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		//40,			/* Scale factor.  */
		100,			/* Scale factor.  */
		{12.29320, 14.91417, 16.94740, 18.00284, 18.31063, 18.58714, 19.09704, 19.57142, 20.98749, 22.28574, 21.87497, 22.98576, 27.17269, 31.23415, 33.92229, 35.20855, 35.73557, 36.04229, 36.49577, 37.67225, 38.65415, 39.43871, 40.08702, 40.22320, 39.96641, 39.58092, 38.86267, 37.56768, 36.25365, 34.02495, 34.42090, 38.70321, 42.06588, 42.83562, 41.83832, 39.83841}
	},
	/* 26 apple.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		//40,			/* Scale factor.  */
		100,			/* Scale factor.  */
		{5.017156, 5.799308, 6.651679, 7.197589, 7.515764, 7.651249, 7.758853, 8.186890, 8.988460, 9.449025, 9.181721, 9.730423, 11.98186, 14.53065, 16.54406, 17.69502, 18.26621, 18.80229, 19.68748, 21.23705, 22.82158, 24.28686, 25.50317, 25.88684, 25.51061, 25.07344, 23.98048, 21.94753, 19.95180, 17.16765, 17.79104, 24.27627, 30.61135, 32.78469, 32.25073, 30.39502}
	},
	/* 28 leek.  */
	{
		36, 380, 730,		/* 38 bands from 380 to 730 nm in 10nm steps */
		//40,			/* Scale factor.  */
		100,			/* Scale factor.  */
		{22.33790, 23.18203, 22.87664, 22.51028, 22.86318, 23.18963, 23.67381, 24.72237, 25.90513, 26.54361, 26.78424, 27.59191, 30.46119, 34.59954, 38.69026, 41.35623, 42.38198, 42.54165, 42.20121, 41.80285, 40.99451, 40.38363, 40.04041, 39.51755, 38.75554, 38.15305, 36.91506, 34.75365, 33.19346, 31.01460, 31.57473, 37.57588, 43.73461, 46.06924, 45.86260, 44.34373}
	},
#endif

};

/*    https://law.resource.org/pub/us/cfr/ibr/003/cie.15.2004.tables.xls
   CIE 1931 standard coloriometric observer
   bands from 380 to 780 by 5nm steps.  */
const spectrum cie_cmf_x = {
  0.001368, 0.002236, 0.004243, 0.007650, 0.014310, 0.023190, 0.043510, 0.077630, 0.134380,
  0.214770, 0.283900, 0.328500, 0.348280, 0.348060, 0.336200, 0.318700, 0.290800, 0.251100,
  0.195360, 0.142100, 0.095640, 0.057950, 0.032010, 0.014700, 0.004900, 0.002400, 0.009300,
  0.029100, 0.063270, 0.109600, 0.165500, 0.225750, 0.290400, 0.359700, 0.433450, 0.512050,
  0.594500, 0.678400, 0.762100, 0.842500, 0.916300, 0.978600, 1.026300, 1.056700, 1.062200,
  1.045600, 1.002600, 0.938400, 0.854450, 0.751400, 0.642400, 0.541900, 0.447900, 0.360800,
  0.283500, 0.218700, 0.164900, 0.121200, 0.087400, 0.063600, 0.046770, 0.032900, 0.022700,
  0.015840, 0.011359, 0.008111, 0.005790, 0.004109, 0.002899, 0.002049, 0.001440, 0.001000,
  0.000690, 0.000476, 0.000332, 0.000235, 0.000166, 0.000117, 0.000083, 0.000059, 0.000042,
};
const spectrum cie_cmf_y = {
  0.000039, 0.000064, 0.000120, 0.000217, 0.000396, 0.000640, 0.001210, 0.002180, 0.004000,
0.007300, 0.011600, 0.016840, 0.023000, 0.029800, 0.038000, 0.048000, 0.060000, 0.073900,
0.090980, 0.112600, 0.139020, 0.169300, 0.208020, 0.258600, 0.323000, 0.407300, 0.503000,
0.608200, 0.710000, 0.793200, 0.862000, 0.914850, 0.954000, 0.980300, 0.994950, 1.000000,
0.995000, 0.978600, 0.952000, 0.915400, 0.870000, 0.816300, 0.757000, 0.694900, 0.631000,
0.566800, 0.503000, 0.441200, 0.381000, 0.321000, 0.265000, 0.217000, 0.175000, 0.138200,
0.107000, 0.081600, 0.061000, 0.044580, 0.032000, 0.023200, 0.017000, 0.011920, 0.008210,
0.005723, 0.004102, 0.002929, 0.002091, 0.001484, 0.001047, 0.000740, 0.000520, 0.000361,
0.000249, 0.000172, 0.000120, 0.000085, 0.000060, 0.000042, 0.000030, 0.000021, 0.000015,

};
const spectrum cie_cmf_z = {
  0.006450, 0.010550, 0.020050, 0.036210, 0.067850, 0.110200, 0.207400, 0.371300, 0.645600,
1.039050, 1.385600, 1.622960, 1.747060, 1.782600, 1.772110, 1.744100, 1.669200, 1.528100,
1.287640, 1.041900, 0.812950, 0.616200, 0.465180, 0.353300, 0.272000, 0.212300, 0.158200,
0.111700, 0.078250, 0.057250, 0.042160, 0.029840, 0.020300, 0.013400, 0.008750, 0.005750,
0.003900, 0.002750, 0.002100, 0.001800, 0.001650, 0.001400, 0.001100, 0.001000, 0.000800,
0.000600, 0.000340, 0.000240, 0.000190, 0.000100, 0.000050, 0.000030, 0.000020, 0.000010,
0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
};

const spectrum cie_cmf1964_x = {
  0.000160, 0.000662, 0.002362, 0.007242, 0.019110, 0.043400, 0.084736, 0.140638, 0.204492,
  0.264737, 0.314679, 0.357719, 0.383734, 0.386726, 0.370702, 0.342957, 0.302273, 0.254085,
  0.195618, 0.132349, 0.080507, 0.041072, 0.016172, 0.005132, 0.003816, 0.015444, 0.037465,
  0.071358, 0.117749, 0.172953, 0.236491, 0.304213, 0.376772, 0.451584, 0.529826, 0.616053,
  0.705224, 0.793832, 0.878655, 0.951162, 1.014160, 1.074300, 1.118520, 1.134300, 1.123990,
  1.089100, 1.030480, 0.950740, 0.856297, 0.754930, 0.647467, 0.535110, 0.431567, 0.343690,
  0.268329, 0.204300, 0.152568, 0.112210, 0.081261, 0.057930, 0.040851, 0.028623, 0.019941,
  0.013842, 0.009577, 0.006605, 0.004553, 0.003145, 0.002175, 0.001506, 0.001045, 0.000727,
  0.000508, 0.000356, 0.000251, 0.000178, 0.000126, 0.000090, 0.000065, 0.000046, 0.000033,
};
const spectrum cie_cmf1964_y = {
  0.000017, 0.000072, 0.000253, 0.000769, 0.002004, 0.004509, 0.008756, 0.014456, 0.021391,
  0.029497, 0.038676, 0.049602, 0.062077, 0.074704, 0.089456, 0.106256, 0.128201, 0.152761,
  0.185190, 0.219940, 0.253589, 0.297665, 0.339133, 0.395379, 0.460777, 0.531360, 0.606741,
  0.685660, 0.761757, 0.823330, 0.875211, 0.923810, 0.961988, 0.982200, 0.991761, 0.999110,
  0.997340, 0.982380, 0.955552, 0.915175, 0.868934, 0.825623, 0.777405, 0.720353, 0.658341,
  0.593878, 0.527963, 0.461834, 0.398057, 0.339554, 0.283493, 0.228254, 0.179828, 0.140211,
  0.107633, 0.081187, 0.060281, 0.044096, 0.031800, 0.022602, 0.015905, 0.011130, 0.007749,
  0.005375, 0.003718, 0.002565, 0.001768, 0.001222, 0.000846, 0.000586, 0.000407, 0.000284,
  0.000199, 0.000140, 0.000098, 0.000070, 0.000050, 0.000036, 0.000025, 0.000018, 0.000013,
};
const spectrum cie_cmf1964_z = {
  0.000705, 0.002928, 0.010482, 0.032344, 0.086011, 0.197120, 0.389366, 0.656760, 0.972542,
  1.282500, 1.553480, 1.798500, 1.967280, 2.027300, 1.994800, 1.900700, 1.745370, 1.554900,
  1.317560, 1.030200, 0.772125, 0.570060, 0.415254, 0.302356, 0.218502, 0.159249, 0.112044,
  0.082248, 0.060709, 0.043050, 0.030451, 0.020584, 0.013676, 0.007918, 0.003988, 0.001091,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
};

namespace {

/* from Argyll 107 bands from 300 to 830 nm in 5nm steps
   CIE 15.2-1986 Table 1.1
   Part 1: CIE Standard Illuminant A relative spectral power distribution
   This is a 2848K tungsten filament lamp (Acording to the old temperature scale)
   and 2856 according to the newer temerature scale. */

static const luminosity_t il_A[] = {
  0.930483, 1.128210, 1.357690, 1.622190, 1.925080,
  2.269800, 2.659810, 3.098610, 3.589680, 4.136480,
  4.742380, 5.410700, 6.144620, 6.947200, 7.821350,
  8.769800, 9.795100, 10.899600, 12.085300, 13.354300,
  14.708000, 16.148000, 17.675300, 19.290700, 20.995000,
  22.788300, 24.670900, 26.642500, 28.702700, 30.850800,
  33.085900, 35.406800, 37.812100, 40.300200, 42.869300,
  45.517400, 48.242300, 51.041800, 53.913200, 56.853900,
  59.861100, 62.932000, 66.063500, 69.252500, 72.495900,
  75.790300, 79.132600, 82.519300, 85.947000, 89.412400,
  92.912000, 96.442300, 100.000000, 103.582000, 107.184000,
  110.803000, 114.436000, 118.080000, 121.731000, 125.386000,
  129.043000, 132.697000, 136.346000, 139.988000, 143.618000,
  147.235000, 150.836000, 154.418000, 157.979000, 161.516000,
  165.028000, 168.510000, 171.963000, 175.383000, 178.769000,
  182.118000, 185.429000, 188.701000, 191.931000, 195.118000,
  198.261000, 201.359000, 204.409000, 207.411000, 210.365000,
  213.268000, 216.120000, 218.920000, 221.667000, 224.361000,
  227.000000, 229.585000, 232.115000, 234.589000, 237.008000,
  239.370000, 241.675000, 243.924000, 246.116000, 248.251000,
  250.329000, 252.350000, 254.314000, 256.221000, 258.071000,
  259.865000, 261.602000
};
//   Illuminant B at 5nm interval Wyszecki & Stiles Color Science, 2nd edition.  Table II(3.3.4)  pp. 759.
//   Simulated direct sunlight, obsolette.
static const luminosity_t il_B[] = {
  0.02, 0.26, 0.50, 1.45, 2.40, 4.00, 5.60, 7.60, 9.6,
  12.4, 15.2, 18.8, 22.4, 26.85, 31.3, 36.18, 41.3, 46.62,
  52.1, 57.7, 63.2, 68.37, 73.1, 77.31, 80.8, 83.44, 85.4,
  86.88, 88.3, 90.08, 92, 93.75, 95.2, 96.23, 96.5, 95.71,
  94.2, 92.37, 90.7, 89.65, 89.5, 90.43, 92.2, 94.46, 96.9,
  99.16, 101, 102.2, 102.8, 102.92, 102.6, 101.9, 101, 100.07,
  99.2, 98.44, 98, 98.08, 98.5, 99.06, 99.7, 100.36, 101,
  101.56, 102.2, 103.05, 103.9, 104.59, 105, 105.08, 104.9, 104.55,
  103.9, 102.84, 101.6, 100.38, 99.1, 97.7, 96.2, 94.6, 92.9,
  91.1, 89.4, 88, 86.9, 85.9, 85.2, 84.8, 84.7, 84.9,
  85.4, 86.1, 87.0,
};


/* From Argyll. 93 bands from 320.0 to 780.0 */
/* CIE 15.2-1986 Table 1.1 */
/* Part 1: CIE Standard Illuminant C relative spectral power distribution */
/* This is a CIE Illuminant A combined with a filter to simulate daylight. */
static const luminosity_t il_C[] = {
	0.01,   0.20,   0.40,   1.55,   2.70,   4.85,   7.00,   9.95,   12.90,  17.20, 
	21.40,  27.50,  33.00,  39.92,  47.40,  55.17,  63.30,  71.81,  80.60,  89.53,
	98.10,  105.80, 112.40, 117.75, 121.50, 123.45, 124.00, 123.60, 123.10, 123.30,
	123.80, 124.09, 123.90, 122.92, 120.70, 116.90, 112.10, 106.98, 102.30, 98.81,
	96.90,  96.78,  98.00,  99.94,  102.10, 103.95, 105.20, 105.67, 105.30, 104.11,
	102.30, 100.15, 97.80,  95.43,  93.20,  91.22,  89.70,  88.83,  88.40,  88.19,
	88.10,  88.06,  88.00,  87.86,  87.80,  87.99,  88.20,  88.20,  87.90,  87.22,
	86.30,  85.30,  84.00,  82.21,  80.20,  78.24,  76.30,  74.36,  72.40,  70.40,
	68.30,  66.30,  64.40,  62.80,  61.50,  60.20,  59.20,  58.50,  58.10,  58.00,
	58.20,  58.50,  59.10
};



/* Absolutes spectral sensitivity of panchromatic emulsion. log.  */
const static spectra_entry absolute_panchromatic[] = {
  {337.07194243011116, 0.047135149544788035},
  {338.2769364579749, 0.1294267981014965},
  {339.14068001310187, 0.21079121681531277},
  {340.58215190049447, 0.2758827517863658},
  {341.82141420119524, 0.35933343764669035},
  {343.2638014867538, 0.4312401119630027},
  {345.66109050572857, 0.5012790804529179},
  {347.1727197895808, 0.5807559241294173},
  {349.26050014530193, 0.6322171804099508},
  {351.5553473024728, 0.7014812496740204},
  {354.2263483794551, 0.7775604582833493},
  {357.30486977462795, 0.8400093882021586},
  {360.72449841697414, 0.9023192336445338},
  {364.82685930073484, 0.9682055370523521},
  {369.6110023333529, 1.0305948593384047},
  {374.7361245107772, 1.0918913750239043},
  {380.5437861829985, 1.1553293501084663},
  {387.37496245118774, 1.2197858731265079},
  {394.88764708716496, 1.2787071149612221},
  {402.3984975301567, 1.3239727900187916},
  {409.90693634903784, 1.3512839235730798},
  {417.4137787406909, 1.3667096564139274},
  {424.91973800238793, 1.375560486732447},
  {432.4253236321805, 1.3816296275222886},
  {439.92972043318616, 1.3788479379936112},
  {447.4330303050152, 1.3679740607451443},
  {454.93647604299133, 1.3581117069616515},
  {462.43975194828363, 1.3469849488469419},
  {469.94309578664945, 1.336363952464719},
  {477.4466094576992, 1.3270073604137123},
  {484.9499872626018, 1.3166392448977327},
  {492.4538745655559, 1.3100643423754046},
  {499.95830533309834, 1.30753553371297},
  {507.4640607955747, 1.3148690788340294},
  {514.9716164844999, 1.3356053098659881},
  {522.4805308348958, 1.3664567755476842},
  {529.9905321144684, 1.4054004289491688},
  {536.4796011983823, 1.462551504720179},
  {541.9459293685547, 1.5244440967332529},
  {548.4350409106396, 1.581911273587067},
  {555.945789454021, 1.6264183060459065},
  {563.4550095032479, 1.6595456995237932},
  {570.9640936863276, 1.691661569536706},
  {578.4719211075469, 1.7144208474986122},
  {585.978016235391, 1.7242832012821054},
  {593.4808166091685, 1.709616111039988},
  {600.9833792171887, 1.6931788547341662},
  {608.4876061855106, 1.6891327608742719},
  {615.992036953053, 1.6866039522118377},
  {623.4934107322862, 1.6613158655874973},
  {630.9939013815635, 1.6294528764408276},
  {638.4956487927012, 1.6069464793451642},
  {645.9985170995523, 1.592785150835534},
  {653.5023364694329, 1.5857044865807182},
  {661.008567463424, 1.5965783638291846},
  {668.517923378798, 1.630717280772045},
  {676.0275170599293, 1.6666263637786085},
  {683.53028346717, 1.6517063926702473},
  {691.034340602808, 1.6463958944791361},
  {698.5386694707402, 1.6431084432179714},
  {706.0464629254226, 1.6656148403136348},
  {713.5581285652969, 1.7169496561610469},
  {721.0694205732665, 1.7655027824797807},
  {728.5792180536184, 1.8029291506838052},
  {736.0819165277858, 1.7875034178429572},
  {741.5314805137359, 1.7245866583215976},
  {744.080135823604, 1.6517063926702473},
  {745.2661368963245, 1.5925954901858512},
  {746.6224207095011, 1.5313983205549464},
  {748.319674771486, 1.469042113620426},
  {749.6752113208537, 1.4022815649321667},
  {750.7569753194292, 1.3290304073436596},
  {752.6561462897808, 1.246136059389071},
  {753.7390810016572, 1.1816008623237533},
  {755.3665468510881, 1.1076079208609326},
  {757.3543433091768, 1.007281651859964},
  {758.7543005405186, 0.932608741845689},
  {760.1755210597564, 0.8469288409047437},
  {761.5306139212374, 0.7768650359011797},
  {762.5459586215976, 0.717058711034614},
  {763.9016819869174, 0.6516890071106931},
  {765.5288115676344, 0.5751925450720625},
  {766.9506117352574, 0.49382812635824624},
  {768.3058680606966, 0.42498131052347876},
  {769.3207768571682, 0.3619296812067887},
  {770.9478939834883, 0.2853404961838688},
  {772.3703293253488, 0.20870494966880404},
  {773.3838992741628, 0.13568559954102088},
  {773.709893110801, 0.02302717362958262},
};

/* Panchromatic emulsion wedge sensitivity to thungsten light.  */
const static spectra_entry wedge_thungsten_panchromatic[] = {
  {355.14229725410485, 0.033397353819889286},
  {358.33024315663425, 0.08409932860875857},
  {361.4818246572336, 0.13541217056375832},
  {364.560677353973, 0.18788566013440677},
  {367.5607405131974, 0.23736590059101426},
  {370.4517104666318, 0.28645344072653733},
  {373.50632022875124, 0.33357747925663883},
  {376.5609299908706, 0.3807015177867408},
  {379.61553975299, 0.4281397165737104},
  {382.88833592668936, 0.47707017658079964},
  {386.3793185119687, 0.5265504170374067},
  {389.870301097248, 0.5741064259207014},
  {393.7976565056872, 0.6214425226241889},
  {398.37957114886626, 0.6644453497846585},
  {403.17967220362533, 0.6966324961018857},
  {407.9797732583844, 0.7214225963710543},
  {412.7798743131434, 0.740814852226775},
  {417.5799753679025, 0.7576081459575026},
  {422.38007642266155, 0.7706029565824699},
  {427.18017747742056, 0.7821983260632102},
  {431.9802785321796, 0.7935937753804894},
  {436.7803795869387, 0.8029900230631584},
  {441.5804806416977, 0.8109868296015998},
  {446.3805816964568, 0.8157849135246646},
  {451.18068275121584, 0.8205829974477299},
  {455.98078380597485, 0.8229820394092622},
  {460.7808848607339, 0.8239816402265674},
  {465.580985915493, 0.8239816402265674},
  {470.381086970252, 0.8213826781015741},
  {475.18118802501107, 0.817384274832353},
  {479.98128907977014, 0.8139856320535155},
  {484.78139013452915, 0.806988426332379},
  {489.5814911892882, 0.7975921786497102},
  {494.3815922440473, 0.7867964898228141},
  {499.1816932988063, 0.7797992841016776},
  {503.98179435356536, 0.7789996034478335},
  {508.78189540832443, 0.7855969688420479},
  {513.5819964630834, 0.7977920988131713},
  {518.3820975178426, 0.8137857118900544},
  {523.1821985726016, 0.831578606438087},
  {527.9822996273606, 0.8499712614765025},
  {532.7824006821196, 0.86876375684184},
  {537.5825017368787, 0.8871564118802557},
  {542.3826027916377, 0.9051492265917491},
  {547.1827038463967, 0.9231420413032427},
  {551.9828049011559, 0.940735015687814},
  {556.7829059559149, 0.9571284690916191},
  {561.5830070106739, 0.9681240780819762},
  {566.383108065433, 0.9741216829858075},
  {571.183209120192, 0.9795195273992556},
  {575.9833101749512, 0.9797194475627167},
  {580.78341122971, 0.9727222418415802},
  {585.5835122844692, 0.9617266328512231},
  {590.3836133392283, 0.940335175360892},
  {595.1837143939872, 0.9215426799955544},
  {599.9838154487463, 0.9115466718225025},
  {604.7839165035055, 0.9073483483898206},
  {609.5840175582643, 0.9069485080628985},
  {614.3841186130235, 0.9129461129667298},
  {619.1842196677825, 0.9247414026109311},
  {623.9843207225415, 0.9309389276782232},
  {628.7844217773006, 0.9183439573801777},
  {632.3844975683699, 0.8734618806831744},
  {634.0208956552196, 0.8195833966304245},
  {634.8390946986444, 0.7648802419033978},
  {636.1482131681241, 0.7101770871763711},
  {637.4246036758668, 0.654209437415453},
  {638.7664501070836, 0.5966474243509334},
  {640.0428406148263, 0.5416144013541961},
  {641.5846912566581, 0.48287341465904365},
  {642.6938055155229, 0.43198817972033554},
  {644.4938434110575, 0.36832360366616745},
  {646.4575211152771, 0.3036144447579159},
  {648.2030124079167, 0.24203903441191565},
  {650.1182042428964, 0.17670679099421083},
  {651.912181404776, 0.11586442124756768},
  {653.8516161743756, 0.06259680436094861},
  {655.6213504016353, 0.02212685460477326},
};

/* Panchromatic emulsion wedge sensitivity to thungsten light.  */
const static spectra_entry wedge_Neopan_100_acros_daylight_5400k [] = {
  {380.1729818452725, 1.5732847620784898},
  {385.81266010382103, 1.5310698897253516},
  {391.61046018270264, 1.543692036238022},
  {397.62787390093587, 1.5757761441660834},
  {403.2060603404659, 1.5699302283904912},
  {409.0038604193476, 1.5370814898371168},
  {414.8016604982292, 1.534298199879324},
  {420.5994605771108, 1.5392176281567633},
  {426.39726065599245, 1.5426462077435126},
  {432.1950607348741, 1.543590039512445},
  {437.9928608137557, 1.5415521738999973},
  {443.79066089263733, 1.5340478630883534},
  {449.588460971519, 1.5185923592596957},
  {455.3862610504006, 1.4909615911237357},
  {461.1840611292822, 1.4526464073711645},
  {466.9818612081639, 1.4098586775465227},
  {472.77966128704554, 1.364834674685846},
  {478.57746136592715, 1.3205560961705145},
  {484.37526144480876, 1.2802531141636897},
  {490.1730615236904, 1.2479013251738782},
  {495.9708616025721, 1.2344336195994736},
  {501.5659413989753, 1.2578948398937064},
  {507.5664617603353, 1.292476583819997},
  {513.364261839217, 1.3359096032735946},
  {519.1620619180986, 1.3813304209814463},
  {524.9598619969802, 1.42699971347108},
  {530.7576620758618, 1.470184258142897},
  {536.5554621547435, 1.5101386306515514},
  {542.3532622336252, 1.5433841840521012},
  {548.1510623125067, 1.5587395531643709},
  {553.9488623913884, 1.5688769518592252},
  {559.7466624702699, 1.5879594426982198},
  {565.5444625491516, 1.6174778743720448},
  {571.3422626280333, 1.6452569825733976},
  {577.1400627069149, 1.6640909986306105},
  {582.9378627857966, 1.6610592338910364},
  {588.7356628646781, 1.62647117186519},
  {594.5334629435598, 1.5886529376761818},
  {600.2907189659458, 1.5551738055673625},
  {606.4218812871252, 1.5171827953158257},
  {611.9268631802047, 1.497064015905944},
  {617.7246632590864, 1.5191282041263188},
  {623.522463337968, 1.5660398705248606},
  {629.3202634168497, 1.582140663982475},
  {633.4489998366593, 1.5295525936078467},
  {634.8545271285093, 1.4730538556747668},
  {636.1722089646188, 1.4133671166384905},
  {637.602834958109, 1.3411195936516283},
  {638.5440362696158, 1.2762299674575592},
  {639.3346453712816, 1.2187343580789802},
  {640.4766362959097, 1.1586847065554307},
  {641.5307817647972, 1.0912561126093014},
  {643.6566417937206, 0.9619563256169599},
  {644.5300766107989, 0.8838306780362957},
  {645.6595181846069, 0.7975291825817941},
  {646.7136636534945, 0.7228640564195863},
  {647.9654613977984, 0.6462546830680491},
};
/* Response to mean moon sunlight (probably between 5000-5500k).  */
const static spectra_entry ilford_manual_of_photography_panchromatic_emulsion_fig54 [] = {
  {359.879849627755, 0.31079387699942806},
  {363.25987243167424, 0.3300672108428788},
  {367.36514775946716, 0.38326545697272607},
  {371.5592925471522, 0.46359357433074244},
  {376.206424720676, 0.5845300976672299},
  {383.767734599828, 0.799717620411494},
  {389.9581507736075, 1.0243269516350573},
  {399.2441864669615, 1.3567151889388605},
  {411.7937062152416, 1.9597603035362443},
  {419.07853333028487, 2.202176441353002},
  {427.4577713865918, 2.462399385762952},
  {434.5558080627878, 2.7501224908172883},
  {443.4723772052941, 3.1278670672808335},
  {450.94111473039175, 3.3566565545808036},
  {457.5034660511271, 3.508754989455376},
  {466.6405631126249, 3.470080317094931},
  {472.59481692539487, 3.2783938292999064},
  {478.37256611643477, 3.0188703204539227},
  {484.0655601744294, 2.686959345064354},
  {488.7501327222596, 2.3960517510305515},
  {494.34808583009186, 2.1048972973859374},
  {500.2151159137085, 1.8679779002365802},
  {508.2639735242129, 1.7436100283098153},
  {516.6707775703937, 1.7006070841064744},
  {524.8932597738354, 1.6757565499514655},
  {532.74545256106, 1.7053138740192786},
  {540.9638204376549, 1.7257209351796838},
  {549.362395830142, 1.7732331816071785},
  {559.0380582758933, 1.8385028627057025},
  {569.2588690288529, 1.9353047447585308},
  {577.6664959404031, 1.8832502814921082},
  {586.079882909539, 1.7678351847841043},
  {594.4920355806207, 1.6659973666707213},
  {604.1796295742279, 1.6000200213545384},
  {612.9505515463555, 1.5704956119015012},
  {621.5346830796358, 1.5862781696860395},
  {629.7575767157622, 1.556901875999488},
  {638.1701408195288, 1.4505382983545658},
  {645.8569376675097, 1.2900630940197928},
  {652.6324111189122, 1.1072059516381216},
  {659.9579700697393, 0.9015718958322623},
  {666.5573503320963, 0.6463519728680875},
  {672.0561481629194, 0.4412116362838461},
  {678.2848275763747, 0.2449253310740378},
  {685.7004902851478, 0.0528438679017178},
  {693.4699851027507, 0},
  {699.6817957761339, 0},
};

/* Ilford fp4 equal energy spectral sensitivity. (relative log sensitivity)  */
const static spectra_entry ilford_fp4_absolute[] = {
  {351.6820562682886, 1.3045820482561394},
  {353.9149734707438, 1.3033155303535586},
  {356.83309935292294, 1.301914153848439},
  {359.3599128953425, 1.3019737953690154},
  {361.9904098929244, 1.2985745648941263},
  {364.6206715519246, 1.29582957567652},
  {367.25081554163387, 1.2934117070875548},
  {369.8815871008945, 1.2892491951458358},
  {372.5116134213129, 1.2871584471855122},
  {375.1420711957979, 1.28386825692017},
  {377.7725681933798, 1.2804690264452812},
  {380.40306519096174, 1.2770697959703918},
  {383.0889331328051, 1.2730830276403413},
  {385.74363958126474, 1.2705342735882637},
  {388.2939678372531, 1.2685077076889315},
  {390.92462172722287, 1.2646723163758538},
  {393.4068480639676, 1.2581597035509413},
  {396.29511484216823, 1.252486492457128},
  {399.0033136664511, 1.2508810135240103},
  {401.4842991914188, 1.245972053797052},
  {404.09118780694087, 1.241755194332186},
  {406.71023166021064, 1.2369712394868617},
  {409.3406109885017, 1.233899129640614},
  {411.9005064115567, 1.2313342436552812},
  {414.60227177631384, 1.2252469851285348},
  {417.23308255867147, 1.2209754329772684},
  {419.83169640817164, 1.2176127793477307},
  {422.34089355031017, 1.2128540217934463},
  {425.1255541288412, 1.2080517363139232},
  {427.7576200503015, 1.2002908974571491},
  {430.3898820872466, 1.1919848575526395},
  {433.15776288481595, 1.1804339006424533},
  {435.59179302402396, 1.1722401492736372},
  {438.20433199584113, 1.1614357408341238},
  {441.01333419508563, 1.1518905009576452},
  {443.52514568414745, 1.13980300828699},
  {446.2133148526324, 1.1255852377137474},
  {448.9719566497129, 1.1148003529937396},
  {451.27588797878127, 1.0976702910985079},
  {453.70163844416516, 1.0855772196984912},
  {455.92128795171203, 1.070220997394159},
  {458.17888980529085, 1.0608340783492451},
  {459.8281229746911, 1.0443298816684128},
  {462.02544398292264, 1.0358870742856672},
  {463.88795504928055, 1.017670372965557},
  {466.0855013019145, 1.0086013861441623},
  {467.73546255005203, 0.9900731305736113},
  {469.920493356551, 0.98192115834024},
  {471.3301400827942, 0.9614405515458319},
  {473.53504499905165, 0.9514350166880415},
  {474.6691836492824, 0.931122035962119},
  {476.89218909090334, 0.9214247976348562},
  {477.9502827765907, 0.9007564884082326},
  {480.2192084434653, 0.8802343093550733},
  {482.5679365182652, 0.8557708864896065},
  {484.736779971876, 0.8294195528702413},
  {486.7427875848394, 0.8031585173774989},
  {488.8620472757911, 0.7747575573898094},
  {491.840351817069, 0.7458132129221298},
  {494.3666951492667, 0.7550906258972044},
  {496.9878766613208, 0.777588445189757},
  {499.6090581733748, 0.8000862644823091},
  {502.2318674439527, 0.8180589150786559},
  {504.8557357381485, 0.8330874800172304},
  {507.48087878299543, 0.8445722381455235},
  {510.1065317281029, 0.854639473549704},
  {512.733439812313, 0.8612174222483763},
  {515.3611323584623, 0.8656145667561066},
  {517.9893936395175, 0.8684306282254034},
  {520.6179883168969, 0.8703198479135498},
  {523.247387067764, 0.86997374330598},
  {525.8779625115399, 0.8663564324119967},
  {528.5081653358945, 0.8637750035087111},
  {531.134269346617, 0.8725882765030993},
  {533.7585690948794, 0.8864173991366557},
  {536.3817902079753, 0.9032451275327574},
  {539.0060115100437, 0.9172923305854078},
  {541.6320174630238, 0.9263782041036642},
  {544.2570624501284, 0.938135562755825},
  {546.8807542403878, 0.9536548086373616},
  {549.5036223456111, 0.9714638989193878},
  {552.1287850020066, 0.9828941369429073},
  {554.754477170211, 0.9928523321375405},
  {557.3807576848698, 1.0011749241889671},
  {560.0074892651435, 1.0082435538306016},
  {562.6350053073566, 1.013131379281294},
  {565.2064500646995, 1.0156856359172193},
  {568.0779857561682, 1.0172355969846874},
  {570.5223386518246, 1.0144919500686214},
  {573.1536397228942, 1.0088573952980162},
  {575.7850388517062, 1.0029502400035433},
  {578.3603751005976, 0.994686150135115},
  {580.8691572250149, 0.9815884374004593},
  {583.2946124849848, 0.9703160370512446},
  {585.5137169979213, 0.9564748997637775},
  {587.7901838156084, 0.948039843002038},
  {588.9240451025106, 0.9284979323293414},
  {591.1408651606229, 0.9192442287824953},
  {593.0044929316238, 0.8979230885552788},
  {595.2217027486615, 0.887585855195076},
  {596.3571049429444, 0.8637602220044567},
  {598.448948348333, 0.8579706754852267},
  {599.03115638805, 0.8342066718658699},
  {600.2176655305643, 0.8138585240847668},
  {602.4622842922511, 0.8029797040704231},
  {603.2800556922414, 0.7786159575749954},
  {605.7452092331716, 0.7748404750167814},
  {605.7531322987575, 0.7528143526882628},
  {608.3809817372946, 0.7567753363578046},
  {611.0057717742689, 0.7692414563720216},
  {613.6284829871045, 0.7874867074922363},
  {616.2508608036158, 0.8066588003936013},
  {618.8736504626452, 0.8246859710947217},
  {621.4959106098655, 0.8441851846247281},
  {624.1192493922524, 0.8606857923921889},
  {626.7448238911659, 0.8709711082154635},
  {629.1872940781682, 0.8734613913576594},
  {631.1853746391461, 0.852516750920739},
  {632.4134439214802, 0.7830803455567206},
  {632.5125824781061, 0.7474296316128015},
  {632.9127561248343, 0.7055130061390095},
  {633.1294419449257, 0.675325555343152},
  {633.2884161740633, 0.6209959631858454},
  {633.3851282625201, 0.5565946068652401},
  {633.5634847358783, 0.5207946725042005},
  {634.6185929658091, 0.48007667718659586},
  {634.7873041956569, 0.44102313013914984},
  {635.121896824269, 0.37980318335021157},
  {635.84362702317, 0.35225700321236597},
  {636.09362383659, 0.32175517306849066},
  {636.482616659365, 0.2798062625032611},
  {637.1371324783265, 0.24329860408022186},
  {637.5783805521908, 0.17579364599053626},
  {637.7319638180815, 0.1401425389440234},
  {637.9127697810286, 0.1058087145808202},
  {638.3041910738355, 0.06660136177254294},
  {638.5901465018878, 0.035807979625009034},
  {638.8501222315044, 0.015535580235860325}
};

/* Tramsission of lens
   https://www.lensrentals.com/blog/2018/04/looking-at-cine-lens-color-shifts-using-spectrometry/  */
const static spectra_entry zeiss_contact_prime_cp2_tramsmission[] =
{
  {375.42227003765464, 29.687500000000014},
  {382.3883808499193, 39.613970588235304},
  {387.76223776223776, 47.70220588235294},
  {393.1360946745562, 55.422794117647065},
  {400.6993006993007, 63.143382352941174},
  {410.25282409897795, 69.94485294117646},
  {422.19472834857453, 75.45955882352942},
  {435.33082302313073, 79.50367647058823},
  {450.85529854760625, 82.62867647058823},
  {467.17590102205486, 85.20220588235294},
  {485.08875739644975, 86.94852941176471},
  {503.39967724583107, 88.78676470588235},
  {522.108660570199, 90.1654411764706},
  {545.1963421194191, 91.1764705882353},
  {570.2743410435719, 91.26838235294117},
  {594.5562130177515, 90.90073529411765},
  {614.8574502420656, 90.53308823529412},
  {635.1586874663799, 90.34926470588235},
  {653.0715438407747, 89.98161764705883},
  {674.9650349650351, 89.0625},
  {692.8778913394299, 87.13235294117646},
  {708.8004303388919, 84.55882352941177},
  {722.3345884884347, 81.61764705882354},
  {735.0726196880044, 78.30882352941177},
  {749.4029047875204, 74.17279411764706}
};
/* Tramsission of lens
   https://www.lensrentals.com/blog/2018/04/looking-at-cine-lens-color-shifts-using-spectrometry/  */
const static spectra_entry canon_CN_E_85mm_T1_3_tramsmission[] =
{
  {375.23349436392914, 16.337395149854586},
  {380.3972088030059, 12.567763190735292},
  {384.170692431562, 14.585618913977129},
  {388.93719806763283, 24.22615647145173},
  {391.7176596886742, 31.57196181855494},
  {394.69672571121845, 38.36652856120733},
  {396.8813741277509, 44.977990020170424},
  {399.66183574879227, 51.58900776681438},
  {403.2367149758454, 58.199433897032854},
  {406.81159420289856, 64.99355692736614},
  {412.3725174449812, 72.33729161698012},
  {420.51529790660226, 78.57692215252241},
  {433.6231884057971, 84.07806748494613},
  {455.07246376811594, 88.28712254409854},
  {471.358024691358, 91.21414480921294},
  {490.4240472356414, 93.4043088163789},
  {512.667740203972, 94.67362185726884},
  {546.8276972624799, 95.5666668515468},
  {629.447128287708, 96.0562294436402},
  {658.8405797101449, 94.74846133509338},
  {683.4675254965109, 92.52575842452545},
  {699.3558776167472, 90.58510864481013},
  {716.435856146001, 88.09248074011214},
  {730.3381642512077, 85.78591620123092},
  {749.6027911969938, 82.46502530084618},
};

/* Taken from Argyll
   General temperature Daylight spectra from CIE 15.2004 Appendix C.   
   ## uses improved interpolation rather than CIE 15.2004 Section 3.1 ##   
   Assumong 1931 observer & 5 nm spacing. (Need Lagrange interpolated S0, S1 for 1nm)   
   i.e. 300 - 830nm at 5nm intervals.   
   Fill in the given xspect with the specified daylight illuminant   
   Return nz if temperature is out of range */
static int
daylight_il (spectrum spec, double ct)
{
  static double s0[107] = {
    0.04000, -0.15625, 6.00000, 16.56625, 29.60000,
    43.80000, 55.30000, 57.62500, 57.30000, 59.69375,
    61.80000, 61.47500, 61.50000, 65.46875, 68.80000,
    66.40625, 63.40000, 62.45000, 65.80000, 79.82500,
    94.80000, 101.54375, 104.80000, 106.54375, 105.90000,
    100.35000, 96.80000, 104.05000, 113.90000, 120.82500,
    125.60000, 126.54375, 125.50000, 123.39375, 121.30000,
    121.52500, 121.30000, 117.42500, 113.50000, 112.95625,
    113.10000, 112.19375, 110.80000, 108.36250, 106.50000,
    107.60000, 108.80000, 107.25000, 105.30000, 104.90625,
    104.40000, 102.39375, 100.00000, 97.78125, 96.00000,
    95.67500, 95.10000, 91.95625, 89.10000, 89.43750,
    90.50000, 90.60625, 90.30000, 89.61250, 88.40000,
    86.01250, 84.00000, 84.47500, 85.10000, 83.52500,
    81.90000, 81.90625, 82.60000, 84.01875, 84.90000,
    83.83125, 81.30000, 76.22500, 71.90000, 72.38125,
    74.30000, 76.31875, 76.40000, 69.45625, 63.30000,
    66.35000, 71.70000, 75.61250, 77.00000, 72.52500,
    65.20000, 54.40625, 47.70000, 57.28125, 68.60000,
    68.04375, 65.00000, 65.58750, 66.00000, 64.04375,
    61.00000, 56.48750, 53.30000, 55.43125, 58.90000,
    61.71875, 61.90000
  };

  static double s1[107] = {
    0.02000, -0.15000, 4.50000, 12.50500, 22.40000,
    33.40625, 42.00000, 42.46250, 40.60000, 41.23750,
    41.60000, 39.58750, 38.00000, 40.21875, 42.40000,
    40.94375, 38.50000, 35.98125, 35.00000, 38.80000,
    43.40000, 45.52500, 46.30000, 45.70625, 43.90000,
    40.37500, 37.10000, 36.52500, 36.70000, 36.48125,
    35.90000, 34.49375, 32.60000, 30.26875, 27.90000,
    26.06875, 24.30000, 22.21875, 20.10000, 18.07500,
    16.20000, 14.74375, 13.20000, 10.86875, 8.60000,
    7.18125, 6.10000, 5.13750, 4.20000, 3.05000,
    1.90000, 0.90625, 0.00000, -0.80000, -1.60000,
    -2.65000, -3.50000, -3.47500, -3.50000, -4.56250,
    -5.80000, -6.55625, -7.20000, -7.93125, -8.60000,
    -9.05000, -9.50000, -10.26875, -10.90000, -10.80625,
    -10.70000, -11.21250, -12.00000, -13.10625, -14.00000,
    -14.02500, -13.60000, -12.69375, -12.00000, -12.57500,
    -13.30000, -13.32500, -12.90000, -11.66250, -10.60000,
    -10.91875, -11.60000, -12.08750, -12.20000, -11.38750,
    -10.20000, -8.66250, -7.80000, -9.40000, -11.20000,
    -11.00000, -10.40000, -10.50625, -10.60000, -10.25000,
    -9.70000, -8.88125, -8.30000, -8.68125, -9.30000,
    -9.79375, -9.80000
  };

  static double s2[107] = {
    0.00000, 1.15625, 2.00000, 2.84375, 4.00000,
    6.41875, 8.50000, 8.50000, 7.80000, 7.29375,
    6.70000, 5.88125, 5.30000, 5.80625, 6.10000,
    4.71250, 3.00000, 2.05000, 1.20000, -0.10000,
    -1.10000, -0.93125, -0.50000, -0.53125, -0.70000,
    -0.87500, -1.20000, -1.91250, -2.60000, -2.84375,
    -2.90000, -2.88125, -2.80000, -2.69375, -2.60000,
    -2.63750, -2.60000, -2.21875, -1.80000, -1.61250,
    -1.50000, -1.38750, -1.30000, -1.25000, -1.20000,
    -1.12500, -1.00000, -0.75000, -0.50000, -0.38750,
    -0.30000, -0.15000, 0.00000, 0.10000, 0.20000,
    0.26250, 0.50000, 1.25000, 2.10000, 2.69375,
    3.20000, 3.68125, 4.10000, 4.43125, 4.70000,
    4.83750, 5.10000, 5.88750, 6.70000, 7.01875,
    7.30000, 7.91250, 8.60000, 9.25625, 9.80000,
    10.19375, 10.20000, 9.19375, 8.30000, 8.90000,
    9.60000, 9.22500, 8.50000, 7.64375, 7.00000,
    7.18125, 7.60000, 7.91875, 8.00000, 7.46875,
    6.70000, 5.73125, 5.20000, 6.24375, 7.40000,
    7.22500, 6.80000, 6.90000, 7.00000, 6.76875,
    6.40000, 5.87500, 5.50000, 5.71875, 6.10000,
    6.43125, 6.50000,
  };

  /* M values for [1nm,5nm][1931,1964][M1,M2][g, h, i, j, k, l] */
  double ms[2][2][2][6] = {
    {				/* 1nm */
     {
      {-1.77864, 5.90745, -1.34666, 0.25540, -0.73218, 0.02387},
      {-31.44505, 30.06408, 0.03656, 0.25540, -0.73218, 0.02387}
      },
     {
      {-1.57049, 5.56450, -1.31211, 0.21249, -0.71591, 0.04663},
      {-30.15166, 31.07906, -0.73912, 0.21249, -0.71591, 0.04663}
      }
     },
    {				/* 5nm */
     {
      {-1.77861, 5.90757, -1.34674, 0.25539, -0.73217, 0.02387},
      {-31.44464, 30.06400, 0.03638, 0.25539, -0.73217, 0.02387}
      },
     {
      {-1.57049, 5.56460, -1.31215, 0.21250, -0.71592, 0.04663},
      {-30.15139, 31.07931, -0.73928, 0.21250, -0.71592, 0.04663}
      }
     }
  };

  int i;
  double xd, yd;
  int sint = 1;			/* 5nm */
  int obs = 0;			/* 1931 */
  double m1, m2;

  if (ct < 2500.0 || ct > 25000.0)
    {				/* Only accurate down to about 4000 */
      abort ();
      return 1;
    }

  /* Compute chromaticity coordinates */
  if (ct < 7000.0)
    {
      xd =
	-4.6070e9 / (ct * ct * ct) + 2.9678e6 / (ct * ct) + 0.09911e3 / ct +
	0.244063;
    }
  else
    {
      xd =
	-2.0064e9 / (ct * ct * ct) + 1.9018e6 / (ct * ct) + 0.24748e3 / ct +
	0.237040;
    }
  yd = -3.000 * xd * xd + 2.870 * xd - 0.275;

  /* Compute m factors */
  m1 =
    (ms[sint][obs][0][0] * xd + ms[sint][obs][0][1] * yd +
     ms[sint][obs][0][2]) / (ms[sint][obs][0][3] * xd +
			     ms[sint][obs][0][4] * yd + ms[sint][obs][0][5]);
  m2 =
    (ms[sint][obs][1][0] * xd + ms[sint][obs][1][1] * yd +
     ms[sint][obs][1][2]) / (ms[sint][obs][1][3] * xd +
			     ms[sint][obs][1][4] * yd + ms[sint][obs][1][5]);

  /* Compute spectral values.
     Argyll starts from 300,w hile we start from 380 thus offset is 80/5=16. */
  for (i = 16; i < 16 + SPECTRUM_SIZE; i++)
    {
      spec[i - 16] = s0[i] + m1 * s1[i] + m2 * s2[i];
    }

#if 0
  sp->spec_n = 107;		/* 5nm spacing */
  sp->spec_wl_short = 300.0;
  sp->spec_wl_long = 830;
  sp->norm = 100.0;		/* Arbitrary */
#endif

  return 0;
}

}

/* Adjust xscale, yscale and zscale so dye rgb (1,1,1) results
   in intensity 1  */
void
spectrum_dyes_to_xyz::normalize_brightness ()
{
  spectrum s;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    s[i] = red [i] * rscale + green [i] * gscale + blue [i] * bscale;
  struct xyz ret = get_xyz (s);
  xscale = yscale = zscale = 1 / ret.y;
  if (debug)
    {
      printf ("Normalizing xyz luminosity range\n");
      printf ("Combined xyz %f %f %f\n", ret.x, ret.y, ret.z);
      printf ("rscale %f gscale %f bscale %f\n", rscale, gscale, bscale);
      printf ("xscale %f yscale %f zscale %f\n", xscale, yscale, zscale);
    }
}
/* Adjust xscale, yscale and zscale so dye rgb (1,1,1) results
   in sRGB white  */
void
spectrum_dyes_to_xyz::normalize_xyz_to_backlight_whitepoint ()
{
  xscale = yscale = zscale = 1;
  xyz whitepoint = whitepoint_xyz ();
  xyz dyewhitepoint = dyes_rgb_to_xyz (1, 1, 1);
  xscale = whitepoint.x / whitepoint.y / dyewhitepoint.x;
  yscale = 1 / dyewhitepoint.y;
  zscale = whitepoint.z / whitepoint.y / dyewhitepoint.z;

  if (debug)
    {
      printf ("Normalizing dyes to backlight by scaling xyz\n"
	      "Whitepoint xyz %f %f %f\n", whitepoint.x / whitepoint.y, whitepoint.y / whitepoint.y, whitepoint.z / whitepoint.y);
      printf ("Dye whitepoint xyz %f %f %f\n", dyewhitepoint.x, dyewhitepoint.y, dyewhitepoint.z);
      printf ("rscale %f gscale %f bscale %f\n", rscale, gscale, bscale);
      printf ("xscale %f yscale %f zscale %f\n", xscale, yscale, zscale);
      dyewhitepoint = dyes_rgb_to_xyz (1, 1, 1);
      printf ("Dye whitepoint xyz %f %f %f\n", dyewhitepoint.x, dyewhitepoint.y, dyewhitepoint.z);
    }
}

/* Autochrome screen was made by mixing dyes to be gray.  Simulate same thing: find
   rscale, gscale and wscale so together they produce a given.  */
void
spectrum_dyes_to_xyz::set_daylight_backlight (luminosity_t temperature)
{
  //compute_spectrum (backlight, 300, 830, sizeof (il_A)/sizeof (luminosity_t), il_A, false);
  daylight_il (backlight, temperature);
}

/* Autochrome screen was made by mixing dyes to be gray.  Simulate same thing: find
   rscale, gscale and wscale so together they produce a given.  */
void
spectrum_dyes_to_xyz::normalize_dyes (luminosity_t temperature)
{
  spectrum backlight_bck;
  memcpy (backlight_bck, backlight, sizeof (backlight));
  daylight_il (backlight, temperature);
  rscale = gscale = bscale = 1;
  xyz rxyz = get_xyz (red);
  xyz gxyz = get_xyz (green);
  xyz bxyz = get_xyz (blue);
  xyz whitepoint = whitepoint_xyz ();

  color_matrix m (rxyz.x, gxyz.x, bxyz.x, 0,
		  rxyz.y, gxyz.y, bxyz.y, 0,
		  rxyz.z, gxyz.z, bxyz.z, 0, 0, 0, 0, 1);
  color_matrix n = m.invert ();
  n.apply_to_rgb (whitepoint.x, whitepoint.y, whitepoint.z, &rscale, &gscale, &bscale);
  if (debug)
    {
      printf ("Normalizing dyes to be neutral at %fK daylight\n"
	      "Whitepoint xyz %f %f %f\n", temperature, whitepoint.x / whitepoint.y, whitepoint.y / whitepoint.y, whitepoint.z / whitepoint.y);
      printf ("Red dye xyz %f %f %f\n", rxyz.x, rxyz.y, rxyz.z);
      printf ("Green dye xyz %f %f %f\n", gxyz.x, gxyz.y, gxyz.z);
      printf ("Blue dye xyz %f %f %f\n", bxyz.x, bxyz.y, bxyz.z);
      printf ("rscale %f gscale %f bscale %f\n", rscale, gscale, bscale);
      printf ("xscale %f yscale %f zscale %f\n", xscale, yscale, zscale);
      xyz dyewhitepoint = dyes_rgb_to_xyz (1, 1, 1);
      printf ("Adjusted dye whitepoint xyz %f %f %f\n", dyewhitepoint.x, dyewhitepoint.y, dyewhitepoint.z);
    }

  memcpy (backlight, backlight_bck, sizeof (backlight));
}

void
change_concentration (spectrum s, luminosity_t concentration)
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    s[i] = pow (s[i], concentration);
}


void
spectrum_dyes_to_xyz::debug_write_spectra ()
{
  FILE *f = fopen ("/tmp/red.dat", "wt");
  print_absorbance_spectrum (f, red);
  fclose (f);
  f = fopen ("/tmp/green.dat", "wt");
  print_absorbance_spectrum (f, green);
  fclose (f);
  f = fopen ("/tmp/blue.dat", "wt");
  print_absorbance_spectrum (f, blue);
  fclose (f);
  f = fopen ("/tmp/red-trans.dat", "wt");
  print_transmitance_spectrum (f, red);
  fclose (f);
  f = fopen ("/tmp/green-trans.dat", "wt");
  print_transmitance_spectrum (f, green);
  fclose (f);
  f = fopen ("/tmp/blue-trans.dat", "wt");
  print_transmitance_spectrum (f, blue);
  fclose (f);
  f = fopen ("/tmp/backlight.dat", "wt");
  print_transmitance_spectrum (f, backlight);
  fclose (f);
  f = fopen ("/tmp/x.dat", "wt");
  print_transmitance_spectrum (f, cie_cmf_x);
  fclose (f);
  f = fopen ("/tmp/y.dat", "wt");
  print_transmitance_spectrum (f, cie_cmf_y);
  fclose (f);
  f = fopen ("/tmp/z.dat", "wt");
  print_transmitance_spectrum (f, cie_cmf_z);
  fclose (f);
}

bool
spectrum_dyes_to_xyz::is_linear ()
{
  const int steps = 16;
  const luminosity_t max_error = (0.5 / 65546);
  for (int r = 0; r < steps; r++)
    for (int g = 0; g < steps; g++)
      for (int b = 0; b < steps; b++)
        {
	  luminosity_t rr = r / (luminosity_t) steps;
	  luminosity_t gg = g / (luminosity_t) steps;
	  luminosity_t bb = b / (luminosity_t) steps;
	  xyz v1 = dyes_rgb_to_xyz (rr, gg, bb);
	  xyz v2 = xyz::from_linear_srgb (rr, gg, bb);
	  if (fabs (v1.x - v2.x) > max_error
	      || fabs (v1.y - v2.y) > max_error
	      || fabs (v1.z - v2.z) > max_error)
	    return false;
        }
  return true;
}

/* Return XYZ of a daylight with given TEMPERATURE.  */
xyz
spectrum_dyes_to_xyz::temperature_xyz (luminosity_t temperature)
{
  spectrum_dyes_to_xyz dyes;
  dyes.set_daylight_backlight (temperature);
  return dyes.whitepoint_xyz ();
}

/* Compute XYZ values.  */
static inline struct xyz
get_xyz_old_observer (spectrum backlight, spectrum s, const char *filename = NULL)
{
  struct xyz ret = { 0, 0, 0 };
  luminosity_t sum = 0;
  FILE *f = NULL;
  if (filename)
     f = fopen(filename, "wt");
  /* TODO: CIE recommends going by 1nm bands and interpolate.
     We can implement that easily if that makes difference.  */
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      ret.x += (cie_cmf_x[i] * s[i] * backlight[i]);
      ret.y += (cie_cmf_y[i] * s[i] * backlight[i]);
      ret.z += (cie_cmf_z[i] * s[i] * backlight[i]);
      sum += cie_cmf_y[i] * backlight[i];
      if (f)
        fprintf (f, "%i %f\n", i * SPECTRUM_STEP + SPECTRUM_START, s[i] * backlight[i]);
    }
  if (f)
    fclose (f);
  luminosity_t scale = 1 / sum;
  ret.x *= scale;
  ret.y *= scale;
  ret.z *= scale;
  /* Argyll scales by backlight.  */
  return ret;
}

void
spectrum_dyes_to_xyz::set_il_A_backlight ()
{
  compute_spectrum (backlight, 300, 830, sizeof (il_A)/sizeof (luminosity_t), il_A, false);
}
void
spectrum_dyes_to_xyz::set_il_B_backlight ()
{
  compute_spectrum (backlight, 320, 780, sizeof (il_B)/sizeof (luminosity_t), il_B, false);
}
void
spectrum_dyes_to_xyz::set_il_C_backlight ()
{
  compute_spectrum (backlight, 320, 780, sizeof (il_C)/sizeof (luminosity_t), il_C, false);
}

xyz
combined_xyz (luminosity_t *dye1, luminosity_t *dye2, luminosity_t *backlight, const char *filename = NULL, const char *filename2 = NULL)
{
  spectrum tmp;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      tmp [i] = (dye1 ? dye1[i] : 1) * (dye2 ? dye2[i] : 1);
    }
  if (filename)
    {
      FILE *f = fopen (filename, "wt");
      print_transmitance_spectrum (f, tmp);
      fclose (f);
    }

  xyz ret = get_xyz_old_observer (backlight, tmp, filename2);
  return ret;
}
void
spectrum_dyes_to_xyz::set_response_to_y ()
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    film_response[i] = cie_cmf_y [i];
}

void
spectrum_dyes_to_xyz::adjust_film_response_for_zeiss_contact_prime_cp2_lens ()
{
  spectrum s;
  compute_spectrum (s, sizeof (zeiss_contact_prime_cp2_tramsmission) / sizeof (spectra_entry), zeiss_contact_prime_cp2_tramsmission, false, 100/* norm */, 0/*min*/);
  for (int i = 0 ; i < SPECTRUM_SIZE; i++)
    film_response[i] *= s[i];
}

void
spectrum_dyes_to_xyz::adjust_film_response_for_canon_CN_E_85mm_T1_3_lens ()
{
  spectrum s;
  compute_spectrum (s, sizeof (canon_CN_E_85mm_T1_3_tramsmission) / sizeof (spectra_entry), canon_CN_E_85mm_T1_3_tramsmission, false, 100/* norm */, 0/*min*/);
  for (int i = 0 ; i < SPECTRUM_SIZE; i++)
    film_response[i] *= s[i];
}

void
spectrum_dyes_to_xyz::set_response_to_neopan_100 ()
{
  spectrum dl;
  daylight_il (dl, 5400);
  compute_log_sensitivity (film_response, sizeof (wedge_Neopan_100_acros_daylight_5400k) / sizeof (spectra_entry), wedge_Neopan_100_acros_daylight_5400k);
  log_sensitivity_to_reversal_transmitance (film_response);
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    if (dl[i])
      film_response[i] /= dl[i];
}

void
spectrum_dyes_to_xyz::set_response_to_ilford_panchromatic ()
{
  spectrum dl;
  daylight_il (dl, 5400);
  compute_spectrum (film_response, sizeof (ilford_manual_of_photography_panchromatic_emulsion_fig54) / sizeof (spectra_entry), ilford_manual_of_photography_panchromatic_emulsion_fig54, false);
  //log2_sensitivity_to_reversal_transmitance (film_response);
  for (int i = 0; i < SPECTRUM_SIZE; i++)
  {
    if (film_response[i] < 0)
      film_response [i] = 0;
    else if (dl[i])
      film_response[i] /= dl[i];
  }
}
void
spectrum_dyes_to_xyz::set_response_to_ilford_panchromatic_fp4 ()
{
  /* It is best to clamp missing data to 0 for spectral response.
     We make sure it remans zero in log_sensitivity_to_reversal_transmiatance  */
  compute_log_sensitivity (film_response, sizeof (ilford_fp4_absolute) / sizeof (spectra_entry), ilford_fp4_absolute);
  log_sensitivity_to_reversal_transmitance (film_response);
}

void
spectrum_dyes_to_xyz::set_response_to_equal ()
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    film_response[i] = 1;
}
void
spectrum_dyes_to_xyz::set_response_to_kodachrome_25 ()
{
  set_dyes_to (red, green, blue, kodachrome_25_sensitivity);
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    film_response[i] = 1;
}

/* Simulate density of recording BACKLIGHT filtred by FILTER1 and FILTER2
   on film with sensitivity RESPONSE.

   RESPONSE is not wedge histogram, but transmitance loss computed by
   log_sensitivity_to_reversal_transmitance

   BACKLIGHT may be NULL if film response is already relative to some backlight.
   FILTER2 may be NULL if filter is missing.  */

static luminosity_t
simulated_response (luminosity_t *backlight, luminosity_t *response, luminosity_t *filter1 = NULL, luminosity_t *filter2 = NULL)
{
  luminosity_t sum = 0;
  luminosity_t rsum = 0;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      luminosity_t val = response[i];
      if (val < 0)
	 if (backlight[i] < 0)
	   printf ("Negative response %i %f\n", i, response[i]);
      assert (val >= 0);
      if (backlight)
	{
	   if (backlight[i] < 0)
	     printf ("Negative backlight %i %f\n", i, backlight[i]);
	   assert (backlight[i]>0);
	   val *= backlight[i];
	}
      rsum += val;
      if (filter1)
	{
#if 0
	  if (filter1[i] < 0 || filter1[i] > 1)
	     printf ("Wrong filter1 %i %f\n", i, filter1[i]);
	  assert (filter1[i] >= 0 && filter1[i] <= 1);
#endif
	  val *= filter1[i];
	}
      if (filter2)
        {
#if 0
	  if (filter2[i] < 0 || filter2[i] > 1)
	     printf ("Wrong filter2 %i %f\n", i, filter2[i]);
          assert (filter2[i] >= 0 && filter2[i] <= 1);
#endif
	  val *= filter2[i];
        }
      sum += val;
    }
  return sum / rsum;
}

/* Increase/decrease concentration of filter S to reach luminosity Y.
   NORM is base for no filter, i.e. estimated density of film base.  */

luminosity_t
adjust_concentration_to_y (spectrum backlight, spectrum s, luminosity_t y, luminosity_t norm = 1)
{
  luminosity_t bestc = 0, bestc_y = 1;
  luminosity_t sum = 0;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    sum += cie_cmf_y[i] * backlight[i];
  for (luminosity_t c = 0.001 ; c < 10; c+=0.001)
    {
      luminosity_t ysum = 0;
      for (int i = 0; i < SPECTRUM_SIZE; i++)
	ysum += (cie_cmf_y[i] * my_pow (s[i] / norm, c) * norm * backlight[i]) ;
      ysum /= sum;
      //printf ("%f %f %f\n",y, ysum, bestc_y);
      if (fabs (ysum - y) < fabs (bestc_y - y))
	{
	  bestc_y = ysum;
	  bestc = c;
	}
    }
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    s[i] = my_pow (s[i]/norm, bestc) * norm;
  return bestc;
}

rgbdata
spectrum_dyes_to_xyz::determine_patch_weights_by_simulated_response (int observer)
{
  xyz whitepoint = whitepoint_xyz (observer);
  rgbdata white = xyz_to_dyes_rgb (whitepoint, observer);
  rgbdata res =
    {
      simulated_response (backlight, film_response, red),
      simulated_response (backlight, film_response, green),
      simulated_response (backlight, film_response, blue)
    };
  return {white.red / res.red, white.green / res.green, white.blue / res.blue};
}

bool
spectrum_dyes_to_xyz::generate_simulated_argyll_ti3_file (FILE *f)
{
  rgbdata res =
    {
      simulated_response (backlight, film_response, red),
      simulated_response (backlight, film_response, green),
      simulated_response (backlight, film_response, blue)
    };
  rgbdata scale = {1/res.red, 1/res.green, 1/res.blue};
  int nsamples = sizeof (TLCI_2012_TCS) / sizeof (xspect);
  fprintf (f, "CTI3\n\n");
  fprintf (f, "DESCRIPTOR \"Colorscreen produced Argyll Calibration Target chart information 3\"\n");
  fprintf (f, "ORIGINATOR \"Argyll target\"\n");
  fprintf (f, "DEVICE_CLASS \"INPUT\"\n");
  fprintf (f, "COLOR_REP \"XYZ_RGB\"\n\n");
  fprintf (f, "NUMBER_OF_FIELDS 10\n");
  fprintf (f, "BEGIN_DATA_FORMAT\n");
  fprintf (f, "SAMPLE_ID XYZ_X XYZ_Y XYZ_Z RGB_R RGB_G RGB_B STDEV_R STDEV_G STDEV_B\n");
  fprintf (f, "END_DATA_FORMAT\n\n");
  fprintf (f, "NUMBER_OF_SETS %i\n", nsamples);
  fprintf (f, "BEGIN_DATA\n");

  for (int y = 0; y < (nsamples + 5) / 6; y++)
    {
      for (int x = 0; x < 6; x++)
	{
	  if (y * 6 + x >= nsamples)
	    continue;
	  xspect &xtile = TLCI_2012_TCS [y * 6 + x];
	  spectrum tile;
	  compute_spectrum (tile, xtile);
	  xyz real_color = get_xyz_old_observer (backlight, tile);
	  rgbdata color =
	    {
	      simulated_response (backlight, film_response, tile, red),
	      simulated_response (backlight, film_response, tile, green),
	      simulated_response (backlight, film_response, tile, blue)
	    };
	  color.red *= scale.red;
	  color.green *= scale.green; 
	  color.blue *= scale.blue;
	  fprintf (f, "A%c%i %f %f %f %f %f %f %f %f %f\n",
		   'A'+y, x+1,
		   real_color.x * 100, real_color.y * 100, real_color.z * 100,
		   color.red * 100, color.green * 100, color.blue * 100, 0.0, 0.0, 0.0);
	}
    }
  fprintf (f, "END_DATA\n");
  return true;
}

rgbdata
spectrum_dyes_to_xyz::film_rgb_response (luminosity_t *s)
{
  return {simulated_response (backlight, film_response, red, s),
	  simulated_response (backlight, film_response, green, s),
	  simulated_response (backlight, film_response, blue, s)};
}

bool
spectrum_dyes_to_xyz::generate_color_target_tiff (const char *filename, const char **error, bool white_balance, bool optimized)
{
  xyz whitepoint = whitepoint_xyz ();
  rgbdata scale = determine_relative_patch_sizes_by_simulated_response ();
  printf ("white balance  %f%% %f%% %f%%\n",100 * scale.red, 100 * scale.green, 100 * scale.blue);
  //scale = determine_patch_weights_by_simulated_response ();
  int nsamples = sizeof (TLCI_2012_TCS) / sizeof (xspect);
  if (optimized)
    {
      rgbdata res =
	{
	  simulated_response (backlight, film_response, red),
	  simulated_response (backlight, film_response, green),
	  simulated_response (backlight, film_response, blue)
	};
      scale.red = 1/res.red;
      scale.green = 1/res.green;
      scale.blue = 1/res.blue;
    }
  else if (white_balance)
    scale = determine_patch_weights_by_simulated_response ();
  else
    {
      rgbdata film_white = film_rgb_response (NULL);
      luminosity_t sum = film_white.red + film_white.green + film_white.blue;
      printf ("response %f %f %f %f\n", film_white.red, film_white.green, film_white.blue, sum);
      scale = /*determine_relative_patch_sizes_by_whitepoint ();*/
              xyz_to_dyes_rgb (whitepoint);
      scale /= sum * 0.3;
    }
  printf ("RGB scales  %f%% %f%% %f%%\n",100 * scale.red, 100 * scale.green, 100 * scale.blue);
  color_matrix m = !optimized ? xyz_matrix () : optimized_xyz_matrix ();
  luminosity_t deltaEsum = 0;
  luminosity_t deltaEmax = 0;

  void *buffer;
  size_t len = create_pro_photo_rgb_profile (&buffer, whitepoint);
  tiff_writer_params par;
  par.filename = filename;
  par.width = 12;
  par.height = (nsamples + 5) / 6;
  par.depth = 32;
  par.hdr = true;
  par.icc_profile = buffer;
  par.icc_profile_len = len;
  tiff_writer tiff (par, error);
  if (*error)
    {
      free (buffer);
      return false;
    }
  for (int y = 0; y < (nsamples + 5) / 6; y++)
    {
      for (int d = 0; d < 2; d++)
	{
	  for (int x = 0; x < 6; x++)
	    {
	      xspect &xtile = TLCI_2012_TCS [std::min (y * 6 + x, nsamples - 1)];
	      spectrum tile;
	      compute_spectrum (tile, xtile);
	      xyz real_color = get_xyz_old_observer (backlight, tile);
	      rgbdata color = film_rgb_response (tile);
	      color.red *= scale.red;
	      color.green *= scale.green; 
	      color.blue *= scale.blue;
	      xyz dufay_color (0,0,0);
	      m.apply_to_rgb (color.red, color.green, color.blue, &dufay_color.x, &dufay_color.y, &dufay_color.z);
	      //xyz dufay_color = dyes_rgb_to_xyz (color.red, color.green, color.blue);
	      luminosity_t r,g,b;
	      xyz_to_pro_photo_rgb (real_color.x, real_color.y, real_color.z, &r, &g, &b);
	      tiff.put_hdr_pixel (x * 2, r, g, b);
	      xyz_to_pro_photo_rgb (dufay_color.x, dufay_color.y, dufay_color.z, &r, &g, &b);
	      tiff.put_hdr_pixel (x * 2 + 1, r, g, b);
	      if (y * 6 + x < nsamples)
		{
		  luminosity_t de = deltaE2000 (real_color, dufay_color);
		  if (de > deltaEmax)
		    deltaEmax = de;
		  deltaEsum += de;
		}
	    }
	  if (!tiff.write_row ())
	    {
	      *error = "write error";
	      free (buffer);
	      return false;
	    }
	}
    }
  free (buffer);
  printf ("Average deltaE 2000 %f, max %f\n", deltaEsum / nsamples, deltaEmax);
  return true;
}
color_matrix
spectrum_dyes_to_xyz::optimized_xyz_matrix ()
{
  xyz whitep = /*srgb_white*/ whitepoint_xyz ();
  const int n = sizeof (TLCI_2012_TCS) / sizeof (xspect);
  rgbdata colors[n];
  xyz targets[n];
  rgbdata res =
    {
      simulated_response (backlight, film_response, red),
      simulated_response (backlight, film_response, green),
      simulated_response (backlight, film_response, blue)
    };
  for (int i = 0; i < n; i++)
    {
      xspect &xtile = TLCI_2012_TCS [i];
      spectrum tile;
      compute_spectrum (tile, xtile);
      colors[i].red   = simulated_response (backlight, film_response, tile, red)/res.red;
      colors[i].green = simulated_response (backlight, film_response, tile, green)/res.green;
      colors[i].blue  = simulated_response (backlight, film_response, tile, blue)/res.blue;
      targets[i] = get_xyz_old_observer (backlight, tile);
    }
  color_matrix m1 = determine_color_matrix (colors, targets, n, NULL);
#if 0

  luminosity_t rw, gw,bw;
  cm.normalize_grayscale (whitep.x, whitep.y, whitep.z, &rw, &gw, &bw);
  rgbdata dred = {0,0,0}, dgreen = {0,0,0}, dblue = {0,0,0};
  rgbdata res =
    {
      simulated_response (backlight, film_response, red),
      simulated_response (backlight, film_response, green),
      simulated_response (backlight, film_response, blue)
    };

  dred.red   = simulated_response (backlight, film_response, red, red)/res.red;
  dred.green = simulated_response (backlight, film_response, red, green)/res.green;
  dred.blue  = simulated_response (backlight, film_response, red, blue)/res.blue;
  dgreen.red   = simulated_response (backlight, film_response, green, red)/res.red;
  dgreen.green = simulated_response (backlight, film_response, green, green)/res.green;
  dgreen.blue  = simulated_response (backlight, film_response, green, blue)/res.blue;
  dblue.red   = simulated_response (backlight, film_response, blue, red)/res.red;
  dblue.green = simulated_response (backlight, film_response, blue, green)/res.green;
  dblue.blue  = simulated_response (backlight, film_response, blue, blue)/res.blue;
  color_matrix m1 = xyz_matrix ();
  color_matrix m2 (dred.red,   dgreen.red,   dblue.red,   0,
		   dred.green, dgreen.green, dblue.green, 0,
		   dred.blue,  dgreen.blue,  dblue.blue,  0,
		   0  , 0  , 0  , 1);
  m2 = m2.invert ();
  m1 = m1 * m2;
  //m1.normalize_grayscale (whitep.x, whitep.y, whitep.z);
#endif
  
  return m1;
}
void
spectrum_dyes_to_xyz::write_spectra (const char *reds, const char *greens, const char *blues, const char *backlights, int start, int end, bool absorbance)
{
  if (reds)
    {
      FILE *f = fopen (reds, "wt");
      if (absorbance)
        print_absorbance_spectrum (f, red, start, end);
      else
        print_transmitance_spectrum (f, red, start, end);
      fclose (f);
    }
  if (greens)
    {
      FILE *f = fopen (greens, "wt");
      if (absorbance)
        print_absorbance_spectrum (f, green, start, end);
      else
        print_transmitance_spectrum (f, green, start, end);
      fclose (f);
    }
  if (blues)
    {
      FILE *f = fopen (blues, "wt");
      if (absorbance)
        print_absorbance_spectrum (f, blue, start, end);
      else
        print_transmitance_spectrum (f, blue, start, end);
      fclose (f);
    }
  if (backlights)
    {
      FILE *f = fopen (backlights, "wt");
      print_transmitance_spectrum (f, backlight, start, end);
      fclose (f);
    }
}

/* Output gnuplottable data.  */
static void
print_response_spectrum (FILE * out, const spectrum spec, int start = SPECTRUM_START, int end = SPECTRUM_END)
{
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    if (i * SPECTRUM_STEP + SPECTRUM_START >= start && i * SPECTRUM_STEP + SPECTRUM_START <= end)
      {
	//if (spec[i])
	  fprintf (out, "%i %f\n", i * SPECTRUM_STEP + SPECTRUM_START, log10 (spec[i]));
	//else
	  //fprintf (out, "%i\n", i * SPECTRUM_STEP + SPECTRUM_START, log10 (spec[i]));
	//assert (spec[i] > -100 && spec [i] < 100);
      }
}

/* Write response of the film covered by optional filter specified by F.  */

bool
spectrum_dyes_to_xyz::write_film_response (const char *filename, luminosity_t *fi, bool absolute, bool log)
{
  FILE *f = fopen (filename, "wt");
  if (!f)
    return false;
  luminosity_t sum = 0;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    sum += film_response[i] * (!absolute ? backlight[i] : 1);
  spectrum s;
  for (int i = 0; i < SPECTRUM_SIZE; i++)
  {
    s[i] = (film_response[i] * (!absolute ? backlight[i] : 1) * (fi ? fi[i] : 1) * 100) / sum;
    //printf ("%s %f %f %f %f\n", filename, s[i], film_response[i] , (!absolute ? backlight[i] : 1), (fi ? fi[i] : 1));
  }
  if (log)
    print_response_spectrum (f, s);
  else
    print_transmitance_spectrum (f, s);
  fclose (f);
  return true;
}

/* Output tiff file showing primaries.  */
bool
tiff_with_strips (const char *filename, xyz filter_red, xyz filter_green, xyz filter_blue, xyz background, xyz white)
{
  void *buffer;
  size_t len = create_pro_photo_rgb_profile (&buffer, srgb_white);
  tiff_writer_params par;
  par.filename=filename;
  par.width = par.height = 19;
  par.height = 19;
  par.height = 19;
  par.depth = 32;
  par.hdr = true;
  par.icc_profile = buffer;
  par.icc_profile_len = len;
  const char *error;
  tiff_writer tiff (par, &error);
  if (error)
    {
      free (buffer);
      return false;
    }
  luminosity_t r,g,b;
  for (int i = 0; i < 19; i++)
    {
      xyz_to_pro_photo_rgb (background.x, background.y, background.z, &r, &g, &b);
      for (int j = 0; j < 19; j++)
	tiff.put_hdr_pixel (j, r, g, b);
      //filter_red.print (stdout);
      //filter_green.print (stdout);
      //filter_blue.print (stdout);
      xyz_to_pro_photo_rgb (filter_red.x, filter_red.y, filter_red.z, &r, &g, &b);
      tiff.put_hdr_pixel (4, r, g, b);
      tiff.put_hdr_pixel (5, r, g, b);
      tiff.put_hdr_pixel (6, r, g, b);
      xyz_to_pro_photo_rgb (filter_green.x, filter_green.y, filter_green.z, &r, &g, &b);
      tiff.put_hdr_pixel (8, r, g, b);
      tiff.put_hdr_pixel (9, r, g, b);
      tiff.put_hdr_pixel (10, r, g, b);
      xyz_to_pro_photo_rgb (filter_blue.x, filter_blue.y, filter_blue.z, &r, &g, &b);
      tiff.put_hdr_pixel (12, r, g, b);
      tiff.put_hdr_pixel (13, r, g, b);
      tiff.put_hdr_pixel (14, r, g, b);
      xyz_to_pro_photo_rgb (white.x, white.y, white.z, &r, &g, &b);
      tiff.put_hdr_pixel (16, r, g, b);
      tiff.put_hdr_pixel (17, r, g, b);
      tiff.put_hdr_pixel (18, r, g, b);
      if (!tiff.write_row ())
	{
	  free (buffer);
	  return false;
	}
    }
  free (buffer);
  return true;
}

bool
spectrum_dyes_to_xyz::tiff_with_primaries (const char *filename, rgbdata white)
{
  return tiff_with_strips (filename,
			   dyes_rgb_to_xyz (1, 0, 0),
			   dyes_rgb_to_xyz (0, 1, 0),
			   dyes_rgb_to_xyz (0, 0, 1),
			   whitepoint_xyz (),
			   dyes_rgb_to_xyz (white.red, white.green, white.blue));
}

bool
spectrum_dyes_to_xyz::tiff_with_overlapping_filters (const char *filename, rgbdata white, const char *spectra_prefix)
{
  xyz filter_white = dyes_rgb_to_xyz (white.red, white.green, white.blue);
  xyz whitepoint = whitepoint_xyz ();
  void *buffer;
  size_t len = create_pro_photo_rgb_profile (&buffer, whitepoint);

  tiff_writer_params par;
  par.filename=filename;
  par.width = 19;
  par.height = 19;
  par.depth = 32;
  par.hdr = true;
  par.icc_profile = buffer;
  par.icc_profile_len = len;
  const char *error;
  tiff_writer tiff (par, &error);
  if (error)
    {
      free (buffer);
      return false;
    }
  luminosity_t r,g,b;
  for (int i = 0; i < 5; i++)
    {
      int br = /*200*/1;
      for (int d = 0; d < (i == 4 ? 3 : 4); d++)
	{
	  xyz_to_pro_photo_rgb (filter_white.x * br, filter_white.y * br, filter_white.z * br, &r, &g, &b);
	  int i1 = i == 0 || i == 4 || d == 3 ? -1 : i-1;
	  for (int j = 0; j < 19; j++)
	    tiff.put_hdr_pixel (j, r, g, b);
	  for (int j = 0; j < 5; j++)
	    {
	      xyz_to_pro_photo_rgb (filter_white.x * br, filter_white.y * br, filter_white.z * br, &r, &g, &b);
	      for (int d2 = 0; d2 < (j == 4 ? 3 : 4); d2++)
		{
		  int mul = 1;
		  const char *filename = NULL;
		  const char *filename2 = NULL;
		  std::string sfile, sfile2;
		  int i2 = j == 0 || j == 4 || d2 == 3 ? -1 : j-1;
		  if (spectra_prefix)
		    {
		      const char *name[3]={"red","green","blue"};
		      sfile = std::string (spectra_prefix);
		      sfile2 = std::string (spectra_prefix);
		      if (i1 >= 0)
			{
			  sfile = sfile + std::string (name[i1]);
			  sfile2 = sfile2 + std::string (name[i1]);
			}
		      if (i2 >= 0)
			{
			  sfile = sfile + std::string (name[i2]);
			  sfile2 = sfile2 + std::string (name[i2]);
			}
		      sfile = sfile + ".dat";
		      sfile2 = sfile2 + "-backlight.dat";
		      filename = sfile.c_str ();
		      filename2 = sfile2.c_str ();
		    }
		  xyz f = combined_xyz (i1 < 0 ? NULL : i1 == 0 ? red : i1 == 1 ? green : blue,
					i2 < 0 ? NULL : i2 == 0 ? red : i2 == 1 ? green : blue,
					backlight, filename, filename2);
		  int br2 = (i && j) ? br : 1;
		  xyz_to_pro_photo_rgb (f.x * br2, f.y * br2, f.z * br2, &r, &g, &b);
		  tiff.put_hdr_pixel (j*4+d2, r*mul, g*mul, b*mul);
		}
	    }
	  if (!tiff.write_row ())
	    {
	      free (buffer);
	      return false;
	    }
	}
    }
  free (buffer);
  return true;
}
bool
spectrum_dyes_to_xyz::tiff_with_overlapping_filters_response (const char *filename, rgbdata white)
{
  tiff_writer_params par;
  par.filename=filename;
  par.width = 23;
  par.height = 19;
  par.depth = 32;
  par.hdr = true;
  void *buffer;
  size_t len = create_pro_photo_rgb_profile (&buffer, whitepoint_xyz ());
  par.icc_profile = buffer;
  par.icc_profile_len = len;
  const char *error;
  tiff_writer tiff (par, &error);
  if (error)
  {
    free (buffer);
    return false;
  }
  luminosity_t gamma = 1;
  rgbdata dred = {0,0,0}, dgreen = {0,0,0}, dblue = {0,0,0}, dwhite = {0,0,0};

  dred.red   = simulated_response (backlight, film_response, red, red);
  dred.green = simulated_response (backlight, film_response, red, green);
  dred.blue  = simulated_response (backlight, film_response, red, blue);
  dgreen.red   = simulated_response (backlight, film_response, green, red);
  dgreen.green = simulated_response (backlight, film_response, green, green);
  dgreen.blue  = simulated_response (backlight, film_response, green, blue);
  dblue.red   = simulated_response (backlight, film_response, blue, red);
  dblue.green = simulated_response (backlight, film_response, blue, green);
  dblue.blue  = simulated_response (backlight, film_response, blue, blue);
  dwhite.red   = simulated_response (backlight, film_response, red);
  dwhite.green = simulated_response (backlight, film_response, green);
  dwhite.blue  = simulated_response (backlight, film_response, blue);
  luminosity_t dglass = simulated_response (backlight, film_response);
  color_matrix m = xyz_matrix ();

  for (int i = 0; i < 5; i++)
    {
      for (int d = 0; d < (i == 4 ? 3 : 4); d++)
	{
	  int i1 = i == 0 || i == 4 || d == 3 ? -1 : i-1;
	  luminosity_t g = invert_gamma (dglass, gamma);
	  for (int j = 0; j < 19; j++)
	    tiff.put_hdr_pixel (j, g, g, g);
	  for (int j = 0; j < 5; j++)
	    {
	      for (int d2 = 0; d2 < (j == 4 ? 3 : 4); d2++)
		{
		  luminosity_t dd;

		  int i2 = j == 0 || j == 4 || d2 == 3 ? -1 : j-1;
		  if (i1 == -1 && i2 == -1)
		    dd = dglass;
		  else if (i1 == -1 || i2 == -1)
		    {
		      int c = i1 == -1 ? i2 : i1;
		      dd = dwhite[c];
		    }
		  else if (i1 == 0)
		    dd = dred[i2];
		  else if (i1 == 1)
		    dd = dgreen[i2];
		  else 
		    dd = dblue[i2];
		  g = invert_gamma (dd, gamma);
		  tiff.put_hdr_pixel (j*4+d2, g,g,g);
		}
	    }
	  luminosity_t r=1, b=1;
	  g=1;
	  if (i1 != -1 || (i == 0 && d < 3))
	    {
	      rgbdata &f = i == 0 ? dwhite : (i1 == 0) ? dred : (i1 == 1) ? dgreen : dblue;
	      //xyz c = (filter_red * f.red) + (filter_green * f.green) + (filter_blue * f.blue);
	      xyz c (0,0,0);
	      m.apply_to_rgb (f.red * white.red, f.green * white.green, f.blue * white.blue, &c.x, &c.y, &c.z);
	      xyz_to_pro_photo_rgb (c.x, c.y, c.z, &r, &g, &b);
	    }
	  tiff.put_hdr_pixel (19, 0, 0, 0);
	  tiff.put_hdr_pixel (20, r, g, b);
	  tiff.put_hdr_pixel (21, r, g, b);
	  tiff.put_hdr_pixel (22, r, g, b);
	  if (!tiff.write_row ())
	    return false;
	}
    }
  free (buffer);
  return true;
}

bool
write_optimal_response (color_matrix m, const char *redname, const char *greenname, const char *bluename, luminosity_t rw, luminosity_t gw, luminosity_t bw)
{
  FILE *redf = fopen (redname, "wt");
  if (!redf)
    return NULL;
  FILE *greenf = fopen (greenname, "wt");
  if (!greenf)
    {
      fclose (redf);
      return NULL;
    }
  FILE *bluef = fopen (bluename, "wt");
  if (!bluef)
    {
      fclose (redf);
      fclose (greenf);
      return NULL;
    }
  color_matrix im = m.invert ();
  for (int i = 0; i < SPECTRUM_SIZE; i++)
    {
      luminosity_t r, g, b;
      int freq = i * SPECTRUM_STEP + SPECTRUM_START;
      im.apply_to_rgb (cie_cmf_x[i], cie_cmf_y[i], cie_cmf_z[i], &r, &g, &b);
      fprintf (redf, "%f %f\n", (double)freq, r/rw);
      fprintf (greenf, "%f %f\n", (double)freq, g/gw);
      fprintf (bluef, "%f %f\n", (double)freq, b/bw);
    }
  fclose (redf);
  fclose (greenf);
  fclose (bluef);
  return true;
}

void
spectrum_dyes_to_xyz::synthetic_dufay_red (luminosity_t d1, luminosity_t d2)
{
  set_synthetic_dufay_red (red, d1, d2);
}

void
spectrum_dyes_to_xyz::synthetic_dufay_green (luminosity_t d1, luminosity_t d2)
{
  set_synthetic_dufay_green (red, d1, d2);
}

void
spectrum_dyes_to_xyz::synthetic_dufay_blue (luminosity_t d1, luminosity_t d2)
{
  set_synthetic_dufay_blue (red, d1, d2);
}

void
spectrum_dyes_to_xyz::set_dyes (enum dyes dyes, enum dyes dyes2, luminosity_t age)
{
  set_dyes_to (red, green, blue, dyes);
  if (age > 0)
    {
      spectrum aged_red, aged_green, aged_blue;
      set_dyes_to (aged_red, aged_green, aged_blue, dyes2);
      for (int i = 0; i < SPECTRUM_SIZE; i++)
	{
	  red[i] = red[i] * (1 - age) + aged_red[i] * age;
	  green[i] = green[i] * (1 - age) + aged_green[i] * age;
	  blue[i] = blue[i] * (1 - age) + aged_blue[i] * age;
	}
    }
}
