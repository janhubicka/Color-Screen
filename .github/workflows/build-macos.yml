name: MacOS build

on:
  push:
    branches: [ "main", "v1-branch", "Kimrova-bachelorRelease" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install libtiff
      run: brew install -v libtiff
    - name: Install libjpeg-turbo
      run: brew install -v libjpeg-turbo
    - name: Install libzip
      run: brew install -v libzip
    - name: List libzip
      run: brew list libzip
    - name: Install libgsl
      run: brew install -v gsl
    - name: Install libraw
      run: brew install -v libraw
    - name: Install little-cms2
      run: brew install -v little-cms2
    - name: Install libomp
      run: brew install -v libomp
    - name: Install gtk+
      run: brew install -v gtk+
    - name: Install fftw
      run: brew install -v fftw
    - name: Install qt6
      run: brew install -v qt6
    - name: Link qt6
      run: brew link qt6 --force

    - name: Install dynlibbundler
      run: brew install -v dylibbundler
    - name: Bulid libzip
      run: |
        wget https://libzip.org/download/libzip-1.10.1.tar.xz
        tar xJvf libzip-1.10.1.tar.xz
        cd libzip-*
        cmake -DBUILD_SHARED_LIBS=OFF
        make
        find . -name libzip*.a
    - name: configure
      run: |
        #/opt/homebrew/opt/libomp/lib/libomp.a
        #CXXFLAGS="-Ofast -flto -I/opt/homebrew/include -I/opt/homebrew/opt/libomp/include -Xclang=-fopenmp" LDFLAGS="/opt/homebrew/lib/libtiff.a /opt/homebrew/lib/libturbojpeg.a /opt/homebrew/opt/libomp/lib/libomp.a -L/opt/homebrew/lib -L/opt/homebrew/opt/libomp/lib " CXX=clang++ CC=clang ./configure --disable-openmp --prefix=/tmp/Color-Screen-MacOS --enable-gtkgui
        #/opt/homebrew/lib/libcblas.a
        #ls /opt/homebrew/lib/*.a
        export PATH="/opt/homebrew/opt/qt6/bin:/opt/homebrew/opt/qt/bin:$(brew --prefix qt6)/bin:$PATH"
        # Debug and find MOC explicitly
        echo "Looking for moc..."
        QT6_PREFIX=$(brew --prefix qt6)
        MOC_CANDIDATE=$(find "$QT6_PREFIX" -name "moc" -type f -perm +111 | head -n 1)
        if [ -z "$MOC_CANDIDATE" ]; then
             MOC_CANDIDATE=$(find /opt/homebrew -name "moc" -type f -perm +111 2>/dev/null | grep qt | head -n 1)
        fi
        
        if [ -n "$MOC_CANDIDATE" ]; then
          echo "Found moc at: $MOC_CANDIDATE"
          export MOC="$MOC_CANDIDATE"
          # Also add its dir to PATH
          export PATH="$(dirname "$MOC_CANDIDATE"):$PATH"
        else
          echo "WARNING: Could not find moc executable via find."
          # Fallback to pkg-config attempt
          QT6_BIN=$(pkg-config --variable=host_bins Qt6Core)
          if [ -n "$QT6_BIN" ]; then
             echo "Qt6 bin from pkg-config: $QT6_BIN"
             export PATH="$QT6_BIN:$PATH"
          fi
        fi
        
        echo "Final PATH=$PATH"
        echo "MOC=$MOC"

        CXXFLAGS="-Ofast -flto -I/opt/homebrew/include -I/opt/homebrew/opt/libomp/include -Xclang=-fopenmp" LDFLAGS="/opt/homebrew/lib/libjasper.a /opt/homebrew/lib/libjpeg.a /opt/homebrew/lib/libzstd.a /opt/homebrew/lib/liblzma.a /opt/homebrew/lib/libgslcblas.a /opt/homebrew/lib/libgsl.a /opt/homebrew/lib/libtiff.a /opt/homebrew/lib/libturbojpeg.a /opt/homebrew/lib/liblcms2.a /opt/homebrew/lib/libfftw3.a -L/opt/homebrew/lib -L/opt/homebrew/opt/libomp/lib -lomp $(pwd)/libzip*/lib/libzip.a" CXX=clang++ CC=clang ./configure --disable-openmp --prefix=/tmp/Color-Screen-MacOS --enable-gtkgui --enable-qtgui --disable-static-link --disable-dependencies MOC="$MOC"
    - name: Upload config.log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: config.log
        path: |
          config.log
    - name: make
      run: make
    - name: make check
      run: make check
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: testsuite
        path: |
          testsuite/*.txt
          testsuite/*.log
          testsuite/*.par
    - name: make install-strip
      run: make install-strip
    - name: tar
      run: cd /tmp ; tar czvf /tmp/Color-Screen-MacOS.tar.gz Color-Screen-MacOS/
    - uses: actions/upload-artifact@v4
      with:
        name: macOS-binary
        path: /tmp/Color-Screen-MacOS.tar.gz
    - name: Install imagemagick
      run: brew install -v imagemagick

    - name: Package App Bundle
      run: |
        # Create App Structure
        mkdir -p Color-Screen.app/Contents/MacOS
        mkdir -p Color-Screen.app/Contents/Resources
        
        # Copy Binaries
        cp /tmp/Color-Screen-MacOS/bin/colorscreen-qt Color-Screen.app/Contents/MacOS/Color-Screen
        cp /tmp/Color-Screen-MacOS/bin/colorscreen Color-Screen.app/Contents/MacOS/
        
        # Create Info.plist
        cat > Color-Screen.app/Contents/Info.plist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>Color-Screen</string>
            <key>CFBundleIconFile</key>
            <string>icon.icns</string>
            <key>CFBundleIdentifier</key>
            <string>com.janhubicka.colorscreen</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleSignature</key>
            <string>????</string>
            <key>LSMinimumSystemVersion</key>
            <string>10.13</string>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # Generate Icon
        mkdir icon.iconset
        magick -background none images/icon.svg -resize 16x16     icon.iconset/icon_16x16.png
        magick -background none images/icon.svg -resize 32x32     icon.iconset/icon_16x16@2x.png
        magick -background none images/icon.svg -resize 32x32     icon.iconset/icon_32x32.png
        magick -background none images/icon.svg -resize 64x64     icon.iconset/icon_32x32@2x.png
        magick -background none images/icon.svg -resize 128x128   icon.iconset/icon_128x128.png
        magick -background none images/icon.svg -resize 256x256   icon.iconset/icon_128x128@2x.png
        magick -background none images/icon.svg -resize 512x512   icon.iconset/icon_512x512.png
        magick -background none images/icon.svg -resize 1024x1024 icon.iconset/icon_512x512@2x.png
        iconutil -c icns icon.iconset
        cp icon.icns Color-Screen.app/Contents/Resources/
        
        # Run macdeployqt
        $(brew --prefix qt6)/bin/macdeployqt Color-Screen.app -verbose=2 -always-overwrite
        
        # Manually copy missing dylibs (similar to Windows)
        # Assuming brew installs are in standard locations
        cp /opt/homebrew/lib/libgsl.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libgslcblas.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libtiff.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libjpeg.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/liblcms2.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libraw.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libfftw3.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libomp.dylib Color-Screen.app/Contents/Frameworks/ || true
        cp /opt/homebrew/lib/libzip.*.dylib Color-Screen.app/Contents/Frameworks/ || true
        
        # Fix RPATHs for manually copied libs
        # This is basic, might need recursive fixup script if deps have deps
        for LIB in Color-Screen.app/Contents/Frameworks/*.dylib; do
            NAME=$(basename "$LIB")
            install_name_tool -id "@executable_path/../Frameworks/$NAME" "$LIB"
        done
        
        install_name_tool -change /opt/homebrew/lib/libgsl.27.dylib @executable_path/../Frameworks/libgsl.27.dylib Color-Screen.app/Contents/MacOS/Color-Screen
        install_name_tool -change /opt/homebrew/lib/libgslcblas.0.dylib @executable_path/../Frameworks/libgslcblas.0.dylib Color-Screen.app/Contents/MacOS/Color-Screen
        
        # Deep Code Sign (Ad-Hoc)
        codesign --deep --force --verify --verbose --sign "-" Color-Screen.app
        
        # Capture debug info
        $(brew --prefix qt6)/bin/macdeployqt Color-Screen.app -verbose=2 > macdeployqt_debug.txt 2>&1 || true
        
        # Zip it
        ditto -c -k --keepParent Color-Screen.app Color-Screen-macOS.zip

    - uses: actions/upload-artifact@v4
      with:
        name: macdeployqt-debug
        path: macdeployqt_debug.txt

    - uses: actions/upload-artifact@v4
      with:
        name: macOS-Color-Screen-App
        path: Color-Screen-macOS.zip
    - name: make distclean
      run: make distclean
    - name: configure with checking
      run: |
        export PATH="/opt/homebrew/opt/qt6/bin:/opt/homebrew/opt/qt/bin:$(brew --prefix qt6)/bin:$PATH"
        # Debug and find MOC explicitly
        echo "Looking for moc..."
        QT6_PREFIX=$(brew --prefix qt6)
        MOC_CANDIDATE=$(find "$QT6_PREFIX" -name "moc" -type f -perm +111 | head -n 1)
        if [ -z "$MOC_CANDIDATE" ]; then
             MOC_CANDIDATE=$(find /opt/homebrew -name "moc" -type f -perm +111 2>/dev/null | grep qt | head -n 1)
        fi
        
        if [ -n "$MOC_CANDIDATE" ]; then
          echo "Found moc at: $MOC_CANDIDATE"
          export MOC="$MOC_CANDIDATE"
          export PATH="$(dirname "$MOC_CANDIDATE"):$PATH"
        else
          QT6_BIN=$(pkg-config --variable=host_bins Qt6Core)
          if [ -n "$QT6_BIN" ]; then
             export PATH="$QT6_BIN:$PATH"
          fi
        fi
        
        CXXFLAGS="-O3 -ffast-math -Wall -I/opt/homebrew/include -I/opt/homebrew/opt/libomp/include -Xclang=-fopenmp -march=native" LDFLAGS="-L/opt/homebrew/lib -L/opt/homebrew/opt/libomp/lib -lomp" CXX=clang++ CC=clang ./configure --disable-openmp --prefix=/tmp/Color-Screen-MacOS --enable-gtkgui --enable-qtgui --enable-checking --disable-static-link MOC="$MOC"
    - name: make (checking enabled)
      run: make
    - name: make check (checking enabled)
      run: make check
    - name: Upload Test Results (checking enabled)
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: testsuite-checking
        path: |
          testsuite/*.txt
          testsuite/*.log

    - name: Uninstall libgsl to break one of dependencies
      run: brew uninstall  gsl
    - name: Remove install directory
      run: rm -fr /tmp/Color-Screen-MacOS
    - name: Verify that colorscreen still runs
      run: |
        # CLI Test
        Color-Screen.app/Contents/MacOS/colorscreen autodetect testsuite/dufaycolor_nikon_coolsan9000ED_4000DPI_raw.tif test.par
        
        # GUI Smoke Test (launch and quit)
        # Note: Interactive UI tests on GHA runners are tricky, but open/kill works
        open -n Color-Screen.app
        sleep 10
        osascript -e 'quit app "Color-Screen"'
