name: MacOS build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install libtiff
      run: brew install -v libtiff
    - name: Install libjpeg-turbo
      run: brew install -v libjpeg-turbo
    - name: Install libzip
      run: brew install -v libzip
    - name: Install libgsl
      run: brew install -v gsl
    - name: Install libraw
      run: brew install -v libraw
    - name: Install little-cms2
      run: brew install -v little-cms2
    - name: Install libomp
      run: brew install -v libomp
    - name: Install gtk+
      run: brew install -v gtk+
    - name: configure
      run: CXXFLAGS="-I/opt/homebrew/include -I/opt/homebrew/opt/libomp/include -Xclang=-fopenmp" LDFLAGS="-L/opt/homebrew/lib -L/opt/homebrew/opt/libomp/lib -lomp" CXX=clang++ CC=clang ./configure --disable-openmp --prefix=/tmp/Color-Screen-MacOS --enable-gtkgui
    - name: make
      run: make
    - name: make check
      run: make check
    - name: make install
      run: make install
    - name: tar
      run: cd /tmp ; tar czvf /tmp/Color-Screen-MacOS.tar.gz Color-Screen-MacOS/
    - uses: actions/upload-artifact@v4
      with:
        name: macOS-binary
        path: /tmp/Color-Screen-MacOS.tar.gz
    - name: setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        architecture: x64
        distribution: 'temurin'
    - name: digital coloring GUI
      run: git clone https://gitlab.mff.cuni.cz/kimroval/Color-Screen-GUI.git
    - name: digital coloring GUI
      run: find / -name jni.h
    - name: Set properties
      run: cp .github/workflows/digital-coloring-github-macos.properties Color-Screen-GUI/src/main/resources/maven-config-properties/user.properties
