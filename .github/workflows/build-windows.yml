name: Windows build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        architecture: x64
        distribution: 'temurin'
        cache: maven
    - name: Set up Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.6
    - name: test maven
      run: mvn -v
    - uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        install: make mingw-w64-x86_64-gcc mingw-w64-x86_64-gtk2 mingw-w64-x86_64-libtiff mingw-w64-x86_64-libjpeg-turbo git mingw-w64-x86_64-pkg-config mingw-w64-x86_64-libraw mingw-w64-x86_64-lcms  mingw-w64-x86_64-libzip mingw-w64-x86_64-gsl 
    - name: find gcc
      shell: msys2 {0}
      run: find /mingw64 -name gcc.exe
    - name: configure
      shell: msys2 {0}
      run: ./configure --enable-gtkgui --prefix=/c/Color-Screen-install
    - name: make
      shell: msys2 {0}
      run: make
    - name: make check
      shell: msys2 {0}
      run: make check
    - name: make install
      shell: msys2 {0}
      run: make install
    - name: print dlls gtk
      shell: msys2 {0}
      run: ldd /c/Color-Screen-install/bin/colorscreen-gtk
    - name: print dlls dll
      shell: msys2 {0}
      run: ldd /c/Color-Screen-install/bin/libcolorscreen*dll
    - name: copy dlls
      shell: msys2 {0}
      run: cp /mingw64/bin/libgcc_s_seh-*.dll /mingw64/bin/libcairo-*.dll /mingw64/bin/libgdk_pixbuf-*.dll /mingw64/bin/libgdk-*.dll /mingw64/bin/libglib-*.dll /mingw64/bin/libgomp-*.dll /mingw64/bin/libgobject-*.dll /mingw64/bin/libgsl-*.dll /mingw64/bin/libwinpthread-*.dll /mingw64/bin/libgtk-*.dll /mingw64/bin/liblcms2-*.dll /mingw64/bin/libtiff-*.dll /mingw64/bin/libraw-*.dll /mingw64/bin/libstdc++-*.dll /mingw64/bin/libzip.dll /mingw64/bin/libturbojpeg.dll /mingw64/bin/libgio-*.dll /mingw64/bin/libintl-*.dll /mingw64/bin/libpango-*.dll /mingw64/bin/libpangocairo-*.dll /mingw64/bin/libfontconfig-*.dll /mingw64/bin/libpixman-*.dll /mingw64/bin/libfreetype-*.dll /mingw64/bin/libpng16-*.dll /mingw64/bin/zlib1.dll /mingw64/bin/libgmodule-*.dll /mingw64/bin/libffi-*.dll /mingw64/bin/libpcre2-*.dll /mingw64/bin/libatk-*.dll /mingw64/bin/libgslcblas-*.dll /mingw64/bin/libdeflate.dll /mingw64/bin/libjbig-*.dll /mingw64/bin/libjpeg-*.dll /mingw64/bin/libLerc.dll /mingw64/bin/liblzma-*.dll /mingw64/bin/libwebp-*.dll /mingw64/bin/libzstd.dll /mingw64/bin/libpangowin32-*.dll /mingw64/bin/libbz2-*.dll /mingw64/bin/libiconv-*.dll /mingw64/bin/libharfbuzz-*.dll /mingw64/bin/libthai-*.dll /mingw64/bin/libfribidi-*.dll /mingw64/bin/libpangoft2-*.dll /mingw64/bin/libexpat-*.dll /mingw64/bin/libbrotlidec.dll /mingw64/bin/libsharpyuv-*.dll /mingw64/bin/libgraphite2.dll /mingw64/bin/libdatrie-*.dll /mingw64/bin/libbrotlicommon.dll  /c/Color-Screen-install/bin
    - uses: actions/upload-artifact@v4
      with:
        name: windows-binary
        path: c:\Color-Screen-install\
    - name: digital coloring GUI
      shell: msys2 {0}
      run: git clone https://gitlab.mff.cuni.cz/kimroval/Color-Screen-GUI.git
    - name: Set properties
      shell: msys2 {0}
      run: cp .github/workflows/digital-coloring-github-windows10.properties Color-Screen-GUI/src/main/resources/maven-config-properties/user.properties
    - name: show gcc path
      shell: msys2 {0}
      run: cygpath -w /mingw64/bin/gcc.exe
    - name: Run maven build
      shell: pwsh
      run: |
        cd Color-Screen-GUI
        mvn  clean package
    - name: Create output directory
      shell: msys2 {0}
      run: mkdir /c/Color-Screen-GUI
    - name: Copy to directory
      shell: msys2 {0}
      run: cp Color-Screen-GUI/target/*.jar Color-Screen-GUI/target/*.dll /c/Color-Screen-GUI
    - name: copy dlls
      shell: msys2 {0}
      run: cp /mingw64/bin/libgcc_s_seh*.dll /mingw64/bin/libgomp*.dll /mingw64/bin/libgsl*.dll /mingw64/bin/liblcms2*.dll /mingw64/bin/libwinpthread*.dll /mingw64/bin/libraw*.dll /mingw64/bin/libstdc++*.dll /mingw64/bin/libtiff*.dll /mingw64/bin/libturbojpeg.dll /mingw64/bin/libzip.dll /mingw64/bin/libgslcblas*.dll /mingw64/bin/libjpeg*.dll /mingw64/bin/libdeflate.dll /mingw64/bin/libjbig*.dll /mingw64/bin/libLerc.dll /mingw64/bin/liblzma*.dll /mingw64/bin/libwebp*.dll /mingw64/bin/zlib1.dll /mingw64/bin/libzstd.dll /mingw64/bin/libbz2*.dll /mingw64/bin/libsharpyuv*.dll /c/Color-Screen-GUI
    - uses: actions/upload-artifact@v4
      with:
        name: windows-GUI-binary
        path: c:\Color-Screen-GUI\
